# Termoparotto Application Setup Documentation
**Date**: June 21, 2025  
**Server**: termoparotto.micro-cloud.it  
**Environment**: Production

## Overview

The termoparotto application is a full-stack web application consisting of:
- **Frontend**: React/Vite application served by Apache
- **Backend**: Node.js/Express API server with TypeScript
- **Database**: MongoDB
- **Web Server**: Apache2 with proxy configuration

## Application Architecture

### Directory Structure
```
/var/www/
├── docs/                          # Documentation (this file)
├── storage-app-client/            # React frontend
│   └── dist/                      # Built frontend files
│       ├── index.html
│       ├── assets/
│       └── locales/
└── storage-app-server/            # Node.js backend
    ├── src/
    │   ├── api/                   # API routes
    │   ├── config/                # Configuration files
    │   ├── middleware/            # Express middleware
    │   ├── collections/           # MongoDB schemas
    │   └── app.ts                 # Main server file
    ├── dist/                      # Compiled TypeScript
    ├── package.json
    ├── .env                       # Environment variables
    └── .env.remote               # Production environment
```

## Apache Configuration

### Virtual Host Configuration
**File**: `/etc/apache2/sites-available/termoparotto.micro-cloud.it.conf`

```apache
<VirtualHost *:80>
    ServerName termoparotto.micro-cloud.it
    ServerAlias www.termoparotto.micro-cloud.it
    ServerAdmin helpdesk@micro-web.it
    DocumentRoot /var/www/storage-app-client/dist

    <Directory /var/www/storage-app-client/dist>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        FallbackResource /index.html
    </Directory>

    ProxyPass /api http://localhost:1669/api
    ProxyPassReverse /api http://localhost:1669/api

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

### Enabled Apache Modules
- `proxy` - For API proxying
- `proxy_http` - HTTP proxy support
- `php8.1` - PHP support (if needed)
- `cors` - Cross-origin resource sharing
- `deflate` - Compression
- `mpm_prefork` - Multi-processing module

## Backend Server Configuration

### Environment Variables
**File**: `/var/www/storage-app-server/.env.remote`

```env
NODE_ENV=production
CLIENT_URL=http://termoparotto.micro-cloud.it:16788
PORT=1669
MONGO_URI=mongodb://localhost:27017/storage-app
JWT_SECRET=e9d7e6f8c3b2a1d0f5g4h7i6j9k8l1m2n3o4p5q6r7s8t9u0v1w2x3y4z5
```

### Package.json Scripts
```json
{
  "scripts": {
    "start": "NODE_ENV=production ts-node -r dotenv/config src/app.ts dotenv_config_path=.env.remote",
    "dev": "NODE_ENV=development ts-node -r dotenv/config src/app.ts",
    "build": "tsc",
    "lint": "eslint . --max-warnings 9999"
  }
}
```

### API Endpoints
The backend provides the following API routes:
- `/api/auth` - Authentication (login, register, verify)
- `/api/users` - User management
- `/api/clients` - Client management
- `/api/products` - Product management
- `/api/reports` - Report management
- `/api/worksites` - Worksite management

### Database Schema
**MongoDB Collections**:
- `users` - User accounts and authentication
- `clients` - Client information
- `products` - Product catalog
- `reports` - Work reports and activities
- `worksites` - Worksite management

## Frontend Configuration

### Build Output
- **Location**: `/var/www/storage-app-client/dist`
- **Framework**: React with Vite
- **Features**: Dashboard, user management, client management, product management, reports, worksites

### Main Entry Point
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APP STORAGE</title>
    <script type="module" crossorigin src="/assets/index-BZfsmhhx.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-fp41tLZC.css">
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
```

## Service Management

### Starting the Backend Server
```bash
cd /var/www/storage-app-server
npm start
```

### Apache Service
```bash
# Check status
sudo systemctl status apache2

# Restart if needed
sudo systemctl restart apache2
```

### MongoDB Service
```bash
# Check status
sudo systemctl status mongod

# MongoDB is running on localhost:27017
```

## Network Configuration

### Ports
- **80**: Apache HTTP server
- **1669**: Node.js API server (internal)
- **27017**: MongoDB (internal)
- **16788**: External access port for termoparotto.micro-cloud.it

### CORS Configuration
The backend allows requests from:
- `http://localhost:1671`
- `http://localhost:5173`
- `http://termoparotto.micro-cloud.it:16788`

## File Permissions

### Directory Ownership
```bash
# All /var/www directories owned by microweb user
sudo chown -R microweb:microweb /var/www
sudo chmod -R 755 /var/www
```

## Troubleshooting

### Common Issues

1. **503 Service Unavailable**
   - Check if Node.js server is running: `ps aux | grep node`
   - Start server: `cd /var/www/storage-app-server && npm start`

2. **Permission Denied**
   - Ensure proper ownership: `sudo chown -R microweb:microweb /var/www`

3. **Database Connection Issues**
   - Verify MongoDB is running: `sudo systemctl status mongod`
   - Check connection string in `.env.remote`

4. **Apache Configuration Issues**
   - Check syntax: `sudo apache2ctl configtest`
   - Restart Apache: `sudo systemctl restart apache2`

### Log Files
- **Apache Error Log**: `/var/log/apache2/error.log`
- **Apache Access Log**: `/var/log/apache2/access.log`
- **Application Logs**: Check console output when running `npm start`

## Deployment Notes

### Initial Setup Commands
```bash
# Copy server files
scp -r -P 16789 ./server/ microweb@termoparotto.micro-cloud.it:/var/www/storage-app-server/

# Copy environment file
scp -P 16789 ./server/.env.remote microweb@termoparotto.micro-cloud.it:/var/www/storage-app-server/.env

# Set permissions
sudo chown -R microweb:microweb /var/www
sudo chmod -R 755 /var/www

# Start server
cd /var/www/storage-app-server && npm start
```

### Production Considerations
- The application runs in production mode (`NODE_ENV=production`)
- JWT tokens expire after 1 hour for regular auth, 24 hours for extended sessions
- MongoDB runs locally for data persistence
- Apache handles SSL termination and static file serving
- API requests are proxied from Apache to the Node.js server

## Security Notes

- JWT secret is stored in environment variables
- CORS is configured to allow only specific origins
- Database runs locally without external access
- Apache proxy configuration isolates the API server
- File permissions are set to appropriate levels

---

**Last Updated**: June 21, 2025  
**Maintained By**: microweb  
**Contact**: helpdesk@micro-web.it
