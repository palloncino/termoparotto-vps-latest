import{a as Q,i as X,u as J,j as n,L as Z,k as I,s as ee,t as te}from"./index-BUyh9A9T.js";import{r as p}from"./vendor-8AKiDlQN.js";import{a as se}from"./clientService-qRF0PNhS.js";import{a as ie}from"./productsService-BwLSiUTT.js";import{c as re,u as ae}from"./reportService-CsvEZGDr.js";import{a as oe}from"./usersService--1COgLA-.js";import{a as ne}from"./worksiteService-DblhuvHv.js";import{c as K,u as V}from"./router-BmsaeIqg.js";import{T as z}from"./Tooltip-D_nYd3Sl.js";import{R as le,A as ce,P as de}from"./ReportHeader-BzV5VxoU.js";import"./api-BqC8VQ1e.js";import"./ReportDetails-CjcsXkSV.js";import"./formatDate-BAMmqpAD.js";const _e=()=>{const{user:i}=Q(),{showFlashMessage:g}=X(),{id:b}=K(),f=V(),{t:_}=J(),[w,h]=p.useState({header:{date:new Date().toISOString().split("T")[0],author_id:(i==null?void 0:i._id)||"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(i==null?void 0:i._id)||"",tasks:[{assigned_technician_ids:i!=null&&i._id?[i._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]}]}),[N,C]=p.useState([]),[D,R]=p.useState([]),[S,q]=p.useState([]),[P,E]=p.useState([]),[F,A]=p.useState(!0),[O,T]=p.useState(!1);p.useEffect(()=>{(async()=>{A(!0);try{const[o,a,t,e]=await Promise.all([se(),ne(),ie(1,{searchText:"",type:""}),oe()]);C(o.clients),q(t.products),E(e.users);const s=a.map(l=>({...l,client_id:l.client_id||l.clientId||null}));R(s)}catch(o){const a=o instanceof Error?o.message:"An error occurred";g(a,"error")}finally{A(!1)}})()},[]),p.useEffect(()=>{(async()=>{var o;if(!b){g("error_report_id_missing","error"),f("/report-list");return}try{const a=await re(b),t={header:{date:a.date?new Date(a.date).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],author_id:((o=a.technician_id)==null?void 0:o._id)||a.technician_id||(i==null?void 0:i._id)||"",status:a.status||"DRAFT",lunch_location:a.lunch_location||""},activities:(a.activities||[]).map(e=>{var s,l,c;return{...e,_id:e._id||"hash_"+Math.random().toString(36).substr(2,9),client_id:e.client_id||"",worksite_id:e.worksite_id||"",completed:e.completed||!1,travel_time_hours:e.travel_time_hours||0,travel_time:e.travel_time||0,work_time:e.work_time||0,valid_travel_time:e.valid_travel_time==="rules"&&e.travel_time_rules_applied?"rules":"manual",travel_time_rules_applied:e.travel_time_rules_applied,intervention_type:{da_preventivo:((s=e.intervention_type)==null?void 0:s.da_preventivo)||!1,in_economia:((l=e.intervention_type)==null?void 0:l.in_economia)||!1,sopralluogo:((c=e.intervention_type)==null?void 0:c.sopralluogo)||!1},assigned_technician_id:e.assigned_technician_id||(i==null?void 0:i._id)||"",tasks:(e.tasks||[]).map(d=>{var u,m,v;return{...d,assigned_technician_ids:d.assigned_technician_ids||(i!=null&&i._id?[i._id]:[]),work_hours:d.work_hours||0,task_description:d.task_description||"",intervention_type:{da_preventivo:((u=d.intervention_type)==null?void 0:u.da_preventivo)||!1,in_economia:((m=d.intervention_type)==null?void 0:m.in_economia)||!1,sopralluogo:((v=d.intervention_type)==null?void 0:v.sopralluogo)||!1},materials_used:d.materials_used||[],material_unloading:d.material_unloading||!1,material_unloading_hours:d.material_unloading_hours||0}})}})};h(t)}catch(a){const t=a instanceof Error?a.message:"An error occurred";g(t,"error"),f("/report-list")}})()},[b,i==null?void 0:i._id,f]),p.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(w))},[w]),p.useEffect(()=>{const r=localStorage.getItem("scrollY");r&&window.scrollTo(0,parseInt(r,10))},[]);const L=r=>{const{name:o,value:a}=r.target;h(t=>t.header?{...t,header:{...t.header,[o]:a}}:t)},$=(r,o,a)=>{const t=o.split("."),e={...r};let s=e;for(let c=0;c<t.length-1;c++){const d=t[c],u=d.match(/(\w+)\[(\d+)\]/);if(u){const m=u[1],v=parseInt(u[2],10);s[m]||(s[m]=[]),s[m]=[...s[m]],s[m][v]||(s[m][v]={}),s[m][v]={...s[m][v]},s=s[m][v]}else s[d]||(s[d]={}),s[d]={...s[d]},s=s[d]}const l=t[t.length-1];return s[l]=a,e},H=(r,o,a)=>{h(t=>{const e=t.activities?[...t.activities]:[],s=e[r],l=$(s,o,a);return e[r]=l,{...t,activities:e}})},U=()=>{h(r=>{const o={_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(i==null?void 0:i._id)||"",tasks:[{assigned_technician_ids:i!=null&&i._id?[i._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]};return{...r,activities:[...r.activities||[],o]}})},M=r=>{h(o=>{var t;const a=(t=o.activities)==null?void 0:t.filter((e,s)=>s!==r);return{...o,activities:a}})},W=r=>{h(o=>{const a=o.activities?[...o.activities]:[],t=a[r],e={assigned_technician_ids:i!=null&&i._id?[i._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0};return t.tasks=[...t.tasks,e],a[r]=t,{...o,activities:a}})},k=(r,o)=>{h(a=>{const t=a.activities?[...a.activities]:[],e=t[r];return e.tasks=e.tasks.filter((s,l)=>l!==o),t[r]=e,{...a,activities:t}})},x=(r,o)=>{h(a=>{const t=a.activities?[...a.activities]:[],e=t[r],s=e.tasks[o],l={product_id:"",quantity:0,unit_price:0};return s.materials_used=[...s.materials_used,l],e.tasks[o]=s,t[r]=e,{...a,activities:t}})},y=(r,o,a)=>{h(t=>{const e=t.activities?[...t.activities]:[],s={...e[r]},l={...s.tasks[o]};return l.materials_used=l.materials_used.filter((c,d)=>d!==a),s.tasks[o]=l,e[r]=s,{...t,activities:e}})},j=async r=>{var e,s,l;if(r.preventDefault(),!b){g(_("error_report_id_missing"),"error");return}const o=Y();if(Object.keys(o).length>0){const c=Object.values(o),u=c.slice(0,3).join(", "),m=c.length>3?` e altri ${c.length-3} errori`:"";g(`Errore di validazione: ${u}${m}`,"error");return}if(!B()&&!window.confirm(_("proceed_without_material_message")))return;const t={...w,activities:(w.activities||[]).map(c=>({...c,tasks:c.tasks.map(d=>{const u={...d,materials_used:(d.materials_used||[]).filter(m=>m.product_id)};return u.intervention_status===""&&(u.intervention_status=void 0),u.payment_status===""&&(u.payment_status=void 0),u})}))};T(!0);try{const c=await ae(b,t);if(c&&c._id)g(_("report_updated_successfully"),"success"),f(`/reports/${c._id}?action=report_updated_successfully`);else throw new Error("Updated report ID not found")}catch(c){if(console.error("Error updating report:",c),((e=c.response)==null?void 0:e.status)===400&&((l=(s=c.response)==null?void 0:s.data)==null?void 0:l.error)==="Validation Error"){const d=c.response.data.details,u=Object.values(d),v=u.slice(0,3).join(", "),G=u.length>3?` e altri ${u.length-3} errori`:"";g(`Errore di validazione server: ${v}${G}`,"error")}else g(_("error_updating_report"),"error")}finally{T(!1)}},B=()=>{var r;return((r=w.activities)==null?void 0:r.some(o=>{var a;return(a=o.tasks)==null?void 0:a.some(t=>{var e;return(e=t.materials_used)==null?void 0:e.some(s=>s.product_id&&s.quantity>=1)})}))||!1},Y=()=>{const r={},{header:o,activities:a}=w;if(o){if(!(a!=null&&a.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return o.date||(r["header.date"]=_("date_required")),o.author_id||(r["header.author_id"]=_("author_required")),o.status||(r["header.status"]=_("status_required")),o.lunch_location||(r["header.lunch_location"]=_("lunch_location_required")),a.forEach((t,e)=>{if(t.client_id||(r[`activities[${e}].client_id`]=_("client_required")),t.worksite_id||(r[`activities[${e}].worksite_id`]=_("worksite_required")),t.valid_travel_time==="manual")(!t.travel_time_hours||t.travel_time_hours<=0)&&(r[`activities[${e}].travel_time_hours`]=_("invalid_travel_time_hours"));else if(t.valid_travel_time==="rules")if(!t.travel_time_rules_applied)r[`activities[${e}].travel_time_rules_applied`]=_("travel_time_rules_required");else{const{distance_km:s,travel_time_hours:l}=t.travel_time_rules_applied;(s<=0||l<=0)&&(r[`activities[${e}].travel_time_rules_applied`]=_("invalid_travel_time_rules"))}t.tasks.forEach((s,l)=>{(!s.task_description||s.task_description.trim()==="")&&(r[`activities[${e}].tasks[${l}].task_description`]=_("task_description_required")),s.work_hours<=0&&(r[`activities[${e}].tasks[${l}].work_hours`]=_("invalid_work_hours")),!s.intervention_type.da_preventivo&&!s.intervention_type.in_economia&&!s.intervention_type.sopralluogo&&(r[`activities[${e}].tasks[${l}].intervention_type`]=_("intervention_type_required")),s.materials_used.forEach((c,d)=>{c.product_id&&c.quantity<1&&(r[`activities[${e}].tasks[${l}].materials_used[${d}].quantity`]=_("invalid_material_quantity"))})})}),r};return{formData:w,clients:N,worksites:D,products:S,users:P,isLoading:F,isSaving:O,handleHeaderChange:L,handleActivityChange:H,handleSubmit:j,appendActivity:U,removeActivity:M,appendTask:W,removeTask:k,appendMaterial:x,removeMaterial:y,validateForm:Y,checkIfHasMaterials:B}},Ne=()=>{var M;const{t:i}=J(),{id:g}=K(),b=V(),{formData:f,clients:_,worksites:w,products:h,users:N,isLoading:C,isSaving:D,handleHeaderChange:R,handleActivityChange:S,handleSubmit:q,appendActivity:P,removeActivity:E,appendTask:F,removeTask:A,appendMaterial:O,removeMaterial:T}=_e(),[L,$]=p.useState(!1),H=p.useRef([]),U=()=>{$(!0)};return C?n.jsxs("div",{className:"max-w-7xl mx-auto",children:[n.jsx("div",{className:"flex justify-between items-center mb-6",children:n.jsx("h1",{className:"text-3xl font-bold",children:i("edit_report")})}),n.jsx(Z,{})]}):n.jsxs("div",{className:"max-w-7xl mx-auto",children:[n.jsxs("div",{className:"flex justify-between items-center mb-6",children:[n.jsx("h1",{className:"text-3xl font-bold",children:i("edit_report")}),n.jsx("div",{className:"flex space-x-2",children:n.jsx("button",{onClick:()=>b("/report-list"),className:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors",children:i("back_to_list")})})]}),n.jsxs("form",{onSubmit:q,className:"space-y-8",children:[n.jsxs("section",{className:"bg-white rounded-lg shadow-md p-6",children:[n.jsx("h2",{className:"text-xl font-semibold mb-4",children:i("report_header")}),n.jsx(le,{formData:f.header||{date:new Date().toISOString().split("T")[0],author_id:"",status:"DRAFT",lunch_location:""},users:N,handleChange:R})]}),n.jsxs("section",{className:"bg-white rounded-lg shadow-md p-6",children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsx("h2",{className:"text-xl font-semibold",children:i("activities")}),n.jsxs("div",{className:"flex space-x-2",children:[n.jsx(z,{content:i("preview_report_tooltip"),children:n.jsxs("button",{type:"button",onClick:U,className:"flex items-center bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",children:[n.jsx(I,{className:"mr-2"}),i("preview")]})}),n.jsx(z,{content:i("add_activity_tooltip"),children:n.jsxs("button",{type:"button",onClick:P,className:"flex items-center bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded",children:[n.jsx(ee,{className:"mr-2"}),i("add_activity")]})})]})]}),n.jsx("div",{className:"space-y-6",children:(M=f.activities)==null?void 0:M.map((W,k)=>n.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",ref:x=>H.current[k]=x,children:[n.jsxs("div",{className:"flex justify-between items-center mb-4",children:[n.jsxs("h3",{className:"text-lg font-semibold",children:[i("activity")," ",k+1]}),f.activities&&f.activities.length>1&&n.jsx("button",{type:"button",onClick:()=>E(k),className:"text-red-500 hover:text-red-700 text-sm",children:i("remove_activity")})]}),n.jsx(ce,{activity:W,index:k,clients:_,worksites:w,products:h,users:N,handleActivityChange:(x,y,j)=>{S(x,y,j)},removeActivity:E,appendTask:(x,y)=>{x.preventDefault(),F(y)},removeTask:A,appendMaterial:(x,y,j)=>{x.preventDefault(),O(y,j)},removeMaterial:T})]},k))})]}),n.jsx("section",{className:"w-full flex justify-end gap-4",children:n.jsx(z,{content:i("update_report_tooltip"),children:n.jsxs("button",{type:"submit",disabled:D,className:"flex items-center bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed",children:[n.jsx(te,{className:"mr-2"}),i(D?"updating":"update_report")]})})}),L&&n.jsx(de,{report:f,onClose:()=>$(!1)})]})]})};export{Ne as default};
