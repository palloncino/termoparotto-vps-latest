import{i as Z,k as V,u as J,j as e,v as G,V as H,l as Q,W as z,X as ee,Y as se,z as O,p as te,x as ae,y as re,Z as ie,e as le,C as X,B as ne,E as ce,$ as de}from"./index-BT8qgM4o.js";import{r as N}from"./vendor-8AKiDlQN.js";import{g as oe}from"./clientService-sudZ8bLR.js";import{g as me}from"./productsService-B7aw_y5K.js";import{c as xe,a as ue}from"./reportService-B371uuyd.js";import{g as he}from"./usersService-CqhLcM0Y.js";import{g as ge}from"./worksiteService-BcbmFES_.js";import{u as _e,a as pe}from"./router-BmsaeIqg.js";import{f as fe,a as Y}from"./formatDate-Dk0xWO1M.js";const be=()=>{const{user:l}=Z(),{showFlashMessage:s}=V(),[u,x]=N.useState({header:{date:new Date().toISOString().split("T")[0],author_id:(l==null?void 0:l._id)||"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[{assigned_technician_ids:l!=null&&l._id?[l._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]}]}),[b,F]=N.useState([]),[D,C]=N.useState([]),[f,v]=N.useState([]),[R,L]=N.useState([]),[M,A]=N.useState(!0),{t:i}=J(),j=_e();N.useEffect(()=>{(async()=>{A(!0);try{const[c,d,r,n]=await Promise.all([oe(),ge(),me(1,{searchText:"",type:""}),he()]);F(c.clients),v(r.products),L(n.users);const a=d.map(o=>({...o,client_id:o.client_id||o.clientId||null}));C(a)}catch(c){const d=c instanceof Error?c.message:"An error occurred";s(d,"error")}finally{A(!1)}})()},[]),N.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(u))},[u]),N.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const w=t=>{const{name:c,value:d}=t.target;x(r=>r.header?{...r,header:{...r.header,[c]:d}}:r)},y=(t,c,d)=>{const r=c.split("."),n={...t};let a=n;for(let m=0;m<r.length-1;m++){const h=r[m],_=h.match(/(\w+)\[(\d+)\]/);if(_){const p=_[1],k=parseInt(_[2],10);a[p]||(a[p]=[]),a[p]=[...a[p]],a[p][k]||(a[p][k]={}),a[p][k]={...a[p][k]},a=a[p][k]}else a[h]||(a[h]={}),a[h]={...a[h]},a=a[h]}const o=r[r.length-1];return a[o]=d,n},q=(t,c,d)=>{x(r=>{const n=r.activities?[...r.activities]:[],a=n[t],o=y(a,c,d);return n[t]=o,{...r,activities:n}})},P=()=>{x(t=>({...t,activities:[...t.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[]}]}))},B=t=>{x(c=>{var d;return{...c,activities:(d=c.activities)==null?void 0:d.filter((r,n)=>n!==t)}})},g=t=>{x(c=>{const d=c.activities?[...c.activities]:[],r={...d[t]};return r.tasks=[...r.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}],d[t]=r,{...c,activities:d}})},$=(t,c)=>{x(d=>{const r=d.activities?[...d.activities]:[],n={...r[t]};return n.tasks=n.tasks.filter((a,o)=>o!==c),r[t]=n,{...d,activities:r}})},T=(t,c)=>{x(d=>{const r=d.activities?[...d.activities]:[],n={...r[t]},a={...n.tasks[c]},o=a.materials_used||[],m=o[o.length-1];return!m||m.product_id&&m.product_id.trim()!==""?a.materials_used=[...o,{product_id:"",quantity:1}]:a.materials_used=[...o],n.tasks[c]=a,r[t]=n,{...d,activities:r}})},W=(t,c,d)=>{x(r=>{const n=r.activities?[...r.activities]:[],a={...n[t]},o={...a.tasks[c]};return o.materials_used=o.materials_used.filter((m,h)=>h!==d),a.tasks[c]=o,n[t]=a,{...r,activities:n}})},E=async t=>{var n,a,o;t.preventDefault();const c=S();if(Object.keys(c).length>0){const m=Object.values(c),_=m.slice(0,3).join(", "),p=m.length>3?` e altri ${m.length-3} errori`:"";s(`Errore di validazione: ${_}${p}`,"error");return}if(!I()&&!window.confirm(i("proceed_without_material_message")))return;const r={...u,activities:(u.activities||[]).map(m=>({...m,tasks:m.tasks.map(h=>{const _={...h,materials_used:(h.materials_used||[]).filter(p=>p.product_id)};return _.intervention_status===""&&(_.intervention_status=void 0),_.payment_status===""&&(_.payment_status=void 0),_})}))};try{const m=await xe(r);if(m&&m._id)s(i("report_created_successfully"),"success"),j(`/reports/${m._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(m){if(console.error("Error creating report:",m),((n=m.response)==null?void 0:n.status)===400&&((o=(a=m.response)==null?void 0:a.data)==null?void 0:o.error)==="Validation Error"){const h=m.response.data.details,_=Object.values(h),k=_.slice(0,3).join(", "),K=_.length>3?` e altri ${_.length-3} errori`:"";s(`Errore di validazione server: ${k}${K}`,"error")}else s(i("error_creating_report"),"error")}},I=()=>{var t;return((t=u.activities)==null?void 0:t.some(c=>{var d;return(d=c.tasks)==null?void 0:d.some(r=>{var n;return(n=r.materials_used)==null?void 0:n.some(a=>a.product_id&&a.quantity>=1)})}))||!1},S=()=>{const t={},{header:c,activities:d}=u;if(c){if(!(d!=null&&d.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return c.date||(t["header.date"]=i("date_required")),c.author_id||(t["header.author_id"]=i("author_required")),c.status||(t["header.status"]=i("status_required")),c.lunch_location||(t["header.lunch_location"]=i("lunch_location_required")),d.forEach((r,n)=>{if(r.client_id||(t[`activities[${n}].client_id`]=i("client_required")),r.worksite_id||(t[`activities[${n}].worksite_id`]=i("worksite_required")),r.valid_travel_time==="manual")(!r.travel_time_hours||r.travel_time_hours<=0)&&(t[`activities[${n}].travel_time_hours`]=i("invalid_travel_time_hours"));else if(r.valid_travel_time==="rules")if(!r.travel_time_rules_applied)t[`activities[${n}].travel_time_rules_applied`]=i("travel_time_rules_required");else{const{distance_km:a,travel_time_hours:o}=r.travel_time_rules_applied;(a<=0||o<=0)&&(t[`activities[${n}].travel_time_rules_applied`]=i("invalid_travel_time_rules"))}r.tasks.forEach((a,o)=>{(!a.task_description||a.task_description.trim()==="")&&(t[`activities[${n}].tasks[${o}].task_description`]=i("task_description_required")),a.work_hours<=0&&(t[`activities[${n}].tasks[${o}].work_hours`]=i("invalid_work_hours")),!a.intervention_type.da_preventivo&&!a.intervention_type.in_economia&&!a.intervention_type.sopralluogo&&(t[`activities[${n}].tasks[${o}].intervention_type`]=i("intervention_type_required")),a.materials_used.forEach((m,h)=>{m.product_id&&m.quantity<1&&(t[`activities[${n}].tasks[${o}].materials_used[${h}].quantity`]=i("invalid_material_quantity"))})})}),t};return{formData:u,clients:b,worksites:D,products:f,users:R,isLoading:M,handleHeaderChange:w,handleActivityChange:q,handleSubmit:E,appendActivity:P,removeActivity:B,appendTask:g,removeTask:$,appendMaterial:T,removeMaterial:W,validateForm:S,checkIfHasMaterials:I}};function U(l,s){const u=Math.floor(l),x=Math.round((l-u)*60);let b="";return u>0&&(b+=`${u} ${s(u===1?"hour":"hours")}`),x>0&&(b&&(b+=" "),b+=`${x} ${s(x===1?"minute":"minutes")}`),b||(b=s("no_time")),b}const ve=()=>{const{clients:l,worksites:s,products:u,users:x}=be();return{getClientById:f=>l.find(v=>v._id===f),getWorksiteById:f=>s.find(v=>v._id===f),getProductById:f=>u.find(v=>v._id===f),getUserById:f=>x.find(v=>v._id===f)}},Ce=({report:l})=>{const{t:s}=J(),u=pe(),{showFlashMessage:x}=V(),{getClientById:b,getWorksiteById:F,getProductById:D,getUserById:C}=ve(),[f,v]=N.useState(!1);N.useEffect(()=>{new URLSearchParams(u.search).get("action")==="report_created_successfully"&&x(s("report_created_successfully"),"success")},[u,x,s]);const R=async()=>{v(!0);try{const i=await ue({reportId:l._id}),j=new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),w=URL.createObjectURL(j),y=document.createElement("a");y.href=w,y.setAttribute("download",`report-${l._id}.xlsx`),document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(w),x(s("report_exported_successfully"),"success")}catch(i){console.error("Error exporting report:",i),x(s("error_exporting_xlsx"),"error")}finally{v(!1)}},L=i=>i.completed?e.jsx(ce,{className:"text-green-500 text-2xl"}):e.jsx(de,{className:"text-yellow-500 text-2xl"}),M=typeof l.technician_id=="object"&&l.technician_id!==null?l.technician_id.name:"",A=l.activities||[];return e.jsxs("div",{className:"max-w-7xl mx-auto bg-gray-50 min-h-screen",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg",children:e.jsx(G,{className:"text-3xl text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:s("report_details")}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2 text-gray-600",children:[e.jsx(H,{className:"text-lg"}),e.jsx("p",{className:"text-lg",children:l.date?fe(l.date,s):""})]})]})]}),e.jsxs("button",{onClick:R,disabled:f,className:`inline-flex items-center space-x-2 px-6 py-3 rounded-lg font-semibold transition-colors ${f?"bg-gray-400 cursor-not-allowed text-white":"bg-blue-600 text-white hover:bg-blue-700 shadow-sm"}`,children:[e.jsx(Q,{className:"text-lg"}),e.jsx("span",{children:s(f?"exporting":"export_xlsx")})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(z,{className:"text-xl text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("technician")})]}),M?e.jsx("a",{href:`/users/${typeof l.technician_id=="object"?l.technician_id._id:l.technician_id}`,className:"text-blue-600 hover:text-blue-800 font-medium text-lg transition-colors",children:M}):e.jsx("p",{className:"text-gray-500 text-lg",children:s("not_assigned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"bg-emerald-100 p-2 rounded-lg",children:e.jsx(ee,{className:"text-xl text-emerald-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("status")})]}),e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800",children:l.status?s(l.status):s("not_specified")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"bg-orange-100 p-2 rounded-lg",children:e.jsx(se,{className:"text-xl text-orange-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("lunch_location")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.lunch_location||s("not_specified")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(H,{className:"text-xl text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("created")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.created?(()=>{const{text:i,isToday:j}=Y(l.created?String(l.created):"",s);return j?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:i}):i})():s("not_specified")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(O,{className:"text-xl text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("last_updated")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.last_updated?(()=>{const{text:i,isToday:j}=Y(l.last_updated?String(l.last_updated):"",s);return j?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:i}):i})():s("not_specified")})]})]})]}),e.jsx("div",{className:"px-6 pb-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(te,{className:"text-2xl text-blue-600"})}),e.jsx("h3",{className:"text-2xl font-bold text-gray-800",children:s("activities")})]})}),e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"space-y-8",children:A.map((i,j)=>{var B;const w=b(i.client_id),y=F(i.worksite_id),q=C(i.assigned_technician_id),P=((B=i.tasks)==null?void 0:B.reduce((g,$)=>g+($.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-blue-600 text-white rounded-lg w-10 h-10 flex items-center justify-center font-bold text-lg",children:j+1}),e.jsxs("h4",{className:"text-xl font-bold text-gray-800",children:[s("activity")," ",j+1]})]}),L(i)]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ae,{className:"text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700 text-sm",children:s("client")})]}),e.jsx("a",{href:`/clients/${i.client_id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:w?w.name:s("unknown_client")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(re,{className:"text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700 text-sm",children:s("worksite")})]}),e.jsx("a",{href:`/worksites/${i.worksite_id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:y?y.name:s("unknown_worksite")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(O,{className:"text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700 text-sm",children:s("work_time")})]}),e.jsx("p",{className:"text-gray-800 font-medium",children:U(P,s)})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ie,{className:"text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700 text-sm",children:s("travel_time")})]}),e.jsx("p",{className:"text-gray-800 font-medium",children:U(i.travel_time_hours||0,s)})]})]}),q&&e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(z,{className:"text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("assigned_technician")})]}),e.jsx("a",{href:`/users/${i.assigned_technician_id}`,className:"text-blue-600 hover:text-blue-800 font-medium",children:q.name})]}),i.tasks&&i.tasks.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(le,{className:"text-xl text-blue-500"}),e.jsx("h5",{className:"text-lg font-semibold text-gray-700",children:s("tasks")})]}),i.tasks.map((g,$)=>e.jsxs("div",{className:"bg-white rounded-lg p-4 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-blue-600 text-white rounded-lg w-8 h-8 flex items-center justify-center font-bold text-sm",children:$+1}),e.jsx("h6",{className:"text-lg font-semibold text-gray-800",children:g.task_description||s("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{className:"text-blue-500"}),e.jsxs("span",{className:"font-medium text-blue-800",children:[s("work_hours"),": ",U(g.work_hours||0,s)]})]})}),g.material_unloading&&e.jsx("div",{className:"bg-orange-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"text-orange-500"}),e.jsxs("span",{className:"font-medium text-orange-800",children:[s("material_unloading","Material Unloading"),": ",U(g.material_unloading_hours||0,s)]})]})}),g.intervention_type&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ne,{className:"text-gray-500"}),e.jsx("span",{className:"font-medium text-gray-700 text-sm",children:s("intervention_type")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[g.intervention_type.da_preventivo&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full border border-blue-300",children:s("da_preventivo")}),g.intervention_type.in_economia&&e.jsx("span",{className:"bg-emerald-100 text-emerald-800 text-xs font-semibold px-2 py-1 rounded-full border border-emerald-300",children:s("in_economia")}),g.intervention_type.sopralluogo&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full border border-blue-300",children:s("sopralluogo")})]})]})]}),g.materials_used&&g.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(X,{className:"text-emerald-500"}),e.jsx("h6",{className:"font-semibold text-gray-700",children:s("materials_used")})]}),e.jsx("div",{className:"bg-emerald-50 rounded-lg p-4 border border-emerald-200",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-emerald-200",children:[e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-sm font-bold text-emerald-800",children:s("quantity")})]})}),e.jsx("tbody",{children:g.materials_used.map((T,W)=>{const E=D(T.product_id);return e.jsx("tr",{className:"border-b border-emerald-200 hover:bg-emerald-100",children:E?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-2 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${E._id}`,children:E.data_documento})}),e.jsx("td",{className:"py-2 text-gray-700",children:E.descrizione}),e.jsx("td",{className:"py-2 text-right text-gray-600 font-semibold",children:T.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-2 text-red-600 text-center",children:s("unknown_product")})},W)})})]})})]})]},$))]})]},j)})})})]})})]})};export{Ce as R,U as f,be as u};
