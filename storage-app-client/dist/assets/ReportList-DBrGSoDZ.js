import{u as O,j as e,k as Z,l as ee,m as te,n as se,a as ae,o as re}from"./index-DSTbHML1.js";import{r as c,b as ne}from"./vendor-8AKiDlQN.js";import{a as M}from"./clientService-qRF0PNhS.js";import{d as ie,a as B,b as le}from"./reportService-CsvEZGDr.js";import{a as W}from"./usersService--1COgLA-.js";import{a as P}from"./worksiteService-DblhuvHv.js";import{f as oe,a as I}from"./formatDate-BAMmqpAD.js";import{T}from"./Tooltip-HWMgabdM.js";import{u as z}from"./router-BmsaeIqg.js";import"./api-BqC8VQ1e.js";const ce=({reports:n,onReportDeleted:F})=>{const{t:i}=O(),k=z(),[R,S]=c.useState([]),[x,u]=c.useState([]),[$,y]=c.useState([]),[N,g]=c.useState(new Set);c.useEffect(()=>{(async()=>{try{const[l,j,m]=await Promise.all([W(),M(),P()]);S(l.users),u(j.clients),y(m)}catch(l){console.error("Error fetching filter data:",l)}})()},[]);const C=async r=>{if(window.confirm(i("confirm_delete")))try{await ie(r),F()}catch(l){console.error("Error deleting report:",l)}},h=async r=>{g(l=>new Set(l).add(r));try{const l=await B({reportId:r}),j=new Blob([l],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=URL.createObjectURL(j),w=document.createElement("a");w.href=m,w.setAttribute("download",`report-${r}.xlsx`),document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(m)}catch(l){console.error("Error exporting report:",l),alert(i("error_exporting_xlsx"))}finally{g(l=>{const j=new Set(l);return j.delete(r),j})}};return e.jsx("div",{children:n.length===0?e.jsx("p",{children:i("no_reports_found")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("date")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("created")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("last_updated")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("technician")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("activities")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("total_hours")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("status")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:i("actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:n.map(r=>{var w,_;const l=typeof r.technician_id=="object"&&r.technician_id!==null?r.technician_id.name:i("not_assigned"),j=((w=r.activities)==null?void 0:w.reduce((f,b)=>{var s;const E=((s=b.tasks)==null?void 0:s.reduce((U,D)=>U+(D.work_hours||0),0))||0;return f+E},0))||0,m=((_=r.activities)==null?void 0:_.length)||0;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:r.date?oe(r.date,i):""}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:r.created?(()=>{const{text:f,isToday:b}=I(r.created,i);return b?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:f}):f})():i("not_specified")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:r.last_updated?(()=>{const{text:f,isToday:b}=I(r.last_updated,i);return b?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:f}):f})():i("not_specified")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:l}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[m," ",i(m===1?"activity":"activities")]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.jsxs("span",{className:"font-medium",children:[j.toFixed(1)," ",i("hours")]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.status==="completed"?"bg-green-100 text-green-800":r.status==="in_progress"?"bg-yellow-100 text-yellow-800":r.status==="planned"?"bg-blue-100 text-blue-800":r.status==="SIMULATION_TEST"?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:i(r.status)||i("not_specified")})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(T,{content:i("view_report"),children:e.jsx("button",{onClick:()=>k(`/reports/${r._id}`),className:"text-blue-500 hover:text-blue-700",children:e.jsx(Z,{className:"h-4 w-4"})})}),e.jsx(T,{content:i("edit_report"),children:e.jsx("button",{onClick:()=>k(`/reports/${r._id}/edit`),className:"text-green-500 hover:text-green-700",children:e.jsx(ee,{className:"h-4 w-4"})})}),e.jsx(T,{content:i("delete_report"),children:e.jsx("button",{onClick:()=>C(r._id),className:"text-red-500 hover:text-red-700",children:e.jsx(te,{className:"h-4 w-4"})})}),e.jsx(T,{content:i("export_report"),children:e.jsx("button",{onClick:()=>h(r._id),className:"text-purple-500 hover:text-purple-700",disabled:N.has(r._id),children:N.has(r._id)?e.jsxs("svg",{className:"animate-spin h-4 w-4 text-purple-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx(se,{className:"h-4 w-4"})})})]})})]},r._id)})})]})})})},de=({technicians:n,clients:F,worksites:i,onFiltersChange:k,onExportMonthlyUsers:R,onExportLabor:S})=>{var f,b,E;const{t:x}=O(),[u,$]=c.useState(""),[y,N]=c.useState(""),[g,C]=c.useState(""),[h,r]=c.useState(""),[l,j]=c.useState(""),[m,w]=c.useState(""),_=()=>{k&&k({month:u||void 0,technician:y||void 0,client:g||void 0,worksite:h||void 0})};return ne.useEffect(()=>{_()},[u,y,g,h]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{htmlFor:"month-filter",className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("month")}),e.jsx("input",{id:"month-filter",type:"month",value:u,onChange:s=>$(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full"})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{htmlFor:"technician-filter",className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("technician")}),e.jsxs("select",{id:"technician-filter",value:y,onChange:s=>N(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),n.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{htmlFor:"client-filter",className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("client")}),e.jsxs("select",{id:"client-filter",value:g,onChange:s=>C(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),F.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{htmlFor:"worksite-filter",className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("worksite")}),e.jsxs("select",{id:"worksite-filter",value:h,onChange:s=>r(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),i.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 mt-3 pt-3 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsxs("label",{htmlFor:"month-export",className:"block text-xs font-medium text-gray-600 mb-0.5",children:[x("month")," *"]}),e.jsx("input",{id:"month-export",type:"month",value:u,onChange:s=>$(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full"})]}),e.jsx("button",{onClick:()=>R==null?void 0:R(u,y||void 0),disabled:!u,className:`px-3 py-1 text-xs rounded-md font-medium transition-colors ${u?"bg-green-600 text-white hover:bg-green-700 focus:ring-2 focus:ring-green-500":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:x("export_monthly_users")})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsxs("label",{htmlFor:"start-date",className:"block text-xs font-medium text-gray-600 mb-0.5",children:[x("start_date")," *"]}),e.jsx("input",{id:"start-date",type:"date",value:l,onChange:s=>j(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full"})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsxs("label",{htmlFor:"end-date",className:"block text-xs font-medium text-gray-600 mb-0.5",children:[x("end_date")," *"]}),e.jsx("input",{id:"end-date",type:"date",value:m,onChange:s=>w(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full"})]}),e.jsx("button",{onClick:()=>S==null?void 0:S(l,m,g||void 0,h||void 0),disabled:!l||!m,className:`px-3 py-1 text-xs rounded-md font-medium transition-colors ${l&&m?"bg-purple-600 text-white hover:bg-purple-700 focus:ring-2 focus:ring-purple-500":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,children:x("export_labor")})]})]}),(u||y||g||h)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:[x("active_filters"),":"]}),u&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("month"),": ",u]}),y&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("technician"),":"," ",(f=n.find(s=>s._id===y))==null?void 0:f.name]}),g&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("client"),": ",(b=F.find(s=>s._id===g))==null?void 0:b.name]}),h&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("worksite"),": ",(E=i.find(s=>s._id===h))==null?void 0:E.name]})]})]})},we=()=>{const{t:n}=O(),F=z(),[i,k]=c.useState([]),[R,S]=c.useState([]),[x,u]=c.useState(!0),[$,y]=c.useState(null),[N,g]=c.useState(!1),{user:C}=ae(),[h,r]=c.useState([]),[l,j]=c.useState([]),[m,w]=c.useState([]),[_,f]=c.useState(""),[b,E]=c.useState(""),[s,U]=c.useState({});c.useEffect(()=>{D(),H()},[]),c.useEffect(()=>{X()},[i,_,b]);const D=async()=>{u(!0);try{const t=await le();k(t),y(null)}catch(t){y(n("error_fetching_reports")),console.error(n("error_fetching_reports"),t)}finally{u(!1)}},H=async()=>{try{const[t,a,o]=await Promise.all([W(),M(),P()]);r(t.users),j(a.clients),w(o)}catch(t){console.error("Error fetching filter data:",t)}},X=()=>{let t=[...i];C&&C.role==="user"&&(t=t.filter(a=>a.technician_id&&(typeof a.technician_id=="object"?a.technician_id._id:a.technician_id)===C._id)),_&&(t=t.filter(a=>a.status===_)),b&&(t=t.filter(a=>(typeof a.technician_id=="object"?a.technician_id._id:a.technician_id)===b)),S(t)},G=()=>{D()},V=t=>{U(t)},q=t=>{const a=["reports"];if(t.month){const d=new Date(t.month+"-01").toLocaleDateString("en-US",{month:"long",year:"numeric"});a.push(d.replace(" ","-"))}if(t.technician){const d=h.find(p=>p._id===t.technician);d&&a.push(`tech-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}if(t.client){const d=l.find(p=>p._id===t.client);d&&a.push(`client-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}if(t.worksite){const d=m.find(p=>p._id===t.worksite);d&&a.push(`worksite-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}a.length===1&&a.push("all");const o=new Date().toISOString().split("T")[0];return`${a.join("-")}-${o}.xlsx`},J=async()=>{g(!0);try{const t=await B(s),a=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=URL.createObjectURL(a),d=document.createElement("a");d.href=o,d.setAttribute("download",q(s)),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(o)}catch(t){console.error("Error exporting reports:",t),alert(n("error_exporting_xlsx"))}finally{g(!1)}},K=async(t,a)=>{try{const o=await fetch(`/api/reports/export/monthly-users?month=${t}${a?`&technician=${a}`:""}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!o.ok)throw new Error("Failed to export monthly users data");const d=await o.blob(),p=URL.createObjectURL(d),v=document.createElement("a");v.href=p,v.setAttribute("download",`export-utenti-mensile-${t}.xlsx`),document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(p),showFlashMessage(n("monthly_users_exported_successfully"),"success")}catch(o){const d=o instanceof Error?o.message:"Error exporting monthly users data";showFlashMessage(d,"error")}},Q=async(t,a,o,d)=>{try{let p=`/api/reports/export/labor?startDate=${t}&endDate=${a}`;o&&(p+=`&client=${o}`),d&&(p+=`&worksite=${d}`);const v=await fetch(p,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!v.ok)throw new Error("Failed to export labor data");const Y=await v.blob(),A=URL.createObjectURL(Y),L=document.createElement("a");L.href=A,L.setAttribute("download",`export-manodopera-${t}-to-${a}.xlsx`),document.body.appendChild(L),L.click(),document.body.removeChild(L),URL.revokeObjectURL(A),showFlashMessage(n("labor_exported_successfully"),"success")}catch(p){const v=p instanceof Error?p.message:"Error exporting labor data";showFlashMessage(v,"error")}};return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:n("report_list")}),e.jsx("button",{onClick:()=>F("/report-create"),className:"bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors",children:n("create_report")})]}),e.jsx("section",{className:"mb-6",children:e.jsxs("div",{className:"bg-white border border-blue-200 rounded-lg px-4 py-3 shadow-sm flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end gap-2 md:gap-4 w-full",children:[e.jsx("div",{className:"flex flex-1 flex-wrap gap-2 items-end",children:e.jsx(de,{technicians:h,clients:l,worksites:m,onFiltersChange:V,onExportMonthlyUsers:K,onExportLabor:Q})}),e.jsx("div",{className:"flex-shrink-0 flex items-end",children:e.jsxs("button",{onClick:J,disabled:N,className:["inline-flex items-center gap-2 px-4 py-2 rounded-md font-semibold transition-colors border border-blue-600",N?"bg-blue-200 text-blue-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"].join(" "),children:[N&&e.jsxs("svg",{className:"animate-spin h-4 w-4 mr-1 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8z"})]}),e.jsx(re,{className:"text-lg"}),e.jsx("span",{children:n(N?"exporting":"export_reports")})]})})]}),e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 mt-1",children:e.jsx("div",{className:"text-xs text-blue-700 font-medium",children:(()=>{const t=[];if(s.month&&t.push(`${n("month")}: ${s.month}`),s.technician){const a=h.find(o=>o._id===s.technician);t.push(`${n("technician")}: ${(a==null?void 0:a.name)||s.technician}`)}if(s.client){const a=l.find(o=>o._id===s.client);t.push(`${n("client")}: ${(a==null?void 0:a.name)||s.client}`)}if(s.worksite){const a=m.find(o=>o._id===s.worksite);t.push(`${n("worksite")}: ${(a==null?void 0:a.name)||s.worksite}`)}return t.length>0?e.jsxs("span",{children:[n("export_will_include"),":"," ",t.map((a,o)=>e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 mx-1 text-xs font-semibold align-middle",children:a},o))]}):e.jsx("span",{className:"text-gray-500",children:n("export_all_reports_no_filters")})})()})})]})}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:n("filter_reports")}),e.jsx("button",{onClick:()=>{f(""),E("")},className:"text-sm text-gray-600 hover:text-gray-800 underline",children:n("clear_filters")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("status")}),e.jsxs("select",{value:_,onChange:t=>f(t.target.value),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:n("all")}),e.jsx("option",{value:"DRAFT",children:n("draft")}),e.jsx("option",{value:"FINITO",children:n("completed")}),e.jsx("option",{value:"IN_PROGRESS",children:n("in_progress")}),e.jsx("option",{value:"PLANNED",children:n("planned")}),e.jsx("option",{value:"SOSPESO",children:n("suspended")}),e.jsx("option",{value:"SIMULATION_TEST",children:n("simulation_test")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("technician")}),e.jsxs("select",{value:b,onChange:t=>E(t.target.value),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:n("all")}),h.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]})]})]}),x?e.jsx("p",{children:n("loading_reports")}):$?e.jsx("p",{className:"text-red-500",children:$}):e.jsx(ce,{reports:R,onReportDeleted:G})]})};export{we as default};
