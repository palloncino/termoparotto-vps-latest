import{r as n,d as U}from"./index-CNzNNqJE.js";import{a as W}from"./clientService-Bj64bQzW.js";import{a as b}from"./productsService-BaCjJiUO.js";import{m as F}from"./index-Bv7sGljf.js";import{a as R}from"./usersService-D84MQp6X.js";import{a as j}from"./worksiteService-CfPHAhQs.js";function H(c){const d={day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1},r=typeof c=="string"?new Date(c):c;return new Intl.DateTimeFormat("en-GB",d).format(r)}const L=(c,d)=>{const[r,u]=n.useState(c||{activities:[{client_id:"",worksite_id:"",description:"",travel_time:0,work_time:0,materials_used:[{product_id:"",quantity:0}],completed:!1,intervention_type:"economia",assigned_technician_id:""}],date:"",technician_id:"",short_description:"",status:"",lunch_location:""}),[m,p]=n.useState([]),[h,g]=n.useState([]),[a,o]=n.useState([]),[k,y]=n.useState([]),[q,v]=n.useState(!0),[D,f]=n.useState(null),E=U();n.useEffect(()=>{(async()=>{v(!0);try{const[e,s,i,_]=await Promise.all([W(),j(),b(),R()]);g(s),p(e.clients),o(i.products),y(_.users),f(null)}catch(e){f("Failed to fetch data. Please try again later."),console.error("Error fetching data:",e)}finally{v(!1)}})()},[]),n.useEffect(()=>{d&&d(r)},[r,d]);const B=t=>{const{name:e,value:s}=t.target;u(i=>({...i,[e]:s}))},I=(t,e,s)=>{const{name:i,value:_}=e.target,l=[...r.activities];s!==void 0?l[t].materials_used[s]={...l[t].materials_used[s],[i]:_}:l[t]={...l[t],[i]:_},u(C=>({...C,activities:l}))},P=()=>{u(t=>({...t,activities:[...t.activities,{client_id:"",worksite_id:"",description:"",travel_time:0,work_time:0,materials_used:[{product_id:"",quantity:0}],completed:!1,intervention_type:"economia",assigned_technician_id:""}]}))},S=t=>{const e=[...r.activities];e[t].materials_used.push({product_id:"",quantity:0}),u(s=>({...s,activities:e}))},$=async t=>{t.preventDefault();const e=w();if(Object.keys(e).length>0)return;const s={...r};s.activities.forEach(i=>{i.client_id=i.client_id||null,i.worksite_id=i.worksite_id||null,i.assigned_technician_id=i.assigned_technician_id||null,i.materials_used.forEach(_=>{_.product_id=_.product_id||null})});try{const i=await F(s);if(i&&i._id)E(`/reports/${i._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(i){console.error("Error creating report:",i),f("Error creating report. Please try again later.")}},A=t=>{u(e=>({...e,activities:e.activities.filter((s,i)=>i!==t)}))},w=()=>{const t={};return r.date||(t.date="date_required"),r.technician_id||(t.technician_id="technician_required"),r.lunch_location||(t.lunch_location="lunch_location_required"),r.status||(t.status="status_required"),r.short_description||(t.short_description="short_description_required"),r.activities.forEach((e,s)=>{e.client_id||(t[`activities[${s}].client_id`]="client_required"),e.worksite_id||(t[`activities[${s}].worksite_id`]="worksite_required"),e.description||(t[`activities[${s}].description`]="description_required"),e.assigned_technician_id||(t[`activities[${s}].assigned_technician_id`]="assigned_technician_required"),(e.travel_time===void 0||e.travel_time<0)&&(t[`activities[${s}].travel_time`]="invalid_travel_time"),(e.work_time===void 0||e.work_time<0)&&(t[`activities[${s}].work_time`]="invalid_work_time")}),t};return{formData:r,clients:m,worksites:h,products:a,users:k,isLoading:q,error:D,handleChange:B,handleActivityChange:I,handleSubmit:$,appendActivity:P,removeActivity:A,validateForm:w,appendMaterial:S}},J=()=>{const{clients:c,worksites:d,products:r,users:u}=L();return{getClientById:a=>c.find(o=>o._id===a),getWorksiteById:a=>d.find(o=>o._id===a),getProductById:a=>r.find(o=>o._id===a),getUserById:a=>u.find(o=>o._id===a)}};export{L as a,H as f,J as u};
