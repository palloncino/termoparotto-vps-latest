import{a as K,i as X,u as Y,j as e,c as Q,Q as H,n as G,R as z,T as Z,x as W,q as ee,d as se,w as te,U as ae,r as re,z as ie,e as le,V as ne,g as oe,W as ce}from"./index-BUyh9A9T.js";import{r as N}from"./vendor-8AKiDlQN.js";import{a as de}from"./clientService-qRF0PNhS.js";import{a as me}from"./productsService-BwLSiUTT.js";import{e as xe,a as ue}from"./reportService-CsvEZGDr.js";import{a as he}from"./usersService--1COgLA-.js";import{a as _e}from"./worksiteService-DblhuvHv.js";import{u as ge,a as fe}from"./router-BmsaeIqg.js";import{b as pe,c as V}from"./formatDate-BAMmqpAD.js";const be=()=>{const{user:l}=K(),{showFlashMessage:s}=X(),[u,x]=N.useState({header:{date:new Date().toISOString().split("T")[0],author_id:(l==null?void 0:l._id)||"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[{assigned_technician_ids:l!=null&&l._id?[l._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]}]}),[b,F]=N.useState([]),[D,C]=N.useState([]),[p,v]=N.useState([]),[R,U]=N.useState([]),[M,A]=N.useState(!0),{t:i}=Y(),j=ge();N.useEffect(()=>{(async()=>{A(!0);try{const[o,c,r,n]=await Promise.all([de(),_e(),me(1,{searchText:"",type:""}),he()]);F(o.clients),v(r.products),U(n.users);const a=c.map(d=>({...d,client_id:d.client_id||d.clientId||null}));C(a)}catch(o){const c=o instanceof Error?o.message:"An error occurred";s(c,"error")}finally{A(!1)}})()},[]),N.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(u))},[u]),N.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const w=t=>{const{name:o,value:c}=t.target;x(r=>r.header?{...r,header:{...r.header,[o]:c}}:r)},y=(t,o,c)=>{const r=o.split("."),n={...t};let a=n;for(let m=0;m<r.length-1;m++){const _=r[m],g=_.match(/(\w+)\[(\d+)\]/);if(g){const f=g[1],k=parseInt(g[2],10);a[f]||(a[f]=[]),a[f]=[...a[f]],a[f][k]||(a[f][k]={}),a[f][k]={...a[f][k]},a=a[f][k]}else a[_]||(a[_]={}),a[_]={...a[_]},a=a[_]}const d=r[r.length-1];return a[d]=c,n},q=(t,o,c)=>{x(r=>{const n=r.activities?[...r.activities]:[],a=n[t],d=y(a,o,c);return n[t]=d,{...r,activities:n}})},L=()=>{x(t=>({...t,activities:[...t.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[]}]}))},T=t=>{x(o=>{var c;return{...o,activities:(c=o.activities)==null?void 0:c.filter((r,n)=>n!==t)}})},h=t=>{x(o=>{const c=o.activities?[...o.activities]:[],r={...c[t]};return r.tasks=[...r.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}],c[t]=r,{...o,activities:c}})},$=(t,o)=>{x(c=>{const r=c.activities?[...c.activities]:[],n={...r[t]};return n.tasks=n.tasks.filter((a,d)=>d!==o),r[t]=n,{...c,activities:r}})},B=(t,o)=>{x(c=>{const r=c.activities?[...c.activities]:[],n={...r[t]},a={...n.tasks[o]},d=a.materials_used||[],m=d[d.length-1];return!m||m.product_id&&m.product_id.trim()!==""?a.materials_used=[...d,{product_id:"",quantity:1}]:a.materials_used=[...d],n.tasks[o]=a,r[t]=n,{...c,activities:r}})},P=(t,o,c)=>{x(r=>{const n=r.activities?[...r.activities]:[],a={...n[t]},d={...a.tasks[o]};return d.materials_used=d.materials_used.filter((m,_)=>_!==c),a.tasks[o]=d,n[t]=a,{...r,activities:n}})},E=async t=>{var n,a,d;t.preventDefault();const o=S();if(Object.keys(o).length>0){const m=Object.values(o),g=m.slice(0,3).join(", "),f=m.length>3?` e altri ${m.length-3} errori`:"";s(`Errore di validazione: ${g}${f}`,"error");return}if(!I()&&!window.confirm(i("proceed_without_material_message")))return;const r={...u,activities:(u.activities||[]).map(m=>({...m,tasks:m.tasks.map(_=>{const g={..._,materials_used:(_.materials_used||[]).filter(f=>f.product_id)};return g.intervention_status===""&&(g.intervention_status=void 0),g.payment_status===""&&(g.payment_status=void 0),g})}))};try{const m=await xe(r);if(m&&m._id)s(i("report_created_successfully"),"success"),j(`/reports/${m._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(m){if(console.error("Error creating report:",m),((n=m.response)==null?void 0:n.status)===400&&((d=(a=m.response)==null?void 0:a.data)==null?void 0:d.error)==="Validation Error"){const _=m.response.data.details,g=Object.values(_),k=g.slice(0,3).join(", "),J=g.length>3?` e altri ${g.length-3} errori`:"";s(`Errore di validazione server: ${k}${J}`,"error")}else s(i("error_creating_report"),"error")}},I=()=>{var t;return((t=u.activities)==null?void 0:t.some(o=>{var c;return(c=o.tasks)==null?void 0:c.some(r=>{var n;return(n=r.materials_used)==null?void 0:n.some(a=>a.product_id&&a.quantity>=1)})}))||!1},S=()=>{const t={},{header:o,activities:c}=u;if(o){if(!(c!=null&&c.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return o.date||(t["header.date"]=i("date_required")),o.author_id||(t["header.author_id"]=i("author_required")),o.status||(t["header.status"]=i("status_required")),o.lunch_location||(t["header.lunch_location"]=i("lunch_location_required")),c.forEach((r,n)=>{if(r.client_id||(t[`activities[${n}].client_id`]=i("client_required")),r.worksite_id||(t[`activities[${n}].worksite_id`]=i("worksite_required")),r.valid_travel_time==="manual")(!r.travel_time_hours||r.travel_time_hours<=0)&&(t[`activities[${n}].travel_time_hours`]=i("invalid_travel_time_hours"));else if(r.valid_travel_time==="rules")if(!r.travel_time_rules_applied)t[`activities[${n}].travel_time_rules_applied`]=i("travel_time_rules_required");else{const{distance_km:a,travel_time_hours:d}=r.travel_time_rules_applied;(a<=0||d<=0)&&(t[`activities[${n}].travel_time_rules_applied`]=i("invalid_travel_time_rules"))}r.tasks.forEach((a,d)=>{(!a.task_description||a.task_description.trim()==="")&&(t[`activities[${n}].tasks[${d}].task_description`]=i("task_description_required")),a.work_hours<=0&&(t[`activities[${n}].tasks[${d}].work_hours`]=i("invalid_work_hours")),!a.intervention_type.da_preventivo&&!a.intervention_type.in_economia&&!a.intervention_type.sopralluogo&&(t[`activities[${n}].tasks[${d}].intervention_type`]=i("intervention_type_required")),a.materials_used.forEach((m,_)=>{m.product_id&&m.quantity<1&&(t[`activities[${n}].tasks[${d}].materials_used[${_}].quantity`]=i("invalid_material_quantity"))})})}),t};return{formData:u,clients:b,worksites:D,products:p,users:R,isLoading:M,handleHeaderChange:w,handleActivityChange:q,handleSubmit:E,appendActivity:L,removeActivity:T,appendTask:h,removeTask:$,appendMaterial:B,removeMaterial:P,validateForm:S,checkIfHasMaterials:I}};function O(l,s){const u=Math.floor(l),x=Math.round((l-u)*60);let b="";return u>0&&(b+=`${u} ${s(u===1?"hour":"hours")}`),x>0&&(b&&(b+=" "),b+=`${x} ${s(x===1?"minute":"minutes")}`),b||(b=s("no_time")),b}const ve=()=>{const{clients:l,worksites:s,products:u,users:x}=be();return{getClientById:p=>l.find(v=>v._id===p),getWorksiteById:p=>s.find(v=>v._id===p),getProductById:p=>u.find(v=>v._id===p),getUserById:p=>x.find(v=>v._id===p)}},Ce=({report:l})=>{const{t:s}=Y(),u=fe(),{showFlashMessage:x}=X(),{getClientById:b,getWorksiteById:F,getProductById:D,getUserById:C}=ve(),[p,v]=N.useState(!1);N.useEffect(()=>{new URLSearchParams(u.search).get("action")==="report_created_successfully"&&x(s("report_created_successfully"),"success")},[u,x,s]);const R=async()=>{v(!0);try{const i=await ue({reportId:l._id}),j=new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),w=URL.createObjectURL(j),y=document.createElement("a");y.href=w,y.setAttribute("download",`report-${l._id}.xlsx`),document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(w),x(s("report_exported_successfully"),"success")}catch(i){console.error("Error exporting report:",i),x(s("error_exporting_xlsx"),"error")}finally{v(!1)}},U=i=>i.completed?e.jsx(oe,{className:"text-green-500 text-2xl"}):e.jsx(ce,{className:"text-yellow-500 text-2xl"}),M=typeof l.technician_id=="object"&&l.technician_id!==null?l.technician_id.name:"",A=l.activities||[];return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 p-8 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(Q,{className:"text-4xl"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("report_details")}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(H,{className:"text-lg"}),e.jsx("p",{className:"text-lg",children:l.date?pe(l.date,s):""})]})]})]}),e.jsxs("button",{onClick:R,disabled:p,className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-semibold transition-colors ${p?"bg-gray-400 cursor-not-allowed":"bg-white text-blue-600 hover:bg-gray-100"}`,children:[e.jsx(G,{className:"text-lg"}),e.jsx("span",{children:s(p?"exporting":"export_xlsx")})]})]})}),e.jsx("div",{className:"p-6 bg-gray-50",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(z,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("technician")})]}),M?e.jsx("a",{href:`/users/${typeof l.technician_id=="object"?l.technician_id._id:l.technician_id}`,className:"text-blue-600 hover:underline font-medium text-lg hover:text-blue-800 transition-colors",children:M}):e.jsx("p",{className:"text-gray-700 text-lg",children:s("not_assigned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-emerald-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(Z,{className:"text-2xl text-emerald-500"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["📊 ",s("status")]})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.status?s(l.status):s("not_specified")})]})]})}),e.jsx("div",{className:"p-6 bg-white border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(H,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("created")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.created?(()=>{const{text:i,isToday:j}=V(l.created?String(l.created):"",s);return j?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:i}):i})():s("not_specified")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(W,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("last_updated")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.last_updated?(()=>{const{text:i,isToday:j}=V(l.last_updated?String(l.last_updated):"",s);return j?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:i}):i})():s("not_specified")})]})]})}),e.jsxs("div",{className:"p-6 bg-white",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(ee,{className:"text-3xl text-blue-500"}),e.jsx("h3",{className:"text-2xl font-bold text-gray-800",children:s("activities")})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:A.map((i,j)=>{var T;const w=b(i.client_id),y=F(i.worksite_id),q=C(i.assigned_technician_id),L=((T=i.tasks)==null?void 0:T.reduce((h,$)=>h+($.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-lg border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg",children:j+1}),e.jsxs("h4",{className:"text-xl font-bold text-gray-800",children:[s("activity")," ",j+1]})]}),U(i)]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(se,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("client")})]}),e.jsx("a",{href:`/clients/${i.client_id}`,className:"text-blue-600 hover:underline font-medium text-lg",children:w?w.name:s("unknown_client")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(te,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("worksite")})]}),e.jsx("a",{href:`/worksites/${i.worksite_id}`,className:"text-blue-600 hover:underline font-medium text-lg",children:y?y.name:s("unknown_worksite")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(W,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("work_time")})]}),e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:O(L,s)})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ae,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("travel_time")})]}),e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:O(i.travel_time_hours||0,s)})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(z,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("assigned_technician")})]}),q?e.jsx("a",{href:`/users/${i.assigned_technician_id}`,className:"text-blue-600 hover:underline font-medium text-lg hover:text-blue-800 transition-colors",children:q.name}):e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:s("not_assigned")})]}),i.tasks&&i.tasks.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(re,{className:"text-xl text-blue-500"}),e.jsx("h5",{className:"text-lg font-semibold text-gray-700",children:s("tasks")})]}),i.tasks.map((h,$)=>e.jsxs("div",{className:"mb-6 p-6 bg-white rounded-xl shadow-md border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm",children:$+1}),e.jsx("h6",{className:"text-lg font-bold text-gray-800",children:h.task_description||s("no_description")})]}),e.jsx("div",{className:"bg-blue-50 rounded-lg p-3 mb-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(W,{className:"text-blue-500"}),e.jsxs("span",{className:"font-medium text-blue-800",children:[s("work_hours"),":"," ",O(h.work_hours||0,s)]})]})}),h.intervention_type&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ie,{className:"text-blue-500"}),e.jsx("h6",{className:"font-semibold text-gray-700",children:s("intervention_type")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.intervention_type.da_preventivo&&e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full border border-blue-300",children:["💰 ",s("da_preventivo")]}),h.intervention_type.in_economia&&e.jsxs("span",{className:"bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full border border-emerald-300",children:["💡 ",s("in_economia")]}),h.intervention_type.sopralluogo&&e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full border border-blue-300",children:["👀 ",s("sopralluogo")]}),!h.intervention_type.da_preventivo&&!h.intervention_type.in_economia&&!h.intervention_type.sopralluogo&&e.jsxs("span",{className:"bg-gray-100 text-gray-800 text-sm font-semibold px-3 py-1 rounded-full border border-gray-300",children:["❓ ",s("not_specified")]})]})]}),h.materials_used&&h.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(le,{className:"text-emerald-500"}),e.jsx("h6",{className:"font-semibold text-gray-700",children:s("materials_used")})]}),e.jsx("div",{className:"bg-emerald-50 rounded-lg p-4",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-emerald-200",children:[e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-sm font-bold text-emerald-800",children:s("quantity")})]})}),e.jsx("tbody",{children:h.materials_used.map((B,P)=>{const E=D(B.product_id);return e.jsx("tr",{className:"border-b border-emerald-200 hover:bg-emerald-100",children:E?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-2 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${E._id}`,children:E.data_documento})}),e.jsx("td",{className:"py-2 text-gray-700",children:E.descrizione}),e.jsx("td",{className:"py-2 text-right text-gray-600 font-semibold",children:B.quantity||0})]}):e.jsxs("td",{colSpan:3,className:"py-2 text-red-600 text-center",children:["❌ ",s("unknown_product")]})},P)})})]})})]})]},$))]})]},j)})})]}),e.jsx("div",{className:"p-6 bg-gradient-to-r from-blue-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ne,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("lunch_location")})]}),e.jsx("p",{className:"text-gray-700 text-lg mt-2 font-medium",children:l.lunch_location||s("not_specified")})]})})]})};export{Ce as R,O as f,be as u};
