import{u as $,j as e,k as V,l as q,m as J,n as K,a as Q,o as Y}from"./index-BUyh9A9T.js";import{r as c,b as Z}from"./vendor-8AKiDlQN.js";import{a as O}from"./clientService-qRF0PNhS.js";import{d as ee,a as I,b as te}from"./reportService-CsvEZGDr.js";import{a as A}from"./usersService--1COgLA-.js";import{a as W}from"./worksiteService-DblhuvHv.js";import{f as se,a as U}from"./formatDate-BAMmqpAD.js";import{T as D}from"./Tooltip-D_nYd3Sl.js";import{u as B}from"./router-BmsaeIqg.js";import"./api-BqC8VQ1e.js";const ne=({reports:i,onReportDeleted:S})=>{const{t:r}=$(),v=B(),[x,b]=c.useState([]),[R,h]=c.useState([]),[C,f]=c.useState([]),[w,u]=c.useState(new Set);c.useEffect(()=>{(async()=>{try{const[l,p,s]=await Promise.all([A(),O(),W()]);b(l.users),h(p.clients),f(s)}catch(l){console.error("Error fetching filter data:",l)}})()},[]);const _=async n=>{if(window.confirm(r("confirm_delete")))try{await ee(n),S()}catch(l){console.error("Error deleting report:",l)}},N=async n=>{u(l=>new Set(l).add(n));try{const l=await I({reportId:n}),p=new Blob([l],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=URL.createObjectURL(p),j=document.createElement("a");j.href=s,j.setAttribute("download",`report-${n}.xlsx`),document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(s)}catch(l){console.error("Error exporting report:",l),alert(r("error_exporting_xlsx"))}finally{u(l=>{const p=new Set(l);return p.delete(n),p})}};return e.jsx("div",{children:i.length===0?e.jsx("p",{children:r("no_reports_found")}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("date")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("created")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("last_updated")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("technician")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("activities")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("total_hours")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("status")}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:r("actions")})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.map(n=>{var j,k;const l=typeof n.technician_id=="object"&&n.technician_id!==null?n.technician_id.name:r("not_assigned"),p=((j=n.activities)==null?void 0:j.reduce((g,y)=>{var o;const F=((o=y.tasks)==null?void 0:o.reduce((T,L)=>T+(L.work_hours||0),0))||0;return g+F},0))||0,s=((k=n.activities)==null?void 0:k.length)||0;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:n.date?se(n.date,r):""}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:n.created?(()=>{const{text:g,isToday:y}=U(n.created,r);return y?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:g}):g})():r("not_specified")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:n.last_updated?(()=>{const{text:g,isToday:y}=U(n.last_updated,r);return y?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:g}):g})():r("not_specified")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:l}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[s," ",r(s===1?"activity":"activities")]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.jsxs("span",{className:"font-medium",children:[p.toFixed(1)," ",r("hours")]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${n.status==="completed"?"bg-green-100 text-green-800":n.status==="in_progress"?"bg-yellow-100 text-yellow-800":n.status==="planned"?"bg-blue-100 text-blue-800":n.status==="SIMULATION_TEST"?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:r(n.status)||r("not_specified")})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(D,{content:r("view_report"),children:e.jsx("button",{onClick:()=>v(`/reports/${n._id}`),className:"text-blue-500 hover:text-blue-700",children:e.jsx(V,{className:"h-4 w-4"})})}),e.jsx(D,{content:r("edit_report"),children:e.jsx("button",{onClick:()=>v(`/reports/${n._id}/edit`),className:"text-green-500 hover:text-green-700",children:e.jsx(q,{className:"h-4 w-4"})})}),e.jsx(D,{content:r("delete_report"),children:e.jsx("button",{onClick:()=>_(n._id),className:"text-red-500 hover:text-red-700",children:e.jsx(J,{className:"h-4 w-4"})})}),e.jsx(D,{content:r("export_report"),children:e.jsx("button",{onClick:()=>N(n._id),className:"text-purple-500 hover:text-purple-700",disabled:w.has(n._id),children:w.has(n._id)?e.jsxs("svg",{className:"animate-spin h-4 w-4 text-purple-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsx(K,{className:"h-4 w-4"})})})]})})]},n._id)})})]})})})},ae=({technicians:i,clients:S,worksites:r,onFiltersChange:v})=>{var n,l,p;const{t:x}=$(),[b,R]=c.useState(""),[h,C]=c.useState(""),[f,w]=c.useState(""),[u,_]=c.useState(""),N=()=>{v&&v({month:b||void 0,technician:h||void 0,client:f||void 0,worksite:u||void 0})};return Z.useEffect(()=>{N()},[b,h,f,u]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 items-end",children:[e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("month")}),e.jsx("input",{type:"month",value:b,onChange:s=>R(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full"})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("technician")}),e.jsxs("select",{value:h,onChange:s=>C(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),i.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("client")}),e.jsxs("select",{value:f,onChange:s=>w(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),S.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{className:"min-w-[120px]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-0.5",children:x("worksite")}),e.jsxs("select",{value:u,onChange:s=>_(s.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-200 focus:border-blue-400 w-full",children:[e.jsx("option",{value:"",children:x("all")}),r.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]})]}),(b||h||f||u)&&e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:[x("active_filters"),":"]}),b&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("month"),": ",b]}),h&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("technician"),":"," ",(n=i.find(s=>s._id===h))==null?void 0:n.name]}),f&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("client"),": ",(l=S.find(s=>s._id===f))==null?void 0:l.name]}),u&&e.jsxs("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 text-xs font-semibold align-middle",children:[x("worksite"),": ",(p=r.find(s=>s._id===u))==null?void 0:p.name]})]})]})},he=()=>{const{t:i}=$(),S=B(),[r,v]=c.useState([]),[x,b]=c.useState([]),[R,h]=c.useState(!0),[C,f]=c.useState(null),[w,u]=c.useState(!1),{user:_}=Q(),[N,n]=c.useState([]),[l,p]=c.useState([]),[s,j]=c.useState([]),[k,g]=c.useState(""),[y,F]=c.useState(""),[o,T]=c.useState({});c.useEffect(()=>{L(),P()},[]),c.useEffect(()=>{M()},[r,k,y]);const L=async()=>{h(!0);try{const t=await te();v(t),f(null)}catch(t){f(i("error_fetching_reports")),console.error(i("error_fetching_reports"),t)}finally{h(!1)}},P=async()=>{try{const[t,a,m]=await Promise.all([A(),O(),W()]);n(t.users),p(a.clients),j(m)}catch(t){console.error("Error fetching filter data:",t)}},M=()=>{let t=[...r];_&&_.role==="user"&&(t=t.filter(a=>a.technician_id&&(typeof a.technician_id=="object"?a.technician_id._id:a.technician_id)===_._id)),k&&(t=t.filter(a=>a.status===k)),y&&(t=t.filter(a=>(typeof a.technician_id=="object"?a.technician_id._id:a.technician_id)===y)),b(t)},z=()=>{L()},H=t=>{T(t)},X=t=>{const a=["reports"];if(t.month){const d=new Date(t.month+"-01").toLocaleDateString("en-US",{month:"long",year:"numeric"});a.push(d.replace(" ","-"))}if(t.technician){const d=N.find(E=>E._id===t.technician);d&&a.push(`tech-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}if(t.client){const d=l.find(E=>E._id===t.client);d&&a.push(`client-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}if(t.worksite){const d=s.find(E=>E._id===t.worksite);d&&a.push(`worksite-${d.name.replace(/\s+/g,"-").toLowerCase()}`)}a.length===1&&a.push("all");const m=new Date().toISOString().split("T")[0];return`${a.join("-")}-${m}.xlsx`},G=async()=>{u(!0);try{const t=await I(o),a=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=URL.createObjectURL(a),d=document.createElement("a");d.href=m,d.setAttribute("download",X(o)),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(m)}catch(t){console.error("Error exporting reports:",t),alert(i("error_exporting_xlsx"))}finally{u(!1)}};return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:i("report_list")}),e.jsx("button",{onClick:()=>S("/report-create"),className:"bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors",children:i("create_report")})]}),e.jsx("section",{className:"mb-6",children:e.jsxs("div",{className:"bg-white border border-blue-200 rounded-lg px-4 py-3 shadow-sm flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end gap-2 md:gap-4 w-full",children:[e.jsx("div",{className:"flex flex-1 flex-wrap gap-2 items-end",children:e.jsx(ae,{technicians:N,clients:l,worksites:s,onFiltersChange:H})}),e.jsx("div",{className:"flex-shrink-0 flex items-end",children:e.jsxs("button",{onClick:G,disabled:w,className:["inline-flex items-center gap-2 px-4 py-2 rounded-md font-semibold transition-colors border border-blue-600",w?"bg-blue-200 text-blue-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"].join(" "),children:[w&&e.jsxs("svg",{className:"animate-spin h-4 w-4 mr-1 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8z"})]}),e.jsx(Y,{className:"text-lg"}),e.jsx("span",{children:i(w?"exporting":"export_reports")})]})})]}),e.jsx("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-2 mt-1",children:e.jsx("div",{className:"text-xs text-blue-700 font-medium",children:(()=>{const t=[];if(o.month&&t.push(`${i("month")}: ${o.month}`),o.technician){const a=N.find(m=>m._id===o.technician);t.push(`${i("technician")}: ${(a==null?void 0:a.name)||o.technician}`)}if(o.client){const a=l.find(m=>m._id===o.client);t.push(`${i("client")}: ${(a==null?void 0:a.name)||o.client}`)}if(o.worksite){const a=s.find(m=>m._id===o.worksite);t.push(`${i("worksite")}: ${(a==null?void 0:a.name)||o.worksite}`)}return t.length>0?e.jsxs("span",{children:[i("export_will_include"),":"," ",t.map((a,m)=>e.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-0.5 mx-1 text-xs font-semibold align-middle",children:a},m))]}):e.jsx("span",{className:"text-gray-500",children:i("export_all_reports_no_filters")})})()})})]})}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:i("filter_reports")}),e.jsx("button",{onClick:()=>{g(""),F("")},className:"text-sm text-gray-600 hover:text-gray-800 underline",children:i("clear_filters")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:i("status")}),e.jsxs("select",{value:k,onChange:t=>g(t.target.value),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:i("all")}),e.jsx("option",{value:"DRAFT",children:i("draft")}),e.jsx("option",{value:"FINITO",children:i("completed")}),e.jsx("option",{value:"IN_PROGRESS",children:i("in_progress")}),e.jsx("option",{value:"PLANNED",children:i("planned")}),e.jsx("option",{value:"SOSPESO",children:i("suspended")}),e.jsx("option",{value:"SIMULATION_TEST",children:i("simulation_test")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:i("technician")}),e.jsxs("select",{value:y,onChange:t=>F(t.target.value),className:"w-full border rounded px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:i("all")}),N.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]})]})]})]}),R?e.jsx("p",{children:i("loading_reports")}):C?e.jsx("p",{className:"text-red-500",children:C}):e.jsx(ne,{reports:x,onReportDeleted:z})]})};export{he as default};
