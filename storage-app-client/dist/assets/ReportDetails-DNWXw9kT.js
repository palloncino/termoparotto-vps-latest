import{b as J,r as y,u as R,c as K,O as Q,e as S,j as e}from"./index-BZfsmhhx.js";import{k as V,l as O,m as z,n as X,c as Z,o as I}from"./index-DVcFOJ97.js";import{a as ee}from"./clientService-D0rezJXS.js";import{a as te}from"./productsService-DUq13sXT.js";import{e as se}from"./reportService-DrFnAniA.js";import{a as ie}from"./usersService-CO4rIiT5.js";import{a as re}from"./worksiteService-CfPHAhQs.js";const ne=()=>{const{user:l}=J(),[t,m]=y.useState({header:{date:new Date().toISOString().split("T")[0],author_id:l._id,head_description:"Lorem ipsum",status:"DRAFT",lunch_location:"Bar Napoli"},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"67001eb2de74eb97b7583678",worksite_id:"67001eb2de74eb97b758367f",description:"Lorem ipsum",activity_description:"Lorem ipsum",completed:!1,travel_time_hours:1.5,travel_time:1.5,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:l._id||"",tasks:[{assigned_technician_ids:[l._id],work_hours:8.5,task_description:"Lorem ipsum",intervention_type:{to_quote:!0,in_economy:!1,site_inspection:!1},materials_used:[]}]}]}),[h,x]=y.useState([]),[$,D]=y.useState([]),[E,p]=y.useState([]),[f,C]=y.useState([]),[c,b]=y.useState(!0),[B,N]=y.useState(null),{t:d}=R(),P=K();y.useEffect(()=>{(async()=>{b(!0);try{const[r,a,i,o]=await Promise.all([ee(),re(),te(),ie()]);x(r.clients),p(i.products),C(o.users),D(a),N(null)}catch(r){N(d("failed_to_fetch_data")),console.error("Error fetching data:",r)}finally{b(!1)}})()},[d]),y.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(t))},[t]),y.useEffect(()=>{const s=localStorage.getItem("scrollY");s&&window.scrollTo(0,parseInt(s,10))},[]);const F=s=>{const{name:r,value:a}=s.target;m(i=>i.header?{...i,header:{...i.header,[r]:a}}:i)},u=(s,r,a)=>{const i=r.split("."),o={...s};let n=o;for(let v=0;v<i.length-1;v++){const g=i[v],U=g.match(/(\w+)\[(\d+)\]/);if(U){const j=U[1],q=parseInt(U[2],10);n[j]||(n[j]=[]),n[j]=[...n[j]],n[j][q]||(n[j][q]={}),n[j][q]={...n[j][q]},n=n[j][q]}else n[g]||(n[g]={}),n[g]={...n[g]},n=n[g]}const _=i[i.length-1];return n[_]=a,o},k=(s,r,a)=>{console.log("[handleActivityChange]",{activityIndex:s,fieldPath:r,value:a}),m(i=>{const o=i.activities?[...i.activities]:[],n=o[s],_=u(n,r,a);return o[s]=_,{...i,activities:o}})},A=()=>{m(s=>({...s,activities:[...s.activities,{client_id:"",worksite_id:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time_rules_applied:void 0,valid_travel_time:"manual",tasks:[]}]}))},T=s=>{m(r=>{var a;return{...r,activities:(a=r.activities)==null?void 0:a.filter((i,o)=>o!==s)}})},w=s=>{m(r=>{console.log(1.1,{prevState:r});const a=r.activities?[...r.activities]:[],i={...a[s]};return i.tasks=[...i.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}],a[s]=i,console.log(1.2,{newState:{...r,activities:a}}),{...r,activities:a}})},W=(s,r)=>{m(a=>{const i=a.activities?[...a.activities]:[],o={...i[s]};return o.tasks=o.tasks.filter((n,_)=>_!==r),i[s]=o,{...a,activities:i}})},H=(s,r)=>{m(a=>{const i=a.activities?[...a.activities]:[],o={...i[s]},n={...o.tasks[r]};return n.materials_used=[...n.materials_used||[],{product_id:"",quantity:0}],o.tasks[r]=n,i[s]=o,{...a,activities:i}})},Y=(s,r,a)=>{m(i=>{const o=i.activities?[...i.activities]:[],n={...o[s]},_={...n.tasks[r]};return _.materials_used=_.materials_used.filter((v,g)=>g!==a),n.tasks[r]=_,o[s]=n,{...i,activities:o}})},G=async s=>{s.preventDefault();const r=M();if(Object.keys(r).length>0){console.log("Validation Errors:",r);return}try{const a=await se(t);if(a&&a._id)P(`/reports/${a._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(a){console.error("Error creating report:",a),N(d("error_creating_report"))}},M=()=>{const s={},{header:r,activities:a}=t;if(r){if(!(a!=null&&a.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return r.date||(s["header.date"]=d("date_required")),r.author_id||(s["header.author_id"]=d("author_required")),r.head_description||(s["header.head_description"]=d("head_description_required")),r.status||(s["header.status"]=d("status_required")),r.lunch_location||(s["header.lunch_location"]=d("lunch_location_required")),(!r.head_description||r.head_description.trim()==="")&&(s["header.short_description"]=d("short_description_required")),a.forEach((i,o)=>{if(i.client_id||(s[`activities[${o}].client_id`]=d("client_required")),i.worksite_id||(s[`activities[${o}].worksite_id`]=d("worksite_required")),i.activity_description||(s[`activities[${o}].activity_description`]=d("activity_description_required")),i.valid_travel_time==="manual")i.travel_time_hours<=0&&(s[`activities[${o}].travel_time_hours`]=d("invalid_travel_time_hours"));else if(i.valid_travel_time==="rules")if(!i.travel_time_rules_applied)s[`activities[${o}].travel_time_rules_applied`]=d("travel_time_rules_required");else{const{distance_km:n,travel_time_hours:_}=i.travel_time_rules_applied;(n<=0||_<=0)&&(s[`activities[${o}].travel_time_rules_applied`]=d("invalid_travel_time_rules"))}i.tasks.forEach((n,_)=>{(!n.task_description||n.task_description.trim()==="")&&(s[`activities[${o}].tasks[${_}].task_description`]=d("task_description_required")),n.work_hours<=0&&(s[`activities[${o}].tasks[${_}].work_hours`]=d("invalid_work_hours")),!n.intervention_type.to_quote&&!n.intervention_type.in_economy&&!n.intervention_type.site_inspection&&(s[`activities[${o}].tasks[${_}].intervention_type`]=d("intervention_type_required")),n.materials_used.forEach((v,g)=>{v.product_id||(s[`activities[${o}].tasks[${_}].materials_used[${g}].product_id`]=d("product_id_required")),v.quantity<=0&&(s[`activities[${o}].tasks[${_}].materials_used[${g}].quantity`]=d("invalid_material_quantity"))})})}),s};return{formData:t,clients:h,worksites:$,products:E,users:f,isLoading:c,error:B,handleHeaderChange:F,handleActivityChange:k,handleSubmit:G,appendActivity:A,removeActivity:T,appendTask:w,removeTask:W,appendMaterial:H,removeMaterial:Y,validateForm:M}};function L(l){const t=Math.floor(l),m=Math.round((l-t)*60),{t:h}=R();let x="";return t>0&&(x+=h(`${t} ${h(t===1?"hour":"hours")}`)),m>0&&(x&&(x+=" "),x+=`${m} ${h(m===1?"minute":"minutes")}`),x||(x=h("no_time")),x}const ae=()=>{const{clients:l,worksites:t,products:m,users:h}=ne();return{getClientById:p=>l.find(f=>f._id===p),getWorksiteById:p=>t.find(f=>f._id===p),getProductById:p=>m.find(f=>f._id===p),getUserById:p=>h.find(f=>f._id===p)}};function oe(l){const t={day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1},m=typeof l=="string"?new Date(l):l;return new Intl.DateTimeFormat("en-GB",t).format(m)}const xe=({report:l})=>{const{t}=R(),m=Q(),{showFlashMessage:h}=S(),{getClientById:x,getWorksiteById:$,getProductById:D,getUserById:E}=ae();y.useEffect(()=>{new URLSearchParams(m.search).get("action")==="report_created_successfully"&&h(t("report_created_successfully"),"success")},[m,h,t]);const p=c=>c.completed?e.jsx(Z,{className:"text-green-500 text-2xl"}):e.jsx(I,{className:"text-yellow-500 text-2xl"}),f=typeof l.technician_id=="object"&&l.technician_id!==null?l.technician_id.name:"",C=l.activities||[];return e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:t("report_details")}),e.jsx("p",{className:"text-gray-600",children:l.date?oe(l.date):""})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("dl",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("technician")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:f||t("not_assigned")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("status")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:l.status?t(l.status):t("not_specified")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("short_description")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:l.short_description||t("no_description")})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:t("activities")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:C.map((c,b)=>{var F;const B=x(c.client_id),N=$(c.worksite_id),d=E(c.assigned_technician_id),P=((F=c.tasks)==null?void 0:F.reduce((u,k)=>u+(k.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[t("activity")," ",b+1]}),p(c)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("client")}),e.jsx("a",{href:`/clients/${c.client_id}`,className:"text-blue-600 hover:underline",children:B?B.name:t("unknown_client")})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("worksite")}),e.jsx("a",{href:`/worksites/${c.worksite_id}`,className:"text-blue-600 hover:underline",children:N?N.name:t("unknown_worksite")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(V,{className:"inline-block text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-600",children:c.activity_description||t("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(O,{className:"inline-block text-blue-500 mr-2"}),e.jsxs("span",{className:"text-gray-600",children:[t("work_time"),": ",L(P)," ",t("hours")]})]}),e.jsx("div",{children:e.jsxs("span",{className:"text-gray-600",children:[t("travel_time"),": ",L(c.travel_time_hours||0)," ",t("hours")]})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("intervention_type")}),c.intervention_type?e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("to_quote")}),c.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("in_economy")}),c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("site_inspection")}),!c.intervention_type.to_quote&&!c.intervention_type.in_economy&&!c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("not_specified")})]}):e.jsx("p",{className:"text-gray-600",children:t("not_specified")})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("assigned_technician")}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(z,{className:"inline-block text-blue-500 mr-2"}),e.jsx("p",{children:d?d.name:t("not_assigned")})]})]}),c.tasks&&c.tasks.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:t("tasks")}),c.tasks.map((u,k)=>e.jsxs("div",{className:"mb-4 p-4 bg-white rounded shadow-sm",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:u.task_description||t("no_description")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(O,{className:"inline-block text-gray-500 mr-1"}),t("work_hours"),": ",L(u.work_hours||0)]}),u.intervention_type&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h6",{className:"text-xs font-semibold text-gray-500",children:t("intervention_type")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[u.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("to_quote")}),u.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("in_economy")}),u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("site_inspection")}),!u.intervention_type.to_quote&&!u.intervention_type.in_economy&&!u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("not_specified")})]})]}),u.materials_used&&u.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold text-gray-700",children:t("materials_used")}),e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:t("item_code")}),e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:t("description")}),e.jsx("th",{className:"py-2 text-right text-xs font-semibold text-gray-600",children:t("Quantity")})]})}),e.jsx("tbody",{children:u.materials_used.map((A,T)=>{const w=D(A.product_id);return e.jsx("tr",{className:"border-t",children:w?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-1 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${w._id}`,children:w.item_code})}),e.jsx("td",{className:"py-1 text-gray-700",children:w.item_description}),e.jsx("td",{className:"py-1 text-right text-gray-600",children:A.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-1 text-red-600",children:t("unknown_product")})},T)})})]})]})]},k))]})]},b)})})]}),e.jsxs("div",{className:"flex items-center p-6",children:[e.jsx(X,{className:"text-blue-500 mr-2"}),e.jsxs("p",{className:"text-gray-600",children:[t("lunch_location"),": ",l.lunch_location||t("not_specified")]})]})]})};export{xe as R,L as f,ne as u};
