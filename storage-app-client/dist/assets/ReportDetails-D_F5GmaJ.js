import{a as Q,i as S,u as z,j as e,c as V,a8 as O,a9 as H,aa as X,M as U,E as Z,d as ee,J as se,ab as te,G as ae,Q as ie,e as re,ac as le,g as ne,ad as ce}from"./index-Bb6EHiR5.js";import{r as y}from"./vendor-8AKiDlQN.js";import{a as oe}from"./clientService-qRF0PNhS.js";import{a as de}from"./productsService-BwLSiUTT.js";import{c as me}from"./reportService-CmqWvr86.js";import{a as ue}from"./usersService--1COgLA-.js";import{a as xe}from"./worksiteService-DblhuvHv.js";import{u as he,a as _e}from"./router-BmsaeIqg.js";import{a as ge,b as I}from"./formatDate-BuXJr5y_.js";const fe=()=>{const{user:l}=Q(),{showFlashMessage:s}=S(),[x,h]=y.useState({header:{date:new Date().toISOString().split("T")[0],author_id:(l==null?void 0:l._id)||"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[{assigned_technician_ids:l!=null&&l._id?[l._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]}]}),[b,E]=y.useState([]),[D,M]=y.useState([]),[j,v]=y.useState([]),[T,m]=y.useState([]),[N,F]=y.useState(!0),{t:u}=z(),A=he();y.useEffect(()=>{(async()=>{F(!0);try{const[n,c,i,r]=await Promise.all([oe(),xe(),de(1,{searchText:"",type:""}),ue()]);E(n.clients),v(i.products),m(r.users);const a=c.map(o=>({...o,client_id:o.client_id||o.clientId||null}));M(a)}catch(n){const c=n instanceof Error?n.message:"An error occurred";s(c,"error")}finally{F(!1)}})()},[]),y.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(x))},[x]),y.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const B=t=>{const{name:n,value:c}=t.target;h(i=>i.header?{...i,header:{...i.header,[n]:c}}:i)},q=(t,n,c)=>{const i=n.split("."),r={...t};let a=r;for(let d=0;d<i.length-1;d++){const g=i[d],f=g.match(/(\w+)\[(\d+)\]/);if(f){const p=f[1],w=parseInt(f[2],10);a[p]||(a[p]=[]),a[p]=[...a[p]],a[p][w]||(a[p][w]={}),a[p][w]={...a[p][w]},a=a[p][w]}else a[g]||(a[g]={}),a[g]={...a[g]},a=a[g]}const o=i[i.length-1];return a[o]=c,r},_=(t,n,c)=>{h(i=>{const r=i.activities?[...i.activities]:[],a=r[t],o=q(a,n,c);return r[t]=o,{...i,activities:r}})},k=()=>{h(t=>({...t,activities:[...t.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(l==null?void 0:l._id)||"",tasks:[]}]}))},C=t=>{h(n=>{var c;return{...n,activities:(c=n.activities)==null?void 0:c.filter((i,r)=>r!==t)}})},P=t=>{h(n=>{const c=n.activities?[...n.activities]:[],i={...c[t]};return i.tasks=[...i.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}],c[t]=i,{...n,activities:c}})},$=(t,n)=>{h(c=>{const i=c.activities?[...c.activities]:[],r={...i[t]};return r.tasks=r.tasks.filter((a,o)=>o!==n),i[t]=r,{...c,activities:i}})},J=(t,n)=>{h(c=>{const i=c.activities?[...c.activities]:[],r={...i[t]},a={...r.tasks[n]},o=a.materials_used||[],d=o[o.length-1];return!d||d.product_id&&d.product_id.trim()!==""?a.materials_used=[...o,{product_id:"",quantity:1}]:a.materials_used=[...o],r.tasks[n]=a,i[t]=r,{...c,activities:i}})},Y=(t,n,c)=>{h(i=>{const r=i.activities?[...i.activities]:[],a={...r[t]},o={...a.tasks[n]};return o.materials_used=o.materials_used.filter((d,g)=>g!==c),a.tasks[n]=o,r[t]=a,{...i,activities:r}})},G=async t=>{var r,a,o;t.preventDefault();const n=L();if(Object.keys(n).length>0){const d=Object.values(n),f=d.slice(0,3).join(", "),p=d.length>3?` e altri ${d.length-3} errori`:"";s(`Errore di validazione: ${f}${p}`,"error");return}if(!W()&&!window.confirm(u("proceed_without_material_message")))return;const i={...x,activities:(x.activities||[]).map(d=>({...d,tasks:d.tasks.map(g=>{const f={...g,materials_used:(g.materials_used||[]).filter(p=>p.product_id)};return f.intervention_status===""&&(f.intervention_status=void 0),f.payment_status===""&&(f.payment_status=void 0),f})}))};try{const d=await me(i);if(d&&d._id)s(u("report_created_successfully"),"success"),A(`/reports/${d._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(d){if(console.error("Error creating report:",d),((r=d.response)==null?void 0:r.status)===400&&((o=(a=d.response)==null?void 0:a.data)==null?void 0:o.error)==="Validation Error"){const g=d.response.data.details,f=Object.values(g),w=f.slice(0,3).join(", "),K=f.length>3?` e altri ${f.length-3} errori`:"";s(`Errore di validazione server: ${w}${K}`,"error")}else s(u("error_creating_report"),"error")}},W=()=>{var t;return((t=x.activities)==null?void 0:t.some(n=>{var c;return(c=n.tasks)==null?void 0:c.some(i=>{var r;return(r=i.materials_used)==null?void 0:r.some(a=>a.product_id&&a.quantity>=1)})}))||!1},L=()=>{const t={},{header:n,activities:c}=x;if(n){if(!(c!=null&&c.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return n.date||(t["header.date"]=u("date_required")),n.author_id||(t["header.author_id"]=u("author_required")),n.status||(t["header.status"]=u("status_required")),n.lunch_location||(t["header.lunch_location"]=u("lunch_location_required")),c.forEach((i,r)=>{if(i.client_id||(t[`activities[${r}].client_id`]=u("client_required")),i.worksite_id||(t[`activities[${r}].worksite_id`]=u("worksite_required")),i.valid_travel_time==="manual")(!i.travel_time_hours||i.travel_time_hours<=0)&&(t[`activities[${r}].travel_time_hours`]=u("invalid_travel_time_hours"));else if(i.valid_travel_time==="rules")if(!i.travel_time_rules_applied)t[`activities[${r}].travel_time_rules_applied`]=u("travel_time_rules_required");else{const{distance_km:a,travel_time_hours:o}=i.travel_time_rules_applied;(a<=0||o<=0)&&(t[`activities[${r}].travel_time_rules_applied`]=u("invalid_travel_time_rules"))}i.tasks.forEach((a,o)=>{(!a.task_description||a.task_description.trim()==="")&&(t[`activities[${r}].tasks[${o}].task_description`]=u("task_description_required")),a.work_hours<=0&&(t[`activities[${r}].tasks[${o}].work_hours`]=u("invalid_work_hours")),!a.intervention_type.da_preventivo&&!a.intervention_type.in_economia&&!a.intervention_type.sopralluogo&&(t[`activities[${r}].tasks[${o}].intervention_type`]=u("intervention_type_required")),a.materials_used.forEach((d,g)=>{d.product_id&&d.quantity<1&&(t[`activities[${r}].tasks[${o}].materials_used[${g}].quantity`]=u("invalid_material_quantity"))})})}),t};return{formData:x,clients:b,worksites:D,products:j,users:T,isLoading:N,handleHeaderChange:B,handleActivityChange:_,handleSubmit:G,appendActivity:k,removeActivity:C,appendTask:P,removeTask:$,appendMaterial:J,removeMaterial:Y,validateForm:L,checkIfHasMaterials:W}};function R(l,s){const x=Math.floor(l),h=Math.round((l-x)*60);let b="";return x>0&&(b+=`${x} ${s(x===1?"hour":"hours")}`),h>0&&(b&&(b+=" "),b+=`${h} ${s(h===1?"minute":"minutes")}`),b||(b=s("no_time")),b}const pe=()=>{const{clients:l,worksites:s,products:x,users:h}=fe();return{getClientById:j=>l.find(v=>v._id===j),getWorksiteById:j=>s.find(v=>v._id===j),getProductById:j=>x.find(v=>v._id===j),getUserById:j=>h.find(v=>v._id===j)}},Ee=({report:l})=>{const{t:s}=z(),x=_e(),{showFlashMessage:h}=S(),{getClientById:b,getWorksiteById:E,getProductById:D,getUserById:M}=pe();y.useEffect(()=>{new URLSearchParams(x.search).get("action")==="report_created_successfully"&&h(s("report_created_successfully"),"success")},[x,h,s]);const j=m=>m.completed?e.jsx(ne,{className:"text-green-500 text-2xl"}):e.jsx(ce,{className:"text-yellow-500 text-2xl"}),v=typeof l.technician_id=="object"&&l.technician_id!==null?l.technician_id.name:"",T=l.activities||[];return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 p-8 text-white",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(V,{className:"text-4xl"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold",children:s("report_details")}),e.jsxs("div",{className:"flex items-center space-x-2 mt-2",children:[e.jsx(O,{className:"text-lg"}),e.jsx("p",{className:"text-lg",children:l.date?ge(l.date,s):""})]})]})]})}),e.jsx("div",{className:"p-6 bg-gray-50",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(H,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("technician")})]}),v?e.jsx("a",{href:`/users/${typeof l.technician_id=="object"?l.technician_id._id:l.technician_id}`,className:"text-blue-600 hover:underline font-medium text-lg hover:text-blue-800 transition-colors",children:v}):e.jsx("p",{className:"text-gray-700 text-lg",children:s("not_assigned")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-emerald-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(X,{className:"text-2xl text-emerald-500"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["📊 ",s("status")]})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.status?s(l.status):s("not_specified")})]})]})}),e.jsx("div",{className:"p-6 bg-white border-t border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(O,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("created")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.created?(()=>{const{text:m,isToday:N}=I(l.created?String(l.created):"",s);return N?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:m}):m})():s("not_specified")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx(U,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("last_updated")})]}),e.jsx("p",{className:"text-gray-700 text-lg",children:l.last_updated?(()=>{const{text:m,isToday:N}=I(l.last_updated?String(l.last_updated):"",s);return N?e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800",children:m}):m})():s("not_specified")})]})]})}),e.jsxs("div",{className:"p-6 bg-white",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-6",children:[e.jsx(Z,{className:"text-3xl text-blue-500"}),e.jsx("h3",{className:"text-2xl font-bold text-gray-800",children:s("activities")})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:T.map((m,N)=>{var q;const F=b(m.client_id),u=E(m.worksite_id),A=M(m.assigned_technician_id),B=((q=m.tasks)==null?void 0:q.reduce((_,k)=>_+(k.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-lg border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg",children:N+1}),e.jsxs("h4",{className:"text-xl font-bold text-gray-800",children:[s("activity")," ",N+1]})]}),j(m)]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ee,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("client")})]}),e.jsx("a",{href:`/clients/${m.client_id}`,className:"text-blue-600 hover:underline font-medium text-lg",children:F?F.name:s("unknown_client")})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(se,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("worksite")})]}),e.jsx("a",{href:`/worksites/${m.worksite_id}`,className:"text-blue-600 hover:underline font-medium text-lg",children:u?u.name:s("unknown_worksite")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(U,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("work_time")})]}),e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:R(B,s)})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(te,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("travel_time")})]}),e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:R(m.travel_time_hours||0,s)})]})]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-md border-l-4 border-blue-500 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(H,{className:"text-lg text-blue-500"}),e.jsx("h5",{className:"font-semibold text-gray-700",children:s("assigned_technician")})]}),A?e.jsx("a",{href:`/users/${m.assigned_technician_id}`,className:"text-blue-600 hover:underline font-medium text-lg hover:text-blue-800 transition-colors",children:A.name}):e.jsx("p",{className:"text-gray-800 text-lg font-medium",children:s("not_assigned")})]}),m.tasks&&m.tasks.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(ae,{className:"text-xl text-blue-500"}),e.jsx("h5",{className:"text-lg font-semibold text-gray-700",children:s("tasks")})]}),m.tasks.map((_,k)=>e.jsxs("div",{className:"mb-6 p-6 bg-white rounded-xl shadow-md border-2 border-blue-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm",children:k+1}),e.jsx("h6",{className:"text-lg font-bold text-gray-800",children:_.task_description||s("no_description")})]}),e.jsx("div",{className:"bg-blue-50 rounded-lg p-3 mb-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:"text-blue-500"}),e.jsxs("span",{className:"font-medium text-blue-800",children:[s("work_hours"),":"," ",R(_.work_hours||0,s)]})]})}),_.intervention_type&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ie,{className:"text-blue-500"}),e.jsx("h6",{className:"font-semibold text-gray-700",children:s("intervention_type")})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[_.intervention_type.da_preventivo&&e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full border border-blue-300",children:["💰 ",s("da_preventivo")]}),_.intervention_type.in_economia&&e.jsxs("span",{className:"bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full border border-emerald-300",children:["💡 ",s("in_economia")]}),_.intervention_type.sopralluogo&&e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full border border-blue-300",children:["👀 ",s("sopralluogo")]}),!_.intervention_type.da_preventivo&&!_.intervention_type.in_economia&&!_.intervention_type.sopralluogo&&e.jsxs("span",{className:"bg-gray-100 text-gray-800 text-sm font-semibold px-3 py-1 rounded-full border border-gray-300",children:["❓ ",s("not_specified")]})]})]}),_.materials_used&&_.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsx(re,{className:"text-emerald-500"}),e.jsx("h6",{className:"font-semibold text-gray-700",children:s("materials_used")})]}),e.jsx("div",{className:"bg-emerald-50 rounded-lg p-4",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-emerald-200",children:[e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-sm font-bold text-emerald-800",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-sm font-bold text-emerald-800",children:s("quantity")})]})}),e.jsx("tbody",{children:_.materials_used.map((C,P)=>{const $=D(C.product_id);return e.jsx("tr",{className:"border-b border-emerald-200 hover:bg-emerald-100",children:$?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-2 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${$._id}`,children:$.data_documento})}),e.jsx("td",{className:"py-2 text-gray-700",children:$.descrizione}),e.jsx("td",{className:"py-2 text-right text-gray-600 font-semibold",children:C.quantity||0})]}):e.jsxs("td",{colSpan:3,className:"py-2 text-red-600 text-center",children:["❌ ",s("unknown_product")]})},P)})})]})})]})]},k))]})]},N)})})]}),e.jsx("div",{className:"p-6 bg-gradient-to-r from-blue-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 shadow-md border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(le,{className:"text-2xl text-blue-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:s("lunch_location")})]}),e.jsx("p",{className:"text-gray-700 text-lg mt-2 font-medium",children:l.lunch_location||s("not_specified")})]})})]})};export{Ee as R,R as f,fe as u};
