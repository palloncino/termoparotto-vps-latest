import{g as V,r as y,u as W,h as I,a4 as Y,k as J,j as e,a5 as K,a6 as M,a7 as Q,a8 as G,d as X,a9 as Z}from"./index-C3uTfDV1.js";import{a as ee}from"./clientService-DWml5I6n.js";import{a as te}from"./productsService-DJ1x3sK0.js";import{c as se}from"./reportService-C5rT5Bns.js";import{a as ie}from"./usersService-CqL3O9jo.js";import{a as ae}from"./worksiteService-Bsvx2crQ.js";import{a as ne}from"./formatDate-CFXLpRQ8.js";const re=(c,t,_,p,h)=>{const b=t.length>0?t[0]._id:"",N=_.length>0?_[0]._id:"",v=h.length>0?h[0]._id:"";return{header:{date:new Date().toISOString().split("T")[0],author_id:c._id,head_description:"Sviluppo e manutenzione sistema di riscaldamento - Cliente ABC",status:"DRAFT",lunch_location:"Bar Centrale - Via Roma 123"},activities:[{_id:"dev_activity_1",client_id:b,worksite_id:N,description:"Intervento di manutenzione ordinaria",activity_description:"Controllo e pulizia caldaia, verifica pressione sistema, sostituzione filtri aria",completed:!1,travel_time_hours:1.5,travel_time:1.5,work_time:6.5,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!0,site_inspection:!1},assigned_technician_id:v,tasks:[{_id:"dev_task_1",assigned_technician_ids:[v],work_hours:4.5,task_description:"Controllo e pulizia caldaia - Rimozione polvere e residui, verifica funzionamento bruciatore",intervention_type:{to_quote:!1,in_economy:!0,site_inspection:!1},materials_used:[]},{_id:"dev_task_2",assigned_technician_ids:[v],work_hours:2,task_description:"Verifica pressione sistema - Controllo manometri, regolazione pressione ottimale",intervention_type:{to_quote:!1,in_economy:!0,site_inspection:!1},materials_used:[]}]},{_id:"dev_activity_2",client_id:b,worksite_id:N,description:"Ispezione tecnica preventiva",activity_description:"Analisi stato generale impianto, identificazione potenziali problemi, raccomandazioni",completed:!1,travel_time_hours:.5,travel_time:.5,work_time:3,valid_travel_time:"manual",intervention_type:{to_quote:!0,in_economy:!1,site_inspection:!0},assigned_technician_id:v,tasks:[{_id:"dev_task_3",assigned_technician_ids:[v],work_hours:3,task_description:"Ispezione completa impianto - Controllo tubazioni, valvole, termostati e sicurezza",intervention_type:{to_quote:!0,in_economy:!1,site_inspection:!0},materials_used:[]}]}]}},oe=()=>{const{user:c}=V(),[t,_]=y.useState({header:{date:new Date().toISOString().split("T")[0],author_id:c._id,head_description:"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:c._id||"",tasks:[{assigned_technician_ids:[c._id],work_hours:0,task_description:"",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}]}]}),[p,h]=y.useState([]),[b,N]=y.useState([]),[v,x]=y.useState([]),[f,F]=y.useState([]),[l,w]=y.useState(!0),[z,q]=y.useState(null),{t:d}=W(),B=I();y.useEffect(()=>{(async()=>{w(!0);try{const[a,r,i,o]=await Promise.all([ee(),ae(),te(1,{searchText:"",type:""}),ie()]);h(a.clients),x(i.products),F(o.users),N(r),q(null);const n=re(c,a.clients,r,i.products,o.users);_(n)}catch(a){q(d("failed_to_fetch_data")),console.error("Error fetching data:",a)}finally{w(!1)}})()},[d,c]),y.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(t))},[t]),y.useEffect(()=>{const s=localStorage.getItem("scrollY");s&&window.scrollTo(0,parseInt(s,10))},[]);const A=s=>{const{name:a,value:r}=s.target;_(i=>i.header?{...i,header:{...i.header,[a]:r}}:i)},u=(s,a,r)=>{const i=a.split("."),o={...s};let n=o;for(let k=0;k<i.length-1;k++){const g=i[k],R=g.match(/(\w+)\[(\d+)\]/);if(R){const j=R[1],D=parseInt(R[2],10);n[j]||(n[j]=[]),n[j]=[...n[j]],n[j][D]||(n[j][D]={}),n[j][D]={...n[j][D]},n=n[j][D]}else n[g]||(n[g]={}),n[g]={...n[g]},n=n[g]}const m=i[i.length-1];return n[m]=r,o},C=(s,a,r)=>{console.log("[handleActivityChange]",{activityIndex:s,fieldPath:a,value:r}),_(i=>{const o=i.activities?[...i.activities]:[],n=o[s],m=u(n,a,r);return o[s]=m,{...i,activities:o}})},E=()=>{_(s=>({...s,activities:[...s.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:c._id||"",tasks:[]}]}))},T=s=>{_(a=>{var r;return{...a,activities:(r=a.activities)==null?void 0:r.filter((i,o)=>o!==s)}})},$=s=>{_(a=>{console.log(1.1,{prevState:a});const r=a.activities?[...a.activities]:[],i={...r[s]};return i.tasks=[...i.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}],r[s]=i,console.log(1.2,{newState:{...a,activities:r}}),{...a,activities:r}})},S=(s,a)=>{_(r=>{const i=r.activities?[...r.activities]:[],o={...i[s]};return o.tasks=o.tasks.filter((n,m)=>m!==a),i[s]=o,{...r,activities:i}})},O=(s,a)=>{_(r=>{const i=r.activities?[...r.activities]:[],o={...i[s]},n={...o.tasks[a]};return n.materials_used=[...n.materials_used||[],{product_id:"",quantity:0}],o.tasks[a]=n,i[s]=o,{...r,activities:i}})},H=(s,a,r)=>{_(i=>{const o=i.activities?[...i.activities]:[],n={...o[s]},m={...n.tasks[a]};return m.materials_used=m.materials_used.filter((k,g)=>g!==r),n.tasks[a]=m,o[s]=n,{...i,activities:o}})},L=async s=>{s.preventDefault();const a=U();if(Object.keys(a).length>0){console.log("Validation Errors:",a);return}try{const r=await se(t);if(r&&r._id)B(`/reports/${r._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(r){console.error("Error creating report:",r),q(d("error_creating_report"))}},U=()=>{const s={},{header:a,activities:r}=t;if(a){if(!(r!=null&&r.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return a.date||(s["header.date"]=d("date_required")),a.author_id||(s["header.author_id"]=d("author_required")),a.head_description||(s["header.head_description"]=d("head_description_required")),a.status||(s["header.status"]=d("status_required")),a.lunch_location||(s["header.lunch_location"]=d("lunch_location_required")),(!a.head_description||a.head_description.trim()==="")&&(s["header.short_description"]=d("short_description_required")),r.forEach((i,o)=>{if(i.client_id||(s[`activities[${o}].client_id`]=d("client_required")),i.worksite_id||(s[`activities[${o}].worksite_id`]=d("worksite_required")),i.activity_description||(s[`activities[${o}].activity_description`]=d("activity_description_required")),i.valid_travel_time==="manual")i.travel_time_hours<=0&&(s[`activities[${o}].travel_time_hours`]=d("invalid_travel_time_hours"));else if(i.valid_travel_time==="rules")if(!i.travel_time_rules_applied)s[`activities[${o}].travel_time_rules_applied`]=d("travel_time_rules_required");else{const{distance_km:n,travel_time_hours:m}=i.travel_time_rules_applied;(n<=0||m<=0)&&(s[`activities[${o}].travel_time_rules_applied`]=d("invalid_travel_time_rules"))}i.tasks.forEach((n,m)=>{(!n.task_description||n.task_description.trim()==="")&&(s[`activities[${o}].tasks[${m}].task_description`]=d("task_description_required")),n.work_hours<=0&&(s[`activities[${o}].tasks[${m}].work_hours`]=d("invalid_work_hours")),!n.intervention_type.to_quote&&!n.intervention_type.in_economy&&!n.intervention_type.site_inspection&&(s[`activities[${o}].tasks[${m}].intervention_type`]=d("intervention_type_required")),n.materials_used.forEach((k,g)=>{k.product_id||(s[`activities[${o}].tasks[${m}].materials_used[${g}].product_id`]=d("product_id_required")),k.quantity<=0&&(s[`activities[${o}].tasks[${m}].materials_used[${g}].quantity`]=d("invalid_material_quantity"))})})}),s};return{formData:t,clients:p,worksites:b,products:v,users:f,isLoading:l,error:z,handleHeaderChange:A,handleActivityChange:C,handleSubmit:L,appendActivity:E,removeActivity:T,appendTask:$,removeTask:S,appendMaterial:O,removeMaterial:H,validateForm:U}};function P(c,t){const _=Math.floor(c),p=Math.round((c-_)*60);let h="";return _>0&&(h+=`${_} ${t(_===1?"hour":"hours")}`),p>0&&(h&&(h+=" "),h+=`${p} ${t(p===1?"minute":"minutes")}`),h||(h=t("no_time")),h}const ce=()=>{const{clients:c,worksites:t,products:_,users:p}=oe();return{getClientById:x=>c.find(f=>f._id===x),getWorksiteById:x=>t.find(f=>f._id===x),getProductById:x=>_.find(f=>f._id===x),getUserById:x=>p.find(f=>f._id===x)}},xe=({report:c})=>{const{t}=W(),_=Y(),{showFlashMessage:p}=J(),{getClientById:h,getWorksiteById:b,getProductById:N,getUserById:v}=ce();y.useEffect(()=>{new URLSearchParams(_.search).get("action")==="report_created_successfully"&&p(t("report_created_successfully"),"success")},[_,p,t]);const x=l=>l.completed?e.jsx(X,{className:"text-green-500 text-2xl"}):e.jsx(Z,{className:"text-yellow-500 text-2xl"}),f=typeof c.technician_id=="object"&&c.technician_id!==null?c.technician_id.name:"",F=c.activities||[];return e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:t("report_details")}),e.jsx("p",{className:"text-gray-600",children:c.date?ne(c.date,t):""})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("dl",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("technician")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:f||t("not_assigned")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("status")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:c.status?t(c.status):t("not_specified")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:t("short_description")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:c.short_description||t("no_description")})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:t("activities")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:F.map((l,w)=>{var A;const z=h(l.client_id),q=b(l.worksite_id),d=v(l.assigned_technician_id),B=((A=l.tasks)==null?void 0:A.reduce((u,C)=>u+(C.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[t("activity")," ",w+1]}),x(l)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("client")}),e.jsx("a",{href:`/clients/${l.client_id}`,className:"text-blue-600 hover:underline",children:z?z.name:t("unknown_client")})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("worksite")}),e.jsx("a",{href:`/worksites/${l.worksite_id}`,className:"text-blue-600 hover:underline",children:q?q.name:t("unknown_worksite")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(K,{className:"inline-block text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-600",children:l.activity_description||t("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(M,{className:"inline-block text-blue-500 mr-2"}),e.jsxs("span",{className:"text-gray-600",children:[t("work_time"),": ",P(B,t)," ",t("hours")]})]}),e.jsx("div",{children:e.jsxs("span",{className:"text-gray-600",children:[t("travel_time"),": ",P(l.travel_time_hours||0,t)," ",t("hours")]})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("intervention_type")}),l.intervention_type?e.jsxs("div",{className:"flex flex-wrap gap-2",children:[l.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("to_quote")}),l.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("in_economy")}),l.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("site_inspection")}),!l.intervention_type.to_quote&&!l.intervention_type.in_economy&&!l.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("not_specified")})]}):e.jsx("p",{className:"text-gray-600",children:t("not_specified")})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:t("assigned_technician")}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(Q,{className:"inline-block text-blue-500 mr-2"}),e.jsx("p",{children:d?d.name:t("not_assigned")})]})]}),l.tasks&&l.tasks.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:t("tasks")}),l.tasks.map((u,C)=>e.jsxs("div",{className:"mb-4 p-4 bg-white rounded shadow-sm",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:u.task_description||t("no_description")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(M,{className:"inline-block text-gray-500 mr-1"}),t("work_hours"),": ",P(u.work_hours||0,t)]}),u.intervention_type&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h6",{className:"text-xs font-semibold text-gray-500",children:t("intervention_type")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[u.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("to_quote")}),u.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("in_economy")}),u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("site_inspection")}),!u.intervention_type.to_quote&&!u.intervention_type.in_economy&&!u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:t("not_specified")})]})]}),u.materials_used&&u.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold text-gray-700",children:t("materials_used")}),e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:t("item_code")}),e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:t("description")}),e.jsx("th",{className:"py-2 text-right text-xs font-semibold text-gray-600",children:t("Quantity")})]})}),e.jsx("tbody",{children:u.materials_used.map((E,T)=>{const $=N(E.product_id);return e.jsx("tr",{className:"border-t",children:$?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-1 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${$._id}`,children:$.codice_articolo})}),e.jsx("td",{className:"py-1 text-gray-700",children:$.descrizione_articolo}),e.jsx("td",{className:"py-1 text-right text-gray-600",children:E.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-1 text-red-600",children:t("unknown_product")})},T)})})]})]})]},C))]})]},w)})})]}),e.jsxs("div",{className:"flex items-center p-6",children:[e.jsx(G,{className:"text-blue-500 mr-2"}),e.jsxs("p",{className:"text-gray-600",children:[t("lunch_location"),": ",c.lunch_location||t("not_specified")]})]})]})};export{xe as R,P as f,oe as u};
