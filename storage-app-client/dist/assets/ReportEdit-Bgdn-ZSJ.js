import{l as I,m as Q,u as K,j as e,p as Y,L as Z,y as ee,w as te,s as se,e as ie,t as re,b as J}from"./index-BzZmYvs7.js";import{r as h}from"./vendor-8AKiDlQN.js";import{g as ae}from"./clientService-Crb_EkMB.js";import{g as ne}from"./productsService-CuuFniz7.js";import{b as oe,u as le}from"./reportService-B3mXqAmG.js";import{g as de}from"./usersService-ChNqahqa.js";import{g as ce}from"./worksiteService-Dk965U3x.js";import{c as V,u as X}from"./router-BmsaeIqg.js";import{T as me}from"./Tooltip-B_tmM_z1.js";import{R as _e,A as ue,P as pe}from"./ReportHeader-BXYba4Ci.js";import"./api-Bb4ObIZy.js";import"./ReportDetails-BBw8wZ_z.js";import"./formatDate-Dk0xWO1M.js";const he=()=>{const{user:r}=I(),{showFlashMessage:x}=Q(),{id:y}=V(),p=X(),{t:m}=K(),[b,v]=h.useState({header:{date:new Date().toISOString().split("T")[0],author_id:(r==null?void 0:r._id)||"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(r==null?void 0:r._id)||"",tasks:[{assigned_technician_ids:r!=null&&r._id?[r._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]}]}),[N,F]=h.useState([]),[k,R]=h.useState([]),[q,P]=h.useState([]),[O,A]=h.useState([]),[L,D]=h.useState(!0),[H,E]=h.useState(!1);h.useEffect(()=>{(async()=>{D(!0);try{const[o,a,s,i]=await Promise.all([ae(),ce(),ne(1,{searchText:"",type:""}),de()]);F(o.clients),P(s.products),A(i.users);const n=a.map(l=>({...l,client_id:l.client_id||l.clientId||null}));R(n)}catch(o){const a=o instanceof Error?o.message:"An error occurred";x(a,"error")}finally{D(!1)}})()},[]),h.useEffect(()=>{(async()=>{var o;if(!y){x("error_report_id_missing","error"),p("/report-list");return}try{const a=await oe(y),s={header:{date:a.date?new Date(a.date).toISOString().split("T")[0]:new Date().toISOString().split("T")[0],author_id:((o=a.technician_id)==null?void 0:o._id)||a.technician_id||(r==null?void 0:r._id)||"",status:a.status||"DRAFT",lunch_location:a.lunch_location||""},activities:(a.activities||[]).map(i=>{var n,l,c;return{...i,_id:i._id||"hash_"+Math.random().toString(36).substr(2,9),client_id:i.client_id||"",worksite_id:i.worksite_id||"",completed:i.completed||!1,travel_time_hours:i.travel_time_hours||0,travel_time:i.travel_time||0,work_time:i.work_time||0,valid_travel_time:i.valid_travel_time==="rules"&&i.travel_time_rules_applied?"rules":"manual",travel_time_rules_applied:i.travel_time_rules_applied,intervention_type:{da_preventivo:((n=i.intervention_type)==null?void 0:n.da_preventivo)||!1,in_economia:((l=i.intervention_type)==null?void 0:l.in_economia)||!1,sopralluogo:((c=i.intervention_type)==null?void 0:c.sopralluogo)||!1},assigned_technician_id:i.assigned_technician_id||(r==null?void 0:r._id)||"",tasks:(i.tasks||[]).map(d=>{var _,u,f;return{...d,assigned_technician_ids:d.assigned_technician_ids||(r!=null&&r._id?[r._id]:[]),work_hours:d.work_hours||0,task_description:d.task_description||"",intervention_type:{da_preventivo:((_=d.intervention_type)==null?void 0:_.da_preventivo)||!1,in_economia:((u=d.intervention_type)==null?void 0:u.in_economia)||!1,sopralluogo:((f=d.intervention_type)==null?void 0:f.sopralluogo)||!1},materials_used:d.materials_used||[],material_unloading:d.material_unloading||!1,material_unloading_hours:d.material_unloading_hours||0}})}})};v(s)}catch(a){const s=a instanceof Error?a.message:"An error occurred";x(s,"error"),p("/report-list")}})()},[y,r==null?void 0:r._id,p]),h.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(b))},[b]),h.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const U=t=>{const{name:o,value:a}=t.target;v(s=>s.header?{...s,header:{...s.header,[o]:a}}:s)},T=(t,o,a)=>{const s=o.split("."),i={...t};let n=i;for(let c=0;c<s.length-1;c++){const d=s[c],_=d.match(/(\w+)\[(\d+)\]/);if(_){const u=_[1],f=parseInt(_[2],10);n[u]||(n[u]=[]),n[u]=[...n[u]],n[u][f]||(n[u][f]={}),n[u][f]={...n[u][f]},n=n[u][f]}else n[d]||(n[d]={}),n[d]={...n[d]},n=n[d]}const l=s[s.length-1];return n[l]=a,i},j=(t,o,a)=>{v(s=>{const i=s.activities?[...s.activities]:[],n=i[t],l=T(n,o,a);return i[t]=l,{...s,activities:i}})},$=()=>{v(t=>{const o={_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},assigned_technician_id:(r==null?void 0:r._id)||"",tasks:[{assigned_technician_ids:r!=null&&r._id?[r._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0}]};return{...t,activities:[...t.activities||[],o]}})},z=t=>{v(o=>{var s;const a=(s=o.activities)==null?void 0:s.filter((i,n)=>n!==t);return{...o,activities:a}})},W=t=>{v(o=>{const a=o.activities?[...o.activities]:[],s=a[t],i={assigned_technician_ids:r!=null&&r._id?[r._id]:[],work_hours:0,task_description:"",intervention_type:{da_preventivo:!1,in_economia:!1,sopralluogo:!1},materials_used:[],material_unloading:!1,material_unloading_hours:0};return s.tasks=[...s.tasks,i],a[t]=s,{...o,activities:a}})},B=(t,o)=>{v(a=>{const s=a.activities?[...a.activities]:[],i=s[t];return i.tasks=i.tasks.filter((n,l)=>l!==o),s[t]=i,{...a,activities:s}})},C=(t,o)=>{v(a=>{const s=a.activities?[...a.activities]:[],i=s[t],n=i.tasks[o],l={product_id:"",quantity:0,unit_price:0};return n.materials_used=[...n.materials_used,l],i.tasks[o]=n,s[t]=i,{...a,activities:s}})},M=(t,o,a)=>{v(s=>{const i=s.activities?[...s.activities]:[],n={...i[t]},l={...n.tasks[o]};return l.materials_used=l.materials_used.filter((c,d)=>d!==a),n.tasks[o]=l,i[t]=n,{...s,activities:i}})},S=async t=>{var i,n,l;if(t.preventDefault(),!y){x(m("error_report_id_missing"),"error");return}const o=g();if(Object.keys(o).length>0){const c=Object.values(o),_=c.slice(0,3).join(", "),u=c.length>3?` e altri ${c.length-3} errori`:"";x(`Errore di validazione: ${_}${u}`,"error");return}if(!w()&&!window.confirm(m("proceed_without_material_message")))return;const s={...b,activities:(b.activities||[]).map(c=>({...c,tasks:c.tasks.map(d=>{const _={...d,materials_used:(d.materials_used||[]).filter(u=>u.product_id)};return _.intervention_status===""&&(_.intervention_status=void 0),_.payment_status===""&&(_.payment_status=void 0),_})}))};E(!0);try{const c=await le(y,s);if(c&&c._id)x(m("report_updated_successfully"),"success"),p(`/reports/${c._id}?action=report_updated_successfully`);else throw new Error("Updated report ID not found")}catch(c){if(((i=c.response)==null?void 0:i.status)===400&&((l=(n=c.response)==null?void 0:n.data)==null?void 0:l.error)==="Validation Error"){const d=c.response.data.details,_=Object.values(d),f=_.slice(0,3).join(", "),G=_.length>3?` e altri ${_.length-3} errori`:"";x(`Errore di validazione server: ${f}${G}`,"error")}else x(m("error_updating_report"),"error")}finally{E(!1)}},w=()=>{var t;return((t=b.activities)==null?void 0:t.some(o=>{var a;return(a=o.tasks)==null?void 0:a.some(s=>{var i;return(i=s.materials_used)==null?void 0:i.some(n=>n.product_id&&n.quantity>=1)})}))||!1},g=()=>{const t={},{header:o,activities:a}=b;if(o){if(!(a!=null&&a.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return o.date||(t["header.date"]=m("date_required")),o.author_id||(t["header.author_id"]=m("author_required")),o.status||(t["header.status"]=m("status_required")),o.lunch_location||(t["header.lunch_location"]=m("lunch_location_required")),a.forEach((s,i)=>{if(s.client_id||(t[`activities[${i}].client_id`]=m("client_required")),s.worksite_id||(t[`activities[${i}].worksite_id`]=m("worksite_required")),s.valid_travel_time==="manual")(!s.travel_time_hours||s.travel_time_hours<=0)&&(t[`activities[${i}].travel_time_hours`]=m("invalid_travel_time_hours"));else if(s.valid_travel_time==="rules")if(!s.travel_time_rules_applied)t[`activities[${i}].travel_time_rules_applied`]=m("travel_time_rules_required");else{const{distance_km:n,travel_time_hours:l}=s.travel_time_rules_applied;(n<=0||l<=0)&&(t[`activities[${i}].travel_time_rules_applied`]=m("invalid_travel_time_rules"))}s.tasks.forEach((n,l)=>{(!n.task_description||n.task_description.trim()==="")&&(t[`activities[${i}].tasks[${l}].task_description`]=m("task_description_required")),n.work_hours<=0&&(t[`activities[${i}].tasks[${l}].work_hours`]=m("invalid_work_hours")),!n.intervention_type.da_preventivo&&!n.intervention_type.in_economia&&!n.intervention_type.sopralluogo&&(t[`activities[${i}].tasks[${l}].intervention_type`]=m("intervention_type_required")),n.materials_used.forEach((c,d)=>{c.product_id&&c.quantity<1&&(t[`activities[${i}].tasks[${l}].materials_used[${d}].quantity`]=m("invalid_material_quantity"))})})}),t};return{formData:b,clients:N,worksites:k,products:q,users:O,isLoading:L,isSaving:H,handleHeaderChange:U,handleActivityChange:j,handleSubmit:S,appendActivity:$,removeActivity:z,appendTask:W,removeTask:B,appendMaterial:C,removeMaterial:M,validateForm:g,checkIfHasMaterials:w}},Te=()=>{var C,M,S,w;const{t:r}=K(),{id:x}=V(),y=X(),{formData:p,clients:m,worksites:b,products:v,users:N,isLoading:F,isSaving:k,handleHeaderChange:R,handleActivityChange:q,handleSubmit:P,appendActivity:O,removeActivity:A,appendTask:L,removeTask:D,appendMaterial:H,removeMaterial:E}=he(),[U,T]=h.useState(!1),[j,$]=h.useState(0),z=h.useRef([]),W=()=>{T(!0)},B=g=>{$(g)};return F?e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-6",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(Y,{className:"text-lg text-blue-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:r("edit_report")})]}),e.jsx(Z,{})]})}):e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg",children:e.jsx(Y,{className:"text-2xl text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:r("edit_report")}),e.jsx("p",{className:"text-gray-600 mt-1",children:r("edit_report_description","Modify existing report details and activities")})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-orange-100 p-2 rounded-lg",children:e.jsx(ee,{className:"text-lg text-orange-600"})}),e.jsx("span",{className:"text-sm font-medium text-orange-700",children:r("edit_mode")})]})]})}),e.jsx("div",{className:"mb-6",children:e.jsxs("button",{onClick:()=>y("/report-list"),className:"inline-flex items-center space-x-2 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:border-gray-400 transition-colors duration-200",children:[e.jsx(te,{className:"text-sm"}),e.jsx("span",{className:"font-medium",children:r("back_to_list")})]})}),e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[e.jsxs("section",{className:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 border-b border-gray-200 px-6 py-4",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r("report_header")})}),e.jsx("div",{className:"p-6",children:e.jsx(_e,{formData:p.header||{date:new Date().toISOString().split("T")[0],author_id:"",status:"DRAFT",lunch_location:""},users:N,handleChange:R})})]}),e.jsxs("section",{className:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r("activities")}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:r("manage_your_activities","Manage your work activities and tasks")})]}),e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("button",{type:"button",className:"inline-flex items-center space-x-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors duration-200",onClick:()=>{O(),setTimeout(()=>{var g;$(((g=p.activities)==null?void 0:g.length)||0)},0)},children:[e.jsx(se,{className:"text-sm"}),e.jsx("span",{children:r("add_activity")})]})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsx(ie,{className:"text-lg text-gray-600"}),e.jsx("h3",{className:"text-base font-medium text-gray-700",children:r("activity_navigation","Activity Navigation")})]}),e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:(C=p.activities)==null?void 0:C.map((g,t)=>e.jsxs("button",{type:"button",className:`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 ${t===j?"bg-blue-600 text-white shadow-sm":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400"}`,onClick:()=>B(t),children:[r("activity")," ",t+1]},t))})]}),e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-6",children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:"flex transition-transform duration-300 ease-in-out",style:{transform:`translateX(-${j*100}%)`},children:(M=p.activities)==null?void 0:M.map((g,t)=>e.jsx("div",{className:"w-full flex-shrink-0",ref:o=>z.current[t]=o,children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:[r("activity")," ",t+1]}),p.activities&&p.activities.length>1&&e.jsx("button",{type:"button",onClick:()=>A(t),className:"text-red-600 hover:text-red-800 text-sm font-medium hover:underline",children:r("remove_activity")})]}),e.jsx(ue,{activity:g,index:t,clients:m,worksites:b,products:v,users:N,handleActivityChange:(o,a,s)=>{q(o,a,s)},removeActivity:A,appendTask:(o,a)=>{o.preventDefault(),L(a)},removeTask:D,appendMaterial:(o,a,s)=>{o.preventDefault(),H(a,s)},removeMaterial:E})]})},t))})})})]})]}),e.jsx("section",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-6",children:e.jsx("div",{className:"flex justify-end",children:e.jsx(me,{content:r("update_report_tooltip"),children:e.jsxs("button",{type:"submit",disabled:k,className:"inline-flex items-center space-x-2 px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium rounded-md transition-colors duration-200",children:[e.jsx(re,{className:"text-sm"}),e.jsx("span",{children:r(k?"updating":"update_report")})]})})})}),U&&e.jsx(pe,{report:p,onClose:()=>T(!1)})]}),p.activities&&p.activities.length>0&&e.jsxs("div",{className:"fixed bottom-6 left-6 bg-white border border-gray-200 rounded-lg shadow-lg p-4 z-50",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("div",{className:"bg-blue-100 p-2 rounded-lg",children:e.jsx(J,{className:"text-sm text-blue-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[r("current_activity","Current Activity"),": ",j+1]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[r("tasks","Tasks"),": ",((w=(S=p.activities[j])==null?void 0:S.tasks)==null?void 0:w.length)||0]})]})]}),e.jsxs("button",{type:"button",onClick:W,className:"w-full inline-flex items-center justify-center space-x-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors duration-200",children:[e.jsx(J,{className:"text-xs"}),e.jsx("span",{children:r("preview")})]})]})]})};export{Te as default};
