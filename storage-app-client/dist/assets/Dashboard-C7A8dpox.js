import{u as L,j as e,F as N,a as D,b as R,c as S,d as E,e as O,f as A,g as P,h as W}from"./index-BT8qgM4o.js";import{r as d}from"./vendor-8AKiDlQN.js";import{g as J}from"./reportService-B371uuyd.js";import{g as V}from"./clientService-sudZ8bLR.js";import{g as _}from"./usersService-CqhLcM0Y.js";import{g as q}from"./worksiteService-BcbmFES_.js";import"./router-BmsaeIqg.js";import"./api-CZ7u_KBj.js";const se=()=>{const{t:Y}=L(),[s,M]=d.useState(null),[k,$]=d.useState(!0),[t,m]=d.useState(null),[x,y]=d.useState(!1),[f,v]=d.useState(null),[T,h]=d.useState(!1),[j,u]=d.useState(null);d.useEffect(()=>{C()},[]);const z=(a,r)=>{u({message:a,type:r}),setTimeout(()=>u(null),5e3)},C=async()=>{try{const[a,r,c,i]=await Promise.all([J(),V(),_(),q()]),l=new Date,n=new Date(l.getFullYear(),l.getMonth(),1),g=new Date(l.getFullYear(),l.getMonth()-1,1),F=a.filter(o=>new Date(o.date)>=n).length,I=a.filter(o=>{const p=new Date(o.date);return p>=g&&p<n}).length;M({totalReports:a.length,totalClients:r.clients?r.clients.length:r.data?r.data.length:0,totalUsers:c.users?c.users.length:c.data?c.data.length:0,totalWorksites:i.worksites?i.worksites.length:i.data?i.data.length:0,reportsThisMonth:F,reportsLastMonth:I});const w=localStorage.getItem("dashboard_analysis");if(w)try{const o=JSON.parse(w),p=new Date(o.lastUpdated),U=new Date(Date.now()-24*60*60*1e3);if(p>U){m(o);return}}catch(o){console.error("Error parsing cached analysis:",o)}b()}catch(a){console.error("Error fetching dashboard data:",a)}finally{$(!1)}},b=async(a=!1)=>{if(!s)return;const r=`dashboard_analysis_${JSON.stringify(s)}`,c=localStorage.getItem(r);if(!a&&c)try{const i=JSON.parse(c),l=new Date(i.lastUpdated),n=new Date(Date.now()-24*60*60*1e3);if(l>n){m(i);return}}catch(i){console.error("Error parsing cached analysis:",i)}y(!0),v(null);try{const i={metrics:{totalClients:s.totalClients,totalUsers:s.totalUsers,adminRatio:.2,totalProducts:0,averageProductPrice:0,totalWorksites:s.totalWorksites,activeWorksitesRatio:.8,totalReports:s.totalReports,completionRate:.7},context:`Dashboard analysis for ${new Date().toLocaleDateString("it-IT")}`},l=await fetch("http://termoparotto.micro-cloud.it:16788/api/ai/analyze-dashboard",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const n=await l.json(),g={summary:n.summary||"Analisi non disponibile",insights:n.insights||[],recommendations:n.recommendations||[],trends:n.trends||[],lastUpdated:new Date().toISOString(),source:"deepseek"};m(g),localStorage.setItem(r,JSON.stringify(g)),z("Analisi AI completata con successo!","success")}catch(i){console.error("Error analyzing dashboard data:",i),v("Errore durante l'analisi AI. Riprova piÃ¹ tardi.");const l={summary:`Dashboard con ${s.totalReports} rapporti, ${s.totalClients} clienti, ${s.totalUsers} utenti e ${s.totalWorksites} cantieri. ${s.reportsThisMonth} rapporti questo mese.`,insights:[`Gestione di ${s.totalReports} rapporti totali`,`${s.totalClients} clienti attivi`,`${s.totalUsers} utenti nel sistema`,`${s.totalWorksites} cantieri operativi`],recommendations:["Monitora regolarmente i rapporti mensili","Verifica la distribuzione dei carichi di lavoro","Analizza le tendenze dei cantieri"],trends:[`Rapporti questo mese: ${s.reportsThisMonth}`,`Rapporti scorso mese: ${s.reportsLastMonth}`,`Variazione: ${s.reportsThisMonth-s.reportsLastMonth>0?"+":""}${s.reportsThisMonth-s.reportsLastMonth}`],lastUpdated:new Date().toISOString(),source:"local"};m(l),localStorage.setItem(r,JSON.stringify(l))}finally{y(!1)}};return k?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"animate-spin text-4xl text-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Caricamento dashboard..."})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[j&&e.jsx("div",{className:`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${j.type==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:j.message}),e.jsx("button",{onClick:()=>u(null),className:"ml-4 text-white hover:text-gray-200 focus:outline-none",children:"âœ•"})]})}),e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Dashboard"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Panoramica generale del sistema"})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-3 shadow-sm",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(D,{className:"text-xl text-indigo-600"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-indigo-800 text-sm",children:"Analisi AI Dashboard"}),e.jsx("p",{className:"text-xs text-indigo-600",children:t?`Ultimo aggiornamento: ${new Date(t.lastUpdated).toLocaleDateString("it-IT")}`:"Nessuna analisi disponibile"})]}),t&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-indigo-600 text-sm",children:"ðŸ“Š"}),e.jsx("span",{className:"text-xs text-indigo-700 font-medium",children:"Analisi Disponibile"}),e.jsx("span",{className:"text-xs text-indigo-500 bg-indigo-100 px-2 py-1 rounded-full",children:t.source==="deepseek"?"DeepSeek AI":"Locale"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[t&&e.jsxs("button",{onClick:()=>h(!0),className:"px-2 py-1.5 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors flex items-center space-x-1",children:[e.jsx(R,{className:"text-indigo-600 text-xs"}),e.jsx("span",{children:"Visualizza"})]}),e.jsx("button",{onClick:()=>b(!!t),disabled:x,className:`px-3 py-1.5 text-xs rounded font-medium transition-all duration-200 ${x?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-md"}`,children:x?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"inline animate-spin mr-1"}),"Analizzando..."]}):t?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"inline mr-1"}),"Aggiorna"]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"inline mr-1"}),"Inizia"]})})]})]})}),f&&e.jsx("div",{className:"mt-2 bg-red-50 border border-red-200 rounded-lg p-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"text-red-600 mr-2",children:"âŒ"}),e.jsx("p",{className:"text-red-800 text-xs font-medium",children:f})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(O,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Rapporti Totali"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:(s==null?void 0:s.totalReports)||0})]})]})}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(A,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Clienti"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:(s==null?void 0:s.totalClients)||0})]})]})}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(A,{className:"text-purple-600 text-xl"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Utenti"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:(s==null?void 0:s.totalUsers)||0})]})]})}),e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 bg-orange-100 rounded-lg",children:e.jsx(P,{className:"text-orange-600 text-xl"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Cantieri"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:(s==null?void 0:s.totalWorksites)||0})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Rapporti Mensili"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Questo mese:"}),e.jsx("span",{className:"text-lg font-semibold text-blue-600",children:(s==null?void 0:s.reportsThisMonth)||0})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Scorso mese:"}),e.jsx("span",{className:"text-lg font-semibold text-gray-600",children:(s==null?void 0:s.reportsLastMonth)||0})]}),e.jsx("div",{className:"pt-2 border-t border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Variazione:"}),e.jsxs("span",{className:`text-sm font-medium ${((s==null?void 0:s.reportsThisMonth)||0)-((s==null?void 0:s.reportsLastMonth)||0)>=0?"text-green-600":"text-red-600"}`,children:[((s==null?void 0:s.reportsThisMonth)||0)-((s==null?void 0:s.reportsLastMonth)||0)>=0?"+":"",((s==null?void 0:s.reportsThisMonth)||0)-((s==null?void 0:s.reportsLastMonth)||0)]})]})})]})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Sistema"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Versione:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:"1.0.0"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Stato:"}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Operativo"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Ultimo aggiornamento:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:new Date().toLocaleDateString("it-IT")})]})]})]})]})]}),T&&t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:()=>h(!1),children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 rounded-t-xl",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(D,{className:"text-2xl text-white"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Analisi AI Dashboard"}),e.jsxs("p",{className:"text-indigo-100 text-sm",children:["Ultimo aggiornamento: ",new Date(t.lastUpdated).toLocaleDateString("it-IT")]})]})]}),e.jsx("button",{onClick:()=>h(!1),className:"text-white hover:text-indigo-200 transition-colors",children:e.jsx(W,{className:"text-xl"})})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-blue-800 mb-2",children:"Riepilogo"}),e.jsx("p",{className:"text-blue-700",children:t.summary})]}),t.insights&&t.insights.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"Insights"}),e.jsx("ul",{className:"space-y-2",children:t.insights.map((a,r)=>e.jsxs("li",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"text-blue-500 mt-1",children:"â€¢"}),e.jsx("span",{className:"text-gray-700 text-sm",children:a})]},r))})]}),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"Raccomandazioni"}),e.jsx("ul",{className:"space-y-2",children:t.recommendations.map((a,r)=>e.jsxs("li",{className:"flex items-start space-x-2",children:[e.jsx("span",{className:"text-green-500 mt-1",children:"â€¢"}),e.jsx("span",{className:"text-gray-700 text-sm",children:a})]},r))})]})]}),t.trends&&t.trends.length>0&&e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"Tendenze"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:t.trends.map((a,r)=>e.jsx("div",{className:"text-center p-3 bg-gray-50 rounded-lg",children:e.jsx("p",{className:"text-gray-700 text-sm",children:a})},r))})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Fonte:"}),e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${t.source==="deepseek"?"bg-indigo-100 text-indigo-800":"bg-gray-100 text-gray-800"}`,children:t.source==="deepseek"?"DeepSeek AI":"Analisi Locale"})]}),e.jsx("button",{onClick:()=>{h(!1),b(!0)},disabled:x,className:`px-4 py-2 rounded-lg font-medium transition-colors ${x?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-indigo-600 text-white hover:bg-indigo-700"}`,children:x?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"inline animate-spin mr-2"}),"Aggiornando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"inline mr-2"}),"Aggiorna Analisi"]})})]})]})]})})]})};export{se as default};
