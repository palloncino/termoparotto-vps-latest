import{r as c,c as W}from"./index-B-c2xMjC.js";import{a as b}from"./clientService-Bj64bQzW.js";import{a as F}from"./productsService-CtlFfOUs.js";import{r as R}from"./index-CgcmPbWG.js";import{a as j}from"./usersService-D84MQp6X.js";import{a as L}from"./worksiteService-CfPHAhQs.js";function J(u){const _={day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1},r=typeof u=="string"?new Date(u):u;return new Intl.DateTimeFormat("en-GB",_).format(r)}const M=(u,_)=>{const[r,d]=c.useState(u||{activities:[{client_id:"",worksite_id:"",description:"",travel_time:0,work_time:0,materials_used:[{product_id:"",quantity:0}],completed:!1,intervention_type:"economia",assigned_technician_id:""}],date:"",technician_id:"",short_description:"",status:"",lunch_location:""}),[m,p]=c.useState([]),[h,g]=c.useState([]),[a,o]=c.useState([]),[k,y]=c.useState([]),[q,v]=c.useState(!0),[D,f]=c.useState(null),E=W();c.useEffect(()=>{(async()=>{v(!0);try{const[e,s,i,n]=await Promise.all([b(),L(),F(),j()]);g(s),p(e.clients),o(i.products),y(n.users),f(null)}catch(e){f("Failed to fetch data. Please try again later."),console.error("Error fetching data:",e)}finally{v(!1)}})()},[]),c.useEffect(()=>{_&&_(r)},[r,_]);const B=t=>{const{name:e,value:s}=t.target;d(i=>({...i,[e]:s}))},I=(t,e,s)=>{const{name:i,value:n}=e.target,l=[...r.activities];s!==void 0?l[t].materials_used[s]={...l[t].materials_used[s],[i]:n}:l[t]={...l[t],[i]:n},d(U=>({...U,activities:l}))},P=()=>{d(t=>({...t,activities:[...t.activities,{client_id:"",worksite_id:"",description:"",travel_time:0,work_time:0,materials_used:[{product_id:"",quantity:0}],completed:!1,intervention_type:"economia",assigned_technician_id:""}]}))},S=t=>{const e=[...r.activities];e[t].materials_used.push({product_id:"",quantity:0}),d(s=>({...s,activities:e}))},$=(t,e)=>{const s=[...r.activities];s[t].materials_used=s[t].materials_used.filter((i,n)=>n!==e),d(i=>({...i,activities:s}))},A=async t=>{t.preventDefault();const e=w();if(Object.keys(e).length>0)return;const s={...r};s.activities.forEach(i=>{i.client_id=i.client_id||null,i.worksite_id=i.worksite_id||null,i.assigned_technician_id=i.assigned_technician_id||null,i.materials_used.forEach(n=>{n.product_id=n.product_id||null})});try{const i=await R(s);if(i&&i._id)E(`/reports/${i._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(i){console.error("Error creating report:",i),f("Error creating report. Please try again later.")}},C=t=>{d(e=>({...e,activities:e.activities.filter((s,i)=>i!==t)}))},w=()=>{const t={};return r.date||(t.date="date_required"),r.technician_id||(t.technician_id="technician_required"),r.lunch_location||(t.lunch_location="lunch_location_required"),r.status||(t.status="status_required"),r.short_description||(t.short_description="short_description_required"),r.activities.forEach((e,s)=>{e.client_id||(t[`activities[${s}].client_id`]="client_required"),e.worksite_id||(t[`activities[${s}].worksite_id`]="worksite_required"),e.description||(t[`activities[${s}].description`]="description_required"),e.assigned_technician_id||(t[`activities[${s}].assigned_technician_id`]="assigned_technician_required"),(e.travel_time===void 0||e.travel_time<0)&&(t[`activities[${s}].travel_time`]="invalid_travel_time"),(e.work_time===void 0||e.work_time<0)&&(t[`activities[${s}].work_time`]="invalid_work_time")}),t};return{formData:r,clients:m,worksites:h,products:a,users:k,isLoading:q,error:D,handleChange:B,handleActivityChange:I,handleSubmit:A,appendActivity:P,removeActivity:C,validateForm:w,appendMaterial:S,removeMaterial:$}},K=()=>{const{clients:u,worksites:_,products:r,users:d}=M();return{getClientById:a=>u.find(o=>o._id===a),getWorksiteById:a=>_.find(o=>o._id===a),getProductById:a=>r.find(o=>o._id===a),getUserById:a=>d.find(o=>o._id===a)}};export{M as a,J as f,K as u};
