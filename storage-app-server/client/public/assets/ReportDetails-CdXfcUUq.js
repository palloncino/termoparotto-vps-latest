import{g as z,r as g,u as H,h as J,a4 as K,k as Q,j as e,a5 as V,a6 as W,a7 as G,a8 as X,d as Z,a9 as I}from"./index-thHJPYf9.js";import{a as ee}from"./clientService-DWml5I6n.js";import{a as se}from"./productsService-DJ1x3sK0.js";import{c as te}from"./reportService-C5rT5Bns.js";import{a as ie}from"./usersService-CqL3O9jo.js";import{a as re}from"./worksiteService-Bsvx2crQ.js";import{a as ae}from"./formatDate-CFXLpRQ8.js";const ne=()=>{const{user:d}=z(),[s,m]=g.useState({header:{date:new Date().toISOString().split("T")[0],author_id:d._id,head_description:"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:d._id||"",tasks:[{assigned_technician_ids:[d._id],work_hours:0,task_description:"",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}]}]}),[y,h]=g.useState([]),[$,D]=g.useState([]),[E,x]=g.useState([]),[p,B]=g.useState([]),[c,N]=g.useState(!0),[A,b]=g.useState(null),{t:l}=H(),P=J();g.useEffect(()=>{(async()=>{N(!0);try{const[r,n,i,o]=await Promise.all([ee(),re(),se(1,{searchText:"",type:""}),ie()]);h(r.clients),x(i.products),B(o.users),D(n),b(null)}catch(r){b(r instanceof Error?r.message:"An error occurred")}finally{N(!1)}})()},[]),g.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(s))},[s]),g.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const C=t=>{const{name:r,value:n}=t.target;m(i=>i.header?{...i,header:{...i.header,[r]:n}}:i)},u=(t,r,n)=>{const i=r.split("."),o={...t};let a=o;for(let j=0;j<i.length-1;j++){const f=i[j],U=f.match(/(\w+)\[(\d+)\]/);if(U){const v=U[1],q=parseInt(U[2],10);a[v]||(a[v]=[]),a[v]=[...a[v]],a[v][q]||(a[v][q]={}),a[v][q]={...a[v][q]},a=a[v][q]}else a[f]||(a[f]={}),a[f]={...a[f]},a=a[f]}const _=i[i.length-1];return a[_]=n,o},k=(t,r,n)=>{console.log("[handleActivityChange]",{activityIndex:t,fieldPath:r,value:n}),m(i=>{const o=i.activities?[...i.activities]:[],a=o[t],_=u(a,r,n);return o[t]=_,{...i,activities:o}})},F=()=>{m(t=>({...t,activities:[...t.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:d._id||"",tasks:[]}]}))},T=t=>{m(r=>{var n;return{...r,activities:(n=r.activities)==null?void 0:n.filter((i,o)=>o!==t)}})},w=t=>{m(r=>{console.log(1.1,{prevState:r});const n=r.activities?[...r.activities]:[],i={...n[t]};return i.tasks=[...i.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}],n[t]=i,console.log(1.2,{newState:{...r,activities:n}}),{...r,activities:n}})},L=(t,r)=>{m(n=>{const i=n.activities?[...n.activities]:[],o={...i[t]};return o.tasks=o.tasks.filter((a,_)=>_!==r),i[t]=o,{...n,activities:i}})},O=(t,r)=>{m(n=>{const i=n.activities?[...n.activities]:[],o={...i[t]},a={...o.tasks[r]};return a.materials_used=[...a.materials_used||[],{product_id:"",quantity:0}],o.tasks[r]=a,i[t]=o,{...n,activities:i}})},S=(t,r,n)=>{m(i=>{const o=i.activities?[...i.activities]:[],a={...o[t]},_={...a.tasks[r]};return _.materials_used=_.materials_used.filter((j,f)=>f!==n),a.tasks[r]=_,o[t]=a,{...i,activities:o}})},Y=async t=>{t.preventDefault();const r=R();if(Object.keys(r).length>0){console.log("Validation Errors:",r);return}try{const n=await te(s);if(n&&n._id)P(`/reports/${n._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(n){console.error("Error creating report:",n),b(l("error_creating_report"))}},R=()=>{const t={},{header:r,activities:n}=s;if(r){if(!(n!=null&&n.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return r.date||(t["header.date"]=l("date_required")),r.author_id||(t["header.author_id"]=l("author_required")),r.head_description||(t["header.head_description"]=l("head_description_required")),r.status||(t["header.status"]=l("status_required")),r.lunch_location||(t["header.lunch_location"]=l("lunch_location_required")),(!r.head_description||r.head_description.trim()==="")&&(t["header.short_description"]=l("short_description_required")),n.forEach((i,o)=>{if(i.client_id||(t[`activities[${o}].client_id`]=l("client_required")),i.worksite_id||(t[`activities[${o}].worksite_id`]=l("worksite_required")),i.activity_description||(t[`activities[${o}].activity_description`]=l("activity_description_required")),i.valid_travel_time==="manual")i.travel_time_hours<=0&&(t[`activities[${o}].travel_time_hours`]=l("invalid_travel_time_hours"));else if(i.valid_travel_time==="rules")if(!i.travel_time_rules_applied)t[`activities[${o}].travel_time_rules_applied`]=l("travel_time_rules_required");else{const{distance_km:a,travel_time_hours:_}=i.travel_time_rules_applied;(a<=0||_<=0)&&(t[`activities[${o}].travel_time_rules_applied`]=l("invalid_travel_time_rules"))}i.tasks.forEach((a,_)=>{(!a.task_description||a.task_description.trim()==="")&&(t[`activities[${o}].tasks[${_}].task_description`]=l("task_description_required")),a.work_hours<=0&&(t[`activities[${o}].tasks[${_}].work_hours`]=l("invalid_work_hours")),!a.intervention_type.to_quote&&!a.intervention_type.in_economy&&!a.intervention_type.site_inspection&&(t[`activities[${o}].tasks[${_}].intervention_type`]=l("intervention_type_required")),a.materials_used.forEach((j,f)=>{j.product_id||(t[`activities[${o}].tasks[${_}].materials_used[${f}].product_id`]=l("product_id_required")),j.quantity<=0&&(t[`activities[${o}].tasks[${_}].materials_used[${f}].quantity`]=l("invalid_material_quantity"))})})}),t};return{formData:s,clients:y,worksites:$,products:E,users:p,isLoading:c,error:A,handleHeaderChange:C,handleActivityChange:k,handleSubmit:Y,appendActivity:F,removeActivity:T,appendTask:w,removeTask:L,appendMaterial:O,removeMaterial:S,validateForm:R}};function M(d,s){const m=Math.floor(d),y=Math.round((d-m)*60);let h="";return m>0&&(h+=`${m} ${s(m===1?"hour":"hours")}`),y>0&&(h&&(h+=" "),h+=`${y} ${s(y===1?"minute":"minutes")}`),h||(h=s("no_time")),h}const oe=()=>{const{clients:d,worksites:s,products:m,users:y}=ne();return{getClientById:x=>d.find(p=>p._id===x),getWorksiteById:x=>s.find(p=>p._id===x),getProductById:x=>m.find(p=>p._id===x),getUserById:x=>y.find(p=>p._id===x)}},xe=({report:d})=>{const{t:s}=H(),m=K(),{showFlashMessage:y}=Q(),{getClientById:h,getWorksiteById:$,getProductById:D,getUserById:E}=oe();g.useEffect(()=>{new URLSearchParams(m.search).get("action")==="report_created_successfully"&&y(s("report_created_successfully"),"success")},[m,y,s]);const x=c=>c.completed?e.jsx(Z,{className:"text-green-500 text-2xl"}):e.jsx(I,{className:"text-yellow-500 text-2xl"}),p=typeof d.technician_id=="object"&&d.technician_id!==null?d.technician_id.name:"",B=d.activities||[];return e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:s("report_details")}),e.jsx("p",{className:"text-gray-600",children:d.date?ae(d.date,s):""})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("dl",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("technician")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:p||s("not_assigned")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("status")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:d.status?s(d.status):s("not_specified")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("short_description")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:d.short_description||s("no_description")})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:s("activities")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:B.map((c,N)=>{var C;const A=h(c.client_id),b=$(c.worksite_id),l=E(c.assigned_technician_id),P=((C=c.tasks)==null?void 0:C.reduce((u,k)=>u+(k.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[s("activity")," ",N+1]}),x(c)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("client")}),e.jsx("a",{href:`/clients/${c.client_id}`,className:"text-blue-600 hover:underline",children:A?A.name:s("unknown_client")})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("worksite")}),e.jsx("a",{href:`/worksites/${c.worksite_id}`,className:"text-blue-600 hover:underline",children:b?b.name:s("unknown_worksite")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(V,{className:"inline-block text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-600",children:c.activity_description||s("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(W,{className:"inline-block text-blue-500 mr-2"}),e.jsxs("span",{className:"text-gray-600",children:[s("work_time"),": ",M(P,s)," ",s("hours")]})]}),e.jsx("div",{children:e.jsxs("span",{className:"text-gray-600",children:[s("travel_time"),": ",M(c.travel_time_hours||0,s)," ",s("hours")]})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("intervention_type")}),c.intervention_type?e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),c.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!c.intervention_type.to_quote&&!c.intervention_type.in_economy&&!c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]}):e.jsx("p",{className:"text-gray-600",children:s("not_specified")})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("assigned_technician")}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(G,{className:"inline-block text-blue-500 mr-2"}),e.jsx("p",{children:l?l.name:s("not_assigned")})]})]}),c.tasks&&c.tasks.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:s("tasks")}),c.tasks.map((u,k)=>e.jsxs("div",{className:"mb-4 p-4 bg-white rounded shadow-sm",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:u.task_description||s("no_description")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(W,{className:"inline-block text-gray-500 mr-1"}),s("work_hours"),": ",M(u.work_hours||0,s)]}),u.intervention_type&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h6",{className:"text-xs font-semibold text-gray-500",children:s("intervention_type")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[u.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),u.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!u.intervention_type.to_quote&&!u.intervention_type.in_economy&&!u.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]})]}),u.materials_used&&u.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold text-gray-700",children:s("materials_used")}),e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-xs font-semibold text-gray-600",children:s("Quantity")})]})}),e.jsx("tbody",{children:u.materials_used.map((F,T)=>{const w=D(F.product_id);return e.jsx("tr",{className:"border-t",children:w?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-1 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${w._id}`,children:w.codice_articolo})}),e.jsx("td",{className:"py-1 text-gray-700",children:w.descrizione_articolo}),e.jsx("td",{className:"py-1 text-right text-gray-600",children:F.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-1 text-red-600",children:s("unknown_product")})},T)})})]})]})]},k))]})]},N)})})]}),e.jsxs("div",{className:"flex items-center p-6",children:[e.jsx(X,{className:"text-blue-500 mr-2"}),e.jsxs("p",{className:"text-gray-600",children:[s("lunch_location"),": ",d.lunch_location||s("not_specified")]})]})]})};export{xe as R,M as f,ne as u};
