import{u as _,j as e,C as S,D as B,E as W,G as D,r as v,H as X,I as J}from"./index-DfDgnTih.js";import{f as V,R as K,u as Q}from"./ReportDetails-CXQB98R8.js";import{T as E}from"./Tooltip-DmofgGj_.js";const U=({activity:o,index:l,clients:c=[],worksites:n=[],products:m=[],users:p=[],handleActivityChange:i,removeActivity:g,appendTask:N,removeTask:y,appendMaterial:w,removeMaterial:k})=>{var P;const{t:a}=_(),T=s=>{const{checked:t}=s.target,r=t?"rules":"manual";console.log({newMethod:r}),i(l,"valid_travel_time",r),r==="manual"?i(l,"travel_time_rules_applied",void 0):r==="rules"&&i(l,"travel_time_hours","")},C=s=>{const t=s.target.value;if(!t){i(l,"travel_time_hours","");return}if(/^\d*[.,]?\d{0,2}$/.test(t)){const r=t.replace(",",".");i(l,"travel_time_hours",r)}},$=s=>{const t=s.target.value;if(t){const r=parseFloat(t.replace(",","."));i(l,"travel_time_hours",Number(r.toFixed(2)))}},F=s=>{const t=parseInt(s.target.value,10);let r=0;switch(t){case 15:r=.5;break;case 26:r=1;break;case 46:r=2;break;case 66:r=2.5;break;default:r=0}i(l,"travel_time_rules_applied",{distance_km:t,travel_time_hours:r,note:`Rule for ${t} km`}),i(l,"travel_time_hours",r)},R=(s,t)=>{const r=o.tasks[s].assigned_technician_ids,d=r.includes(t)?r.filter(u=>u!==t):[...r,t];i(l,`tasks[${s}].assigned_technician_ids`,d)},f=(s,t)=>{const r=t.target.value;if(!r){i(l,`tasks[${s}].work_hours`,"");return}if(/^\d*[.,]?\d{0,2}$/.test(r)){const d=r.replace(",",".");i(l,`tasks[${s}].work_hours`,d)}},q=(s,t)=>{const r=t.target.value;if(r){const d=parseFloat(r.replace(",","."));i(l,`tasks[${s}].work_hours`,Number(d.toFixed(2)))}};return e.jsxs("div",{className:"grid grid-cols-1 gap-6 bg-white rounded-lg",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900",children:[a("activity")," ",l+1]}),e.jsx(E,{content:a("remove_activity"),children:e.jsx("button",{type:"button",className:"text-red-500 hover:text-red-700 p-2 rounded-lg transition-colors",onClick:()=>g(l),children:e.jsx(S,{})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("client")}),e.jsxs("select",{className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.client_id||"",onChange:s=>i(l,"client_id",s.target.value),children:[e.jsx("option",{value:"",children:a("select_client")}),c.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("worksite")}),e.jsxs("select",{className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.worksite_id||"",onChange:s=>i(l,"worksite_id",s.target.value),children:[e.jsx("option",{value:"",children:a("select_worksite")}),n.filter(s=>s.client_id===o.client_id).map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("activity_description")}),e.jsx("textarea",{className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[100px]",value:o.activity_description,onChange:s=>i(l,"activity_description",s.target.value)})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("travel_time")}),e.jsx("div",{className:"flex items-start gap-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:`valid_travel_time_${l}`,className:"rounded border-gray-300 text-blue-500 focus:ring-blue-500",checked:o.valid_travel_time==="rules",onChange:T}),e.jsx("label",{htmlFor:`valid_travel_time_${l}`,className:"ml-2 text-sm",children:a("use_travel_time_rules")})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:`w-full ${o.valid_travel_time!=="manual"?"opacity-50 pointer-events-none":""}`,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("manual_travel_time_hours")}),e.jsx("input",{type:"text",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.travel_time_hours||"",onChange:C,onBlur:$,placeholder:a("enter_travel_time_hours")}),e.jsx("div",{className:"mt-2 text-sm text-gray-600",children:V(o.travel_time_hours||0,a)})]}),e.jsxs("div",{className:`w-full ${o.valid_travel_time!=="rules"?"opacity-50 pointer-events-none":""}`,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("travel_time_rules")}),e.jsxs("select",{className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:((P=o.travel_time_rules_applied)==null?void 0:P.distance_km)||"",onChange:F,children:[e.jsx("option",{value:"",children:a("select_distance")}),e.jsx("option",{value:"15",children:"15-25 km"}),e.jsx("option",{value:"26",children:"26-45 km"}),e.jsx("option",{value:"46",children:"46-65 km"}),e.jsx("option",{value:"66",children:"66-100 km"})]}),e.jsx("div",{className:"mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg",children:e.jsxs("ul",{className:"space-y-1",children:[e.jsx("li",{children:"• 15-25 km from headquarters → 0.5 hours travel time (e.g., Castello Tesino – Levico - Caldonazzo)"}),e.jsx("li",{children:"• 26-45 km from headquarters → 1 hour travel time (e.g., Pergine – Trento)"}),e.jsx("li",{children:"• 46-65 km from headquarters → 2 hours travel time (e.g., Rovereto)"}),e.jsx("li",{children:"• 66-100 km from headquarters → 2.5 hours travel time (e.g., Bolzano)"})]})})]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-900",children:a("tasks")}),e.jsxs("button",{type:"button",className:"bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2",onClick:s=>N(s,l),children:[e.jsx(B,{size:14}),e.jsx("span",{children:a("add_task")})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-6",children:o.tasks.map((s,t)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h5",{className:"font-semibold text-gray-900",children:[a("task")," ",t+1]}),e.jsx("button",{type:"button",className:"text-red-500 hover:text-red-700 p-2 rounded-lg transition-colors",onClick:()=>y(l,t),children:e.jsx(S,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("task_description")}),e.jsx("textarea",{className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[80px]",value:s.task_description,onChange:r=>i(l,`tasks[${t}].task_description`,r.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("work_hours")}),e.jsx("input",{type:"text",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:s.work_hours||"",onChange:r=>f(t,r),onBlur:r=>q(t,r),placeholder:a("work_hours_placeholder")}),e.jsx("div",{className:"mt-2 text-sm text-gray-600",children:(s==null?void 0:s.work_hours)&&V(s==null?void 0:s.work_hours,a)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("intervention_type")}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.intervention_type.to_quote,onChange:r=>i(l,`tasks[${t}].intervention_type.to_quote`,r.target.checked),className:"rounded border-gray-300 text-blue-500 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm",children:a("to_quote")})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.intervention_type.in_economy,onChange:r=>i(l,`tasks[${t}].intervention_type.in_economy`,r.target.checked),className:"rounded border-gray-300 text-blue-500 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm",children:a("in_economy")})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:s.intervention_type.site_inspection,onChange:r=>i(l,`tasks[${t}].intervention_type.site_inspection`,r.target.checked),className:"rounded border-gray-300 text-blue-500 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm",children:a("site_inspection")})]})]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("assigned_technicians")}),e.jsx("div",{className:"flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg",children:p.map(r=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-blue-500 focus:ring-blue-500",checked:s.assigned_technician_ids.includes(r._id),onChange:()=>R(t,r._id)}),e.jsx("span",{className:"text-sm",children:r.name})]},r._id))})]}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:a("materials")}),e.jsxs("button",{type:"button",className:"text-blue-500 hover:text-blue-700 text-sm flex items-center gap-1",onClick:r=>w(r,l,t),children:[e.jsx(B,{size:12}),e.jsx("span",{children:a("add")})]})]}),e.jsx("div",{className:"space-y-2",children:s.materials_used.map((r,d)=>e.jsxs("div",{className:"grid grid-cols-[1fr,120px,auto] gap-2",children:[e.jsxs("select",{className:"px-3 py-1 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:r.product_id||"",onChange:u=>i(l,`tasks[${t}].materials_used[${d}].product_id`,u.target.value),children:[e.jsx("option",{value:"",children:a("select_product")}),m.map(u=>e.jsx("option",{value:u._id,children:u.codice_articolo},u._id))]}),e.jsx("input",{type:"number",className:"px-3 py-1 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:r.quantity,onChange:u=>i(l,`tasks[${t}].materials_used[${d}].quantity`,parseFloat(u.target.value)),placeholder:a("qty"),min:"0",step:"0.1"}),e.jsx("button",{type:"button",className:"text-red-500 hover:text-red-700 p-1",onClick:()=>k(l,t,d),children:e.jsx(S,{size:12})})]},d))})]})]})]},t))})]})]})},Y=({report:o,onClose:l})=>{const{t:c}=_(),n=i=>{l()},m=i=>{i.stopPropagation()},p=e.jsx("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:9999},className:"flex items-center justify-center",onClick:n,children:e.jsxs("div",{className:"bg-white rounded-lg p-8 max-w-3xl w-full relative overflow-y-auto max-h-[90vh] m-4",onClick:m,children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:c("report_preview")}),e.jsx("button",{onClick:l,className:"text-gray-600 hover:text-gray-800 transition-colors",children:e.jsx(W,{})})]}),e.jsx("p",{className:"text-gray-500 italic mb-4",children:c("this_is_a_preview_of_your_report")}),e.jsx(K,{report:o})]})});return D.createPortal(p,document.body)},Z=({formData:o,users:l,handleChange:c})=>{const{t:n}=_();return e.jsxs("div",{className:"w-full",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:n("report_header")}),e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("date")}),e.jsx("input",{type:"date",name:"date",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.date,onChange:c,required:!0})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("author")}),e.jsxs("select",{name:"author_id",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.author_id,onChange:c,required:!0,children:[e.jsx("option",{value:"",children:n("select_author")}),l==null?void 0:l.map(m=>e.jsx("option",{value:m._id,children:m.name},m._id))]})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("head_description")}),e.jsx("textarea",{name:"head_description",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[100px]",value:o.head_description,onChange:c,required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("status")}),e.jsxs("select",{name:"status",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.status,onChange:c,required:!0,children:[e.jsx("option",{value:"",children:n("select_status")}),e.jsx("option",{value:"PLANNED",children:n("planned")}),e.jsx("option",{value:"IN_PROGRESS",children:n("in_progress")}),e.jsx("option",{value:"FINITO",children:n("finito")}),e.jsx("option",{value:"SOSPESO",children:n("sospeso")}),e.jsx("option",{value:"DRAFT",children:n("draft")})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("lunch_location")}),e.jsx("input",{type:"text",name:"lunch_location",className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:o.lunch_location||"",onChange:c,placeholder:n("optional")})]})]})]})]})},se=()=>{var H,M;const{t:o}=_(),{formData:l,clients:c,worksites:n,products:m,users:p,isLoading:i,error:g,handleHeaderChange:N,handleActivityChange:y,handleSubmit:w,appendActivity:k,removeActivity:a,appendTask:T,removeTask:C,appendMaterial:$,removeMaterial:F}=Q(),[R,f]=v.useState(!1),[q,P]=v.useState(!0),[s,t]=v.useState(0),r=v.useRef([]),d=()=>{f(!0)};if(g)return e.jsx("div",{className:"text-red-500",children:g});const u=l.activities[s],O=u?u.tasks.length:0,L=j=>{t(j)},G=e.jsxs("div",{className:`fixed bottom-4 left-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-50 ${q?"":"hidden"}`,style:{gap:"1rem"},children:[e.jsx("div",{className:"mb-2",children:e.jsxs("p",{className:"text-sm text-gray-700",children:[o("you_are_watching_activity")," ",s+1," ",o("with_n_tasks")," ",O]})}),e.jsx("div",{children:e.jsx(E,{content:o("preview_report_tooltip"),children:e.jsxs("button",{type:"button",className:"flex items-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded",onClick:d,children:[e.jsx(X,{className:"mr-2"}),o("preview")]})})})]});return e.jsxs("form",{onSubmit:w,className:"grid grid-cols-1 gap-6 bg-white rounded-lg p-8",children:[e.jsx("section",{className:"w-full",children:e.jsx(Z,{formData:l.header,users:p,handleChange:N})}),e.jsx("section",{className:"w-full",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-6 rounded-lg mb-6 my-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:o("activities")}),e.jsx("div",{className:"flex-grow flex items-center justify-center gap-2",children:(H=l.activities)==null?void 0:H.map((j,x)=>e.jsx("button",{type:"button",className:`h-8 min-w-[32px] px-3 rounded-full text-sm font-medium transition-colors ${x===s?"bg-blue-500 text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"}`,onClick:()=>L(x),children:x+1},x))}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 bg-white border border-blue-500 text-blue-500 hover:bg-blue-50 px-4 py-2 rounded-lg transition-colors",onClick:()=>{k(),setTimeout(()=>{t(l.activities.length)},0)},children:[e.jsx(B,{size:14}),o("add_activity")]})]}),e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:"flex transition-transform duration-500 ease-in-out",style:{transform:`translateX(-${s*100}%)`},children:(M=l.activities)==null?void 0:M.map((j,x)=>e.jsx("div",{className:"w-full flex-shrink-0",ref:h=>r.current[x]=h,children:e.jsx(U,{activity:j,index:x,clients:c,worksites:n,products:m,users:p,handleActivityChange:(h,b,z)=>{y(h,b,z)},removeActivity:a,appendTask:(h,b)=>{h.preventDefault(),T(b)},removeTask:C,appendMaterial:(h,b,z)=>{h.preventDefault(),$(b,z)},removeMaterial:F})},x))})})]})}),e.jsx("section",{className:"w-full flex justify-end gap-4",children:e.jsx(E,{content:o("submit_report_tooltip"),children:e.jsxs("button",{type:"submit",className:"flex items-center bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded",children:[e.jsx(J,{className:"mr-2"}),o("submit")]})})}),R&&e.jsx(Y,{report:l,onClose:()=>f(!1)}),D.createPortal(G,document.body)]})};export{se as R};
