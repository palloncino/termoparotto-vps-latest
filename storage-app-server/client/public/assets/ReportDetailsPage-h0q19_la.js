import{p as $,q as w,v as K,x as T,z as F,A as W,B as q,C as U,E as k,G as V,I as z,J as N,S as G,g as b,K as J,N as H,u as A,O as X,e as Y,r as Z,j as s,d as ee,a as te}from"./index-Du0vVrx-.js";import{j as se,k as re,l as ie,c as ne,m as ae,q as ce}from"./index-CR_rE09L.js";import{u as ue,f as le}from"./useEntityData-BenXcX5m.js";import"./api-CLE4YwRs.js";import"./clientService-D0rezJXS.js";import"./productsService-DUq13sXT.js";import"./usersService-CO4rIiT5.js";import"./worksiteService-CfPHAhQs.js";var oe=function(u){$(r,u);function r(c,t){var e;return e=u.call(this)||this,e.client=c,e.options=t,e.trackedProps=[],e.selectError=null,e.bindMethods(),e.setOptions(t),e}var n=r.prototype;return n.bindMethods=function(){this.remove=this.remove.bind(this),this.refetch=this.refetch.bind(this)},n.onSubscribe=function(){this.listeners.length===1&&(this.currentQuery.addObserver(this),P(this.currentQuery,this.options)&&this.executeFetch(),this.updateTimers())},n.onUnsubscribe=function(){this.listeners.length||this.destroy()},n.shouldFetchOnReconnect=function(){return S(this.currentQuery,this.options,this.options.refetchOnReconnect)},n.shouldFetchOnWindowFocus=function(){return S(this.currentQuery,this.options,this.options.refetchOnWindowFocus)},n.destroy=function(){this.listeners=[],this.clearTimers(),this.currentQuery.removeObserver(this)},n.setOptions=function(t,e){var l=this.options,i=this.currentQuery;if(this.options=this.client.defaultQueryObserverOptions(t),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=l.queryKey),this.updateQuery();var o=this.hasListeners();o&&L(this.currentQuery,i,this.options,l)&&this.executeFetch(),this.updateResult(e),o&&(this.currentQuery!==i||this.options.enabled!==l.enabled||this.options.staleTime!==l.staleTime)&&this.updateStaleTimeout();var a=this.computeRefetchInterval();o&&(this.currentQuery!==i||this.options.enabled!==l.enabled||a!==this.currentRefetchInterval)&&this.updateRefetchInterval(a)},n.getOptimisticResult=function(t){var e=this.client.defaultQueryObserverOptions(t),l=this.client.getQueryCache().build(this.client,e);return this.createResult(l,e)},n.getCurrentResult=function(){return this.currentResult},n.trackResult=function(t,e){var l=this,i={},o=function(d){l.trackedProps.includes(d)||l.trackedProps.push(d)};return Object.keys(t).forEach(function(a){Object.defineProperty(i,a,{configurable:!1,enumerable:!0,get:function(){return o(a),t[a]}})}),(e.useErrorBoundary||e.suspense)&&o("error"),i},n.getNextResult=function(t){var e=this;return new Promise(function(l,i){var o=e.subscribe(function(a){a.isFetching||(o(),a.isError&&(t!=null&&t.throwOnError)?i(a.error):l(a))})})},n.getCurrentQuery=function(){return this.currentQuery},n.remove=function(){this.client.getQueryCache().remove(this.currentQuery)},n.refetch=function(t){return this.fetch(w({},t,{meta:{refetchPage:t==null?void 0:t.refetchPage}}))},n.fetchOptimistic=function(t){var e=this,l=this.client.defaultQueryObserverOptions(t),i=this.client.getQueryCache().build(this.client,l);return i.fetch().then(function(){return e.createResult(i,l)})},n.fetch=function(t){var e=this;return this.executeFetch(t).then(function(){return e.updateResult(),e.currentResult})},n.executeFetch=function(t){this.updateQuery();var e=this.currentQuery.fetch(this.options,t);return t!=null&&t.throwOnError||(e=e.catch(K)),e},n.updateStaleTimeout=function(){var t=this;if(this.clearStaleTimeout(),!(T||this.currentResult.isStale||!F(this.options.staleTime))){var e=W(this.currentResult.dataUpdatedAt,this.options.staleTime),l=e+1;this.staleTimeoutId=setTimeout(function(){t.currentResult.isStale||t.updateResult()},l)}},n.computeRefetchInterval=function(){var t;return typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.currentResult.data,this.currentQuery):(t=this.options.refetchInterval)!=null?t:!1},n.updateRefetchInterval=function(t){var e=this;this.clearRefetchInterval(),this.currentRefetchInterval=t,!(T||this.options.enabled===!1||!F(this.currentRefetchInterval)||this.currentRefetchInterval===0)&&(this.refetchIntervalId=setInterval(function(){(e.options.refetchIntervalInBackground||q.isFocused())&&e.executeFetch()},this.currentRefetchInterval))},n.updateTimers=function(){this.updateStaleTimeout(),this.updateRefetchInterval(this.computeRefetchInterval())},n.clearTimers=function(){this.clearStaleTimeout(),this.clearRefetchInterval()},n.clearStaleTimeout=function(){this.staleTimeoutId&&(clearTimeout(this.staleTimeoutId),this.staleTimeoutId=void 0)},n.clearRefetchInterval=function(){this.refetchIntervalId&&(clearInterval(this.refetchIntervalId),this.refetchIntervalId=void 0)},n.createResult=function(t,e){var l=this.currentQuery,i=this.options,o=this.currentResult,a=this.currentResultState,d=this.currentResultOptions,f=t!==l,m=f?t.state:this.currentQueryInitialState,x=f?this.currentResult:this.previousQueryResult,h=t.state,y=h.dataUpdatedAt,_=h.error,g=h.errorUpdatedAt,Q=h.isFetching,p=h.status,I=!1,E=!1,v;if(e.optimisticResults){var C=this.hasListeners(),B=!C&&P(t,e),M=C&&L(t,l,e,i);(B||M)&&(Q=!0,y||(p="loading"))}if(e.keepPreviousData&&!h.dataUpdateCount&&(x!=null&&x.isSuccess)&&p!=="error")v=x.data,y=x.dataUpdatedAt,p=x.status,I=!0;else if(e.select&&typeof h.data<"u")if(o&&h.data===(a==null?void 0:a.data)&&e.select===this.selectFn)v=this.selectResult;else try{this.selectFn=e.select,v=e.select(h.data),e.structuralSharing!==!1&&(v=U(o==null?void 0:o.data,v)),this.selectResult=v,this.selectError=null}catch(j){k().error(j),this.selectError=j}else v=h.data;if(typeof e.placeholderData<"u"&&typeof v>"u"&&(p==="loading"||p==="idle")){var R;if(o!=null&&o.isPlaceholderData&&e.placeholderData===(d==null?void 0:d.placeholderData))R=o.data;else if(R=typeof e.placeholderData=="function"?e.placeholderData():e.placeholderData,e.select&&typeof R<"u")try{R=e.select(R),e.structuralSharing!==!1&&(R=U(o==null?void 0:o.data,R)),this.selectError=null}catch(j){k().error(j),this.selectError=j}typeof R<"u"&&(p="success",v=R,E=!0)}this.selectError&&(_=this.selectError,v=this.selectResult,g=Date.now(),p="error");var D={status:p,isLoading:p==="loading",isSuccess:p==="success",isError:p==="error",isIdle:p==="idle",data:v,dataUpdatedAt:y,error:_,errorUpdatedAt:g,failureCount:h.fetchFailureCount,errorUpdateCount:h.errorUpdateCount,isFetched:h.dataUpdateCount>0||h.errorUpdateCount>0,isFetchedAfterMount:h.dataUpdateCount>m.dataUpdateCount||h.errorUpdateCount>m.errorUpdateCount,isFetching:Q,isRefetching:Q&&p!=="loading",isLoadingError:p==="error"&&h.dataUpdatedAt===0,isPlaceholderData:E,isPreviousData:I,isRefetchError:p==="error"&&h.dataUpdatedAt!==0,isStale:O(t,e),refetch:this.refetch,remove:this.remove};return D},n.shouldNotifyListeners=function(t,e){if(!e)return!0;var l=this.options,i=l.notifyOnChangeProps,o=l.notifyOnChangePropsExclusions;if(!i&&!o||i==="tracked"&&!this.trackedProps.length)return!0;var a=i==="tracked"?this.trackedProps:i;return Object.keys(t).some(function(d){var f=d,m=t[f]!==e[f],x=a==null?void 0:a.some(function(y){return y===d}),h=o==null?void 0:o.some(function(y){return y===d});return m&&!h&&(!a||x)})},n.updateResult=function(t){var e=this.currentResult;if(this.currentResult=this.createResult(this.currentQuery,this.options),this.currentResultState=this.currentQuery.state,this.currentResultOptions=this.options,!V(this.currentResult,e)){var l={cache:!0};(t==null?void 0:t.listeners)!==!1&&this.shouldNotifyListeners(this.currentResult,e)&&(l.listeners=!0),this.notify(w({},l,t))}},n.updateQuery=function(){var t=this.client.getQueryCache().build(this.client,this.options);if(t!==this.currentQuery){var e=this.currentQuery;this.currentQuery=t,this.currentQueryInitialState=t.state,this.previousQueryResult=this.currentResult,this.hasListeners()&&(e==null||e.removeObserver(this),t.addObserver(this))}},n.onQueryUpdate=function(t){var e={};t.type==="success"?e.onSuccess=!0:t.type==="error"&&!z(t.error)&&(e.onError=!0),this.updateResult(e),this.hasListeners()&&this.updateTimers()},n.notify=function(t){var e=this;N.batch(function(){t.onSuccess?(e.options.onSuccess==null||e.options.onSuccess(e.currentResult.data),e.options.onSettled==null||e.options.onSettled(e.currentResult.data,null)):t.onError&&(e.options.onError==null||e.options.onError(e.currentResult.error),e.options.onSettled==null||e.options.onSettled(void 0,e.currentResult.error)),t.listeners&&e.listeners.forEach(function(l){l(e.currentResult)}),t.cache&&e.client.getQueryCache().notify({query:e.currentQuery,type:"observerResultsUpdated"})})},r}(G);function de(u,r){return r.enabled!==!1&&!u.state.dataUpdatedAt&&!(u.state.status==="error"&&r.retryOnMount===!1)}function P(u,r){return de(u,r)||u.state.dataUpdatedAt>0&&S(u,r,r.refetchOnMount)}function S(u,r,n){if(r.enabled!==!1){var c=typeof n=="function"?n(u):n;return c==="always"||c!==!1&&O(u,r)}return!1}function L(u,r,n,c){return n.enabled!==!1&&(u!==r||c.enabled===!1)&&(!n.suspense||u.state.status!=="error")&&O(u,n)}function O(u,r){return u.isStaleByTime(r.staleTime)}function he(){var u=!1;return{clearReset:function(){u=!1},reset:function(){u=!0},isReset:function(){return u}}}var fe=b.createContext(he()),pe=function(){return b.useContext(fe)};function me(u,r,n){return typeof r=="function"?r.apply(void 0,n):typeof r=="boolean"?r:!!u}function ve(u,r){var n=b.useRef(!1),c=b.useState(0),t=c[1],e=J(),l=pe(),i=e.defaultQueryObserverOptions(u);i.optimisticResults=!0,i.onError&&(i.onError=N.batchCalls(i.onError)),i.onSuccess&&(i.onSuccess=N.batchCalls(i.onSuccess)),i.onSettled&&(i.onSettled=N.batchCalls(i.onSettled)),i.suspense&&(typeof i.staleTime!="number"&&(i.staleTime=1e3),i.cacheTime===0&&(i.cacheTime=1)),(i.suspense||i.useErrorBoundary)&&(l.isReset()||(i.retryOnMount=!1));var o=b.useState(function(){return new r(e,i)}),a=o[0],d=a.getOptimisticResult(i);if(b.useEffect(function(){n.current=!0,l.clearReset();var f=a.subscribe(N.batchCalls(function(){n.current&&t(function(m){return m+1})}));return a.updateResult(),function(){n.current=!1,f()}},[l,a]),b.useEffect(function(){a.setOptions(i,{listeners:!1})},[i,a]),i.suspense&&d.isLoading)throw a.fetchOptimistic(i).then(function(f){var m=f.data;i.onSuccess==null||i.onSuccess(m),i.onSettled==null||i.onSettled(m,null)}).catch(function(f){l.clearReset(),i.onError==null||i.onError(f),i.onSettled==null||i.onSettled(void 0,f)});if(d.isError&&!l.isReset()&&!d.isFetching&&me(i.suspense,i.useErrorBoundary,[d.error,a.getCurrentQuery()]))throw d.error;return i.notifyOnChangeProps==="tracked"&&(d=a.trackResult(d,i)),d}function xe(u,r,n){var c=H(u,r,n);return ve(c,oe)}const ye=({report:u})=>{const{t:r}=A(),n=X(),{showFlashMessage:c}=Y(),{getClientById:t,getWorksiteById:e,getProductById:l,getUserById:i}=ue();Z.useEffect(()=>{new URLSearchParams(n.search).get("action")==="report_created_successfully"&&c(r("report_created_successfully"),"success")},[n,c,r]);const o=a=>a.completed?s.jsx(ne,{className:"text-green-500 text-2xl"}):s.jsx(ae,{className:"text-yellow-500 text-2xl"});return s.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[s.jsxs("div",{className:"p-6 border-b border-gray-200",children:[s.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:r("report_details")}),s.jsx("p",{className:"text-gray-600",children:le(u.date)})]}),s.jsx("div",{className:"p-6 border-b border-gray-200",children:s.jsxs("dl",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[s.jsx("dt",{className:"text-sm font-medium text-gray-500",children:r("technician")}),s.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:u.technician_id.name})]}),s.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[s.jsx("dt",{className:"text-sm font-medium text-gray-500",children:r("status")}),s.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:r(u.status)})]})]})}),s.jsxs("div",{className:"p-6 border-b border-gray-200",children:[s.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:r("activities")}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:u.activities.map((a,d)=>{const f=t(a.client_id),m=e(a.worksite_id),x=i(a.assigned_technician_id);return s.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[r("activity")," ",d+1]}),o(a)]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[s.jsxs("div",{children:[s.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:r("client")}),s.jsx("a",{href:`/clients/${a.client_id}`,className:"text-blue-600 hover:underline",children:f?f.name:r("unknown_client")})]}),s.jsxs("div",{children:[s.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:r("worksite")}),s.jsx("a",{href:`/worksites/${a.worksite_id}`,className:"text-blue-600 hover:underline",children:m?m.name:r("unknown_worksite")})]})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx(se,{className:"inline-block text-blue-500 mr-2"}),s.jsx("span",{className:"text-gray-600",children:a.description||r("no_description")})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[s.jsxs("div",{children:[s.jsx(re,{className:"inline-block text-blue-500 mr-2"}),s.jsxs("span",{className:"text-gray-600",children:[r("work_time"),": ",a.work_time||0," ",r("minutes")]})]}),s.jsx("div",{children:s.jsxs("span",{className:"text-gray-600",children:[r("travel_time"),": ",a.travel_time||0," ",r("minutes")]})})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:r("intervention_type")}),s.jsx("p",{className:"text-gray-600",children:a.intervention_type||r("not_specified")})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:r("assigned_technician")}),s.jsx("p",{className:"text-gray-600",children:x?x.name:r("not_assigned")})]}),a.materials_used&&a.materials_used.length>0&&s.jsxs("div",{className:"mt-4",children:[s.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:r("materials_used")}),s.jsx("ul",{className:"list-disc list-inside space-y-2 mt-2",children:a.materials_used.map(({product_id:h,quantity:y},_)=>{const g=l(h);return s.jsxs("li",{className:"text-gray-700",children:[g?s.jsxs("div",{className:"space-y-1",children:[s.jsx("a",{href:`/products/${g._id}`,className:"text-blue-600 hover:underline font-semibold",children:g.item_code}),s.jsxs("span",{className:"text-sm text-gray-500",children:[" (",r("item_code"),")"]}),s.jsxs("div",{children:[s.jsxs("span",{className:"text-sm text-gray-600",children:[r("supplier_item_code"),":"]}),s.jsx("a",{href:`/products/${g._id}`,className:"text-blue-600 hover:underline font-semibold",children:g.supplier_item_code})]}),s.jsx("div",{className:"text-gray-600",children:g.item_description})]}):s.jsx("span",{className:"text-red-600",children:r("unknown_product")}),s.jsxs("div",{className:"mt-1",children:[s.jsxs("span",{className:"text-sm text-gray-600",children:[r("Quantity"),":"]}),s.jsxs("span",{className:"font-semibold",children:[" ",y||0," ",r("units")]})]})]},_)})})]})]},a._id)})})]}),s.jsxs("div",{className:"flex items-center p-6",children:[s.jsx(ie,{className:"text-blue-500 mr-2"}),s.jsxs("p",{className:"text-gray-600",children:[r("lunch_location"),": ",u.lunch_location||r("not_specified")]})]})]})},Oe=()=>{const{id:u}=ee(),{t:r}=A(),{data:n,isLoading:c,error:t}=xe(["report",u],()=>{if(u)return ce(u);throw new Error("Report ID is undefined")});return c?s.jsx(te,{}):t?s.jsx("div",{children:r("error_loading_report")}):n?s.jsx(ye,{report:n}):s.jsx("div",{children:r("report_not_found")})};export{Oe as default};
