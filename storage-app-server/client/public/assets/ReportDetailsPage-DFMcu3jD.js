import{p as $,q as w,v as K,x as T,z as F,A as W,B as q,C as U,E as P,G as V,I as z,J as Q,S as G,R,K as J,N as H,u as A,O as X,e as Y,r as Z,j as i,c as ee,a as te}from"./index-CAL5QNUn.js";import{f as re,h as se,i as ie,c as ne,j as ae,l as ue}from"./index-DuGMEWQV.js";import{u as ce,f as oe}from"./useEntityData-DkOprTZB.js";import"./api-CLE4YwRs.js";import"./clientService-Bj64bQzW.js";import"./productsService-BaCjJiUO.js";import"./usersService-D84MQp6X.js";import"./worksiteService-CfPHAhQs.js";var le=function(c){$(r,c);function r(u,t){var e;return e=c.call(this)||this,e.client=u,e.options=t,e.trackedProps=[],e.selectError=null,e.bindMethods(),e.setOptions(t),e}var n=r.prototype;return n.bindMethods=function(){this.remove=this.remove.bind(this),this.refetch=this.refetch.bind(this)},n.onSubscribe=function(){this.listeners.length===1&&(this.currentQuery.addObserver(this),k(this.currentQuery,this.options)&&this.executeFetch(),this.updateTimers())},n.onUnsubscribe=function(){this.listeners.length||this.destroy()},n.shouldFetchOnReconnect=function(){return O(this.currentQuery,this.options,this.options.refetchOnReconnect)},n.shouldFetchOnWindowFocus=function(){return O(this.currentQuery,this.options,this.options.refetchOnWindowFocus)},n.destroy=function(){this.listeners=[],this.clearTimers(),this.currentQuery.removeObserver(this)},n.setOptions=function(t,e){var o=this.options,s=this.currentQuery;if(this.options=this.client.defaultQueryObserverOptions(t),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=o.queryKey),this.updateQuery();var l=this.hasListeners();l&&L(this.currentQuery,s,this.options,o)&&this.executeFetch(),this.updateResult(e),l&&(this.currentQuery!==s||this.options.enabled!==o.enabled||this.options.staleTime!==o.staleTime)&&this.updateStaleTimeout();var a=this.computeRefetchInterval();l&&(this.currentQuery!==s||this.options.enabled!==o.enabled||a!==this.currentRefetchInterval)&&this.updateRefetchInterval(a)},n.getOptimisticResult=function(t){var e=this.client.defaultQueryObserverOptions(t),o=this.client.getQueryCache().build(this.client,e);return this.createResult(o,e)},n.getCurrentResult=function(){return this.currentResult},n.trackResult=function(t,e){var o=this,s={},l=function(h){o.trackedProps.includes(h)||o.trackedProps.push(h)};return Object.keys(t).forEach(function(a){Object.defineProperty(s,a,{configurable:!1,enumerable:!0,get:function(){return l(a),t[a]}})}),(e.useErrorBoundary||e.suspense)&&l("error"),s},n.getNextResult=function(t){var e=this;return new Promise(function(o,s){var l=e.subscribe(function(a){a.isFetching||(l(),a.isError&&(t!=null&&t.throwOnError)?s(a.error):o(a))})})},n.getCurrentQuery=function(){return this.currentQuery},n.remove=function(){this.client.getQueryCache().remove(this.currentQuery)},n.refetch=function(t){return this.fetch(w({},t,{meta:{refetchPage:t==null?void 0:t.refetchPage}}))},n.fetchOptimistic=function(t){var e=this,o=this.client.defaultQueryObserverOptions(t),s=this.client.getQueryCache().build(this.client,o);return s.fetch().then(function(){return e.createResult(s,o)})},n.fetch=function(t){var e=this;return this.executeFetch(t).then(function(){return e.updateResult(),e.currentResult})},n.executeFetch=function(t){this.updateQuery();var e=this.currentQuery.fetch(this.options,t);return t!=null&&t.throwOnError||(e=e.catch(K)),e},n.updateStaleTimeout=function(){var t=this;if(this.clearStaleTimeout(),!(T||this.currentResult.isStale||!F(this.options.staleTime))){var e=W(this.currentResult.dataUpdatedAt,this.options.staleTime),o=e+1;this.staleTimeoutId=setTimeout(function(){t.currentResult.isStale||t.updateResult()},o)}},n.computeRefetchInterval=function(){var t;return typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.currentResult.data,this.currentQuery):(t=this.options.refetchInterval)!=null?t:!1},n.updateRefetchInterval=function(t){var e=this;this.clearRefetchInterval(),this.currentRefetchInterval=t,!(T||this.options.enabled===!1||!F(this.currentRefetchInterval)||this.currentRefetchInterval===0)&&(this.refetchIntervalId=setInterval(function(){(e.options.refetchIntervalInBackground||q.isFocused())&&e.executeFetch()},this.currentRefetchInterval))},n.updateTimers=function(){this.updateStaleTimeout(),this.updateRefetchInterval(this.computeRefetchInterval())},n.clearTimers=function(){this.clearStaleTimeout(),this.clearRefetchInterval()},n.clearStaleTimeout=function(){this.staleTimeoutId&&(clearTimeout(this.staleTimeoutId),this.staleTimeoutId=void 0)},n.clearRefetchInterval=function(){this.refetchIntervalId&&(clearInterval(this.refetchIntervalId),this.refetchIntervalId=void 0)},n.createResult=function(t,e){var o=this.currentQuery,s=this.options,l=this.currentResult,a=this.currentResultState,h=this.currentResultOptions,f=t!==o,m=f?t.state:this.currentQueryInitialState,y=f?this.currentResult:this.previousQueryResult,d=t.state,x=d.dataUpdatedAt,b=d.error,I=d.errorUpdatedAt,S=d.isFetching,p=d.status,_=!1,E=!1,v;if(e.optimisticResults){var C=this.hasListeners(),B=!C&&k(t,e),M=C&&L(t,o,e,s);(B||M)&&(S=!0,x||(p="loading"))}if(e.keepPreviousData&&!d.dataUpdateCount&&(y!=null&&y.isSuccess)&&p!=="error")v=y.data,x=y.dataUpdatedAt,p=y.status,_=!0;else if(e.select&&typeof d.data<"u")if(l&&d.data===(a==null?void 0:a.data)&&e.select===this.selectFn)v=this.selectResult;else try{this.selectFn=e.select,v=e.select(d.data),e.structuralSharing!==!1&&(v=U(l==null?void 0:l.data,v)),this.selectResult=v,this.selectError=null}catch(j){P().error(j),this.selectError=j}else v=d.data;if(typeof e.placeholderData<"u"&&typeof v>"u"&&(p==="loading"||p==="idle")){var g;if(l!=null&&l.isPlaceholderData&&e.placeholderData===(h==null?void 0:h.placeholderData))g=l.data;else if(g=typeof e.placeholderData=="function"?e.placeholderData():e.placeholderData,e.select&&typeof g<"u")try{g=e.select(g),e.structuralSharing!==!1&&(g=U(l==null?void 0:l.data,g)),this.selectError=null}catch(j){P().error(j),this.selectError=j}typeof g<"u"&&(p="success",v=g,E=!0)}this.selectError&&(b=this.selectError,v=this.selectResult,I=Date.now(),p="error");var D={status:p,isLoading:p==="loading",isSuccess:p==="success",isError:p==="error",isIdle:p==="idle",data:v,dataUpdatedAt:x,error:b,errorUpdatedAt:I,failureCount:d.fetchFailureCount,errorUpdateCount:d.errorUpdateCount,isFetched:d.dataUpdateCount>0||d.errorUpdateCount>0,isFetchedAfterMount:d.dataUpdateCount>m.dataUpdateCount||d.errorUpdateCount>m.errorUpdateCount,isFetching:S,isRefetching:S&&p!=="loading",isLoadingError:p==="error"&&d.dataUpdatedAt===0,isPlaceholderData:E,isPreviousData:_,isRefetchError:p==="error"&&d.dataUpdatedAt!==0,isStale:N(t,e),refetch:this.refetch,remove:this.remove};return D},n.shouldNotifyListeners=function(t,e){if(!e)return!0;var o=this.options,s=o.notifyOnChangeProps,l=o.notifyOnChangePropsExclusions;if(!s&&!l||s==="tracked"&&!this.trackedProps.length)return!0;var a=s==="tracked"?this.trackedProps:s;return Object.keys(t).some(function(h){var f=h,m=t[f]!==e[f],y=a==null?void 0:a.some(function(x){return x===h}),d=l==null?void 0:l.some(function(x){return x===h});return m&&!d&&(!a||y)})},n.updateResult=function(t){var e=this.currentResult;if(this.currentResult=this.createResult(this.currentQuery,this.options),this.currentResultState=this.currentQuery.state,this.currentResultOptions=this.options,!V(this.currentResult,e)){var o={cache:!0};(t==null?void 0:t.listeners)!==!1&&this.shouldNotifyListeners(this.currentResult,e)&&(o.listeners=!0),this.notify(w({},o,t))}},n.updateQuery=function(){var t=this.client.getQueryCache().build(this.client,this.options);if(t!==this.currentQuery){var e=this.currentQuery;this.currentQuery=t,this.currentQueryInitialState=t.state,this.previousQueryResult=this.currentResult,this.hasListeners()&&(e==null||e.removeObserver(this),t.addObserver(this))}},n.onQueryUpdate=function(t){var e={};t.type==="success"?e.onSuccess=!0:t.type==="error"&&!z(t.error)&&(e.onError=!0),this.updateResult(e),this.hasListeners()&&this.updateTimers()},n.notify=function(t){var e=this;Q.batch(function(){t.onSuccess?(e.options.onSuccess==null||e.options.onSuccess(e.currentResult.data),e.options.onSettled==null||e.options.onSettled(e.currentResult.data,null)):t.onError&&(e.options.onError==null||e.options.onError(e.currentResult.error),e.options.onSettled==null||e.options.onSettled(void 0,e.currentResult.error)),t.listeners&&e.listeners.forEach(function(o){o(e.currentResult)}),t.cache&&e.client.getQueryCache().notify({query:e.currentQuery,type:"observerResultsUpdated"})})},r}(G);function de(c,r){return r.enabled!==!1&&!c.state.dataUpdatedAt&&!(c.state.status==="error"&&r.retryOnMount===!1)}function k(c,r){return de(c,r)||c.state.dataUpdatedAt>0&&O(c,r,r.refetchOnMount)}function O(c,r,n){if(r.enabled!==!1){var u=typeof n=="function"?n(c):n;return u==="always"||u!==!1&&N(c,r)}return!1}function L(c,r,n,u){return n.enabled!==!1&&(c!==r||u.enabled===!1)&&(!n.suspense||c.state.status!=="error")&&N(c,n)}function N(c,r){return c.isStaleByTime(r.staleTime)}function he(){var c=!1;return{clearReset:function(){c=!1},reset:function(){c=!0},isReset:function(){return c}}}var fe=R.createContext(he()),pe=function(){return R.useContext(fe)};function me(c,r,n){return typeof r=="function"?r.apply(void 0,n):typeof r=="boolean"?r:!!c}function ve(c,r){var n=R.useRef(!1),u=R.useState(0),t=u[1],e=J(),o=pe(),s=e.defaultQueryObserverOptions(c);s.optimisticResults=!0,s.onError&&(s.onError=Q.batchCalls(s.onError)),s.onSuccess&&(s.onSuccess=Q.batchCalls(s.onSuccess)),s.onSettled&&(s.onSettled=Q.batchCalls(s.onSettled)),s.suspense&&(typeof s.staleTime!="number"&&(s.staleTime=1e3),s.cacheTime===0&&(s.cacheTime=1)),(s.suspense||s.useErrorBoundary)&&(o.isReset()||(s.retryOnMount=!1));var l=R.useState(function(){return new r(e,s)}),a=l[0],h=a.getOptimisticResult(s);if(R.useEffect(function(){n.current=!0,o.clearReset();var f=a.subscribe(Q.batchCalls(function(){n.current&&t(function(m){return m+1})}));return a.updateResult(),function(){n.current=!1,f()}},[o,a]),R.useEffect(function(){a.setOptions(s,{listeners:!1})},[s,a]),s.suspense&&h.isLoading)throw a.fetchOptimistic(s).then(function(f){var m=f.data;s.onSuccess==null||s.onSuccess(m),s.onSettled==null||s.onSettled(m,null)}).catch(function(f){o.clearReset(),s.onError==null||s.onError(f),s.onSettled==null||s.onSettled(void 0,f)});if(h.isError&&!o.isReset()&&!h.isFetching&&me(s.suspense,s.useErrorBoundary,[h.error,a.getCurrentQuery()]))throw h.error;return s.notifyOnChangeProps==="tracked"&&(h=a.trackResult(h,s)),h}function ye(c,r,n){var u=H(c,r,n);return ve(u,le)}const xe=({report:c})=>{const{t:r}=A(),n=X(),{showFlashMessage:u}=Y(),{getClientById:t,getWorksiteById:e,getProductById:o,getUserById:s}=ce();Z.useEffect(()=>{new URLSearchParams(n.search).get("action")==="report_created_successfully"&&u(r("report_created_successfully"),"success")},[n,u,r]);const l=a=>a.completed?i.jsx(ne,{className:"text-green-500 text-2xl"}):i.jsx(ae,{className:"text-yellow-500 text-2xl"});return i.jsxs("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:[i.jsxs("div",{className:"px-4 py-5 sm:px-6",children:[i.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:r("report_details")}),i.jsx("p",{className:"text-gray-600",children:oe(c.date)})]}),i.jsx("div",{className:"border-t border-gray-200 px-4 py-5 sm:p-0",children:i.jsxs("dl",{className:"sm:divide-y sm:divide-gray-200",children:[i.jsxs("div",{className:"py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6",children:[i.jsx("dt",{className:"text-sm font-medium text-gray-500",children:r("technician")}),i.jsx("dd",{className:"mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2",children:c.technician_id.name})]}),i.jsxs("div",{className:"py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6",children:[i.jsx("dt",{className:"text-sm font-medium text-gray-500",children:r("status")}),i.jsx("dd",{className:"mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2",children:r(c.status)})]})]})}),i.jsxs("div",{className:"px-4 py-5 sm:px-6",children:[i.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:r("activities")}),i.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:c.activities.map((a,h)=>{const f=t(a.client_id),m=e(a.worksite_id),y=s(a.assigned_technician_id);return i.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 shadow",children:[i.jsxs("div",{className:"flex items-center justify-between mb-2",children:[i.jsxs("h4",{className:"text-lg font-semibold text-gray-700",children:[r("activity")," ",h+1]}),l(a)]}),i.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[i.jsxs("div",{children:[i.jsx("h5",{className:"font-semibold text-gray-700",children:r("client")}),i.jsx("a",{href:`/clients/${a.client_id}`,className:"text-blue-600 hover:underline",children:f?f.name:r("unknown_client")})]}),i.jsxs("div",{children:[i.jsx("h5",{className:"font-semibold text-gray-700",children:r("worksite")}),i.jsx("a",{href:`/worksites/${a.worksite_id}`,className:"text-blue-600 hover:underline",children:m?m.name:r("unknown_worksite")})]})]}),i.jsxs("div",{className:"flex items-center mb-2",children:[i.jsx(re,{className:"text-blue-500 mr-2"}),i.jsx("p",{className:"text-gray-600",children:a.description||r("no_description")})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[i.jsxs("div",{className:"flex items-center",children:[i.jsx(se,{className:"text-blue-500 mr-2"}),i.jsxs("p",{className:"text-gray-600",children:[r("work_time"),": ",a.work_time||0," ",r("minutes")]})]}),i.jsx("div",{children:i.jsxs("p",{className:"text-gray-600",children:[r("travel_time"),": ",a.travel_time||0," ",r("minutes")]})})]}),i.jsxs("div",{children:[i.jsx("h5",{className:"font-semibold text-gray-700",children:r("intervention_type")}),i.jsx("p",{className:"text-gray-600",children:a.intervention_type||r("not_specified")})]}),i.jsxs("div",{children:[i.jsx("h5",{className:"font-semibold text-gray-700",children:r("assigned_technician")}),i.jsx("p",{className:"text-gray-600",children:y?y.name:r("not_assigned")})]}),a.materials_used&&a.materials_used.length>0&&i.jsxs("div",{className:"mt-2",children:[i.jsx("h5",{className:"font-semibold text-gray-700",children:r("materials_used")}),i.jsx("ul",{className:"list-disc list-inside",children:a.materials_used.map((d,x)=>{const b=o(d.product_id);return i.jsxs("li",{className:"text-gray-600",children:[b?b.name:r("unknown_product")," - ",d.quantity||0," ",r("units")]},x)})})]})]},a._id)})})]}),i.jsxs("div",{className:"flex items-center mb-4 px-4 py-5 sm:px-6",children:[i.jsx(ie,{className:"text-blue-500 mr-2"}),i.jsxs("p",{className:"text-gray-600",children:[r("lunch_location"),": ",c.lunch_location||r("not_specified")]})]})]})},Ie=()=>{const{id:c}=ee(),{t:r}=A(),{data:n,isLoading:u,error:t}=ye(["report",c],()=>{if(c)return ue(c);throw new Error("Report ID is undefined")});return u?i.jsx(te,{}):t?i.jsx("div",{children:r("error_loading_report")}):n?i.jsx(xe,{report:n}):i.jsx("div",{children:r("report_not_found")})};export{Ie as default};
