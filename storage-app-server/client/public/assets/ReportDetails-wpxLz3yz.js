import{g as Y,k as H,r as y,u as O,h as J,a4 as K,j as e,a5 as Q,a6 as W,a7 as G,a8 as V,d as X,a9 as Z}from"./index-DlcWvvpn.js";import{a as ee}from"./clientService-DWml5I6n.js";import{a as se}from"./productsService-DJ1x3sK0.js";import{c as te}from"./reportService-Bt1KOb2Q.js";import{a as ie}from"./usersService-BCTf9RTI.js";import{a as re}from"./worksiteService-Bsvx2crQ.js";import{a as ae}from"./formatDate-CFXLpRQ8.js";const ne=()=>{const{user:m}=Y(),{showFlashMessage:s}=H(),[_,u]=y.useState({header:{date:new Date().toISOString().split("T")[0],author_id:m._id,head_description:"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:m._id||"",tasks:[{assigned_technician_ids:[m._id],work_hours:0,task_description:"",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}]}]}),[x,$]=y.useState([]),[E,D]=y.useState([]),[p,f]=y.useState([]),[M,c]=y.useState([]),[N,w]=y.useState(!0),{t:d}=O(),F=J();y.useEffect(()=>{(async()=>{w(!0);try{const[n,o,a,i]=await Promise.all([ee(),re(),se(1,{searchText:"",type:""}),ie()]);$(n.clients),f(a.products),c(i.users);const r=o.map(l=>({...l,client_id:l.client_id||l.clientId||null}));D(r)}catch(n){const o=n instanceof Error?n.message:"An error occurred";s(o,"error")}finally{w(!1)}})()},[]),y.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(_))},[_]),y.useEffect(()=>{const t=localStorage.getItem("scrollY");t&&window.scrollTo(0,parseInt(t,10))},[]);const B=t=>{const{name:n,value:o}=t.target;u(a=>a.header?{...a,header:{...a.header,[n]:o}}:a)},A=(t,n,o)=>{const a=n.split("."),i={...t};let r=i;for(let v=0;v<a.length-1;v++){const g=a[v],T=g.match(/(\w+)\[(\d+)\]/);if(T){const j=T[1],q=parseInt(T[2],10);r[j]||(r[j]=[]),r[j]=[...r[j]],r[j][q]||(r[j][q]={}),r[j][q]={...r[j][q]},r=r[j][q]}else r[g]||(r[g]={}),r[g]={...r[g]},r=r[g]}const l=a[a.length-1];return r[l]=o,i},h=(t,n,o)=>{console.log("[handleActivityChange]",{activityIndex:t,fieldPath:n,value:o}),u(a=>{const i=a.activities?[...a.activities]:[],r=i[t],l=A(r,n,o);return i[t]=l,{...a,activities:i}})},k=()=>{u(t=>({...t,activities:[...t.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:m._id||"",tasks:[]}]}))},C=t=>{u(n=>{var o;return{...n,activities:(o=n.activities)==null?void 0:o.filter((a,i)=>i!==t)}})},P=t=>{u(n=>{console.log(1.1,{prevState:n});const o=n.activities?[...n.activities]:[],a={...o[t]};return a.tasks=[...a.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[]}],o[t]=a,console.log(1.2,{newState:{...n,activities:o}}),{...n,activities:o}})},b=(t,n)=>{u(o=>{const a=o.activities?[...o.activities]:[],i={...a[t]};return i.tasks=i.tasks.filter((r,l)=>l!==n),a[t]=i,{...o,activities:a}})},I=(t,n)=>{u(o=>{const a=o.activities?[...o.activities]:[],i={...a[t]},r={...i.tasks[n]};return r.materials_used=[...r.materials_used||[],{product_id:"",quantity:1}],i.tasks[n]=r,a[t]=i,{...o,activities:a}})},L=(t,n,o)=>{u(a=>{const i=a.activities?[...a.activities]:[],r={...i[t]},l={...r.tasks[n]};return l.materials_used=l.materials_used.filter((v,g)=>g!==o),r.tasks[n]=l,i[t]=r,{...a,activities:i}})},z=async t=>{t.preventDefault();const n=R();if(Object.keys(n).length>0){const i=Object.values(n),l=i.slice(0,3).join(", "),v=i.length>3?` e altri ${i.length-3} errori`:"";s(`Errore di validazione: ${l}${v}`,"error");return}if(!S()&&!window.confirm(d("proceed_without_material_message")))return;const a={..._,activities:_.activities.map(i=>({...i,tasks:i.tasks.map(r=>({...r,materials_used:(r.materials_used||[]).filter(l=>l.product_id)}))}))};try{const i=await te(a);if(i&&i._id)s(d("report_created_successfully"),"success"),F(`/reports/${i._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(i){console.error("Error creating report:",i),s(d("error_creating_report"),"error")}},S=()=>{var t;return((t=_.activities)==null?void 0:t.some(n=>{var o;return(o=n.tasks)==null?void 0:o.some(a=>{var i;return(i=a.materials_used)==null?void 0:i.some(r=>r.product_id&&r.quantity>=1)})}))||!1},R=()=>{const t={},{header:n,activities:o}=_;if(n){if(!(o!=null&&o.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return n.date||(t["header.date"]=d("date_required")),n.author_id||(t["header.author_id"]=d("author_required")),n.head_description||(t["header.head_description"]=d("head_description_required")),n.status||(t["header.status"]=d("status_required")),n.lunch_location||(t["header.lunch_location"]=d("lunch_location_required")),(!n.head_description||n.head_description.trim()==="")&&(t["header.short_description"]=d("short_description_required")),o.forEach((a,i)=>{if(a.client_id||(t[`activities[${i}].client_id`]=d("client_required")),a.worksite_id||(t[`activities[${i}].worksite_id`]=d("worksite_required")),a.activity_description||(t[`activities[${i}].activity_description`]=d("activity_description_required")),a.valid_travel_time==="manual")a.travel_time_hours<=0&&(t[`activities[${i}].travel_time_hours`]=d("invalid_travel_time_hours"));else if(a.valid_travel_time==="rules")if(!a.travel_time_rules_applied)t[`activities[${i}].travel_time_rules_applied`]=d("travel_time_rules_required");else{const{distance_km:r,travel_time_hours:l}=a.travel_time_rules_applied;(r<=0||l<=0)&&(t[`activities[${i}].travel_time_rules_applied`]=d("invalid_travel_time_rules"))}a.tasks.forEach((r,l)=>{(!r.task_description||r.task_description.trim()==="")&&(t[`activities[${i}].tasks[${l}].task_description`]=d("task_description_required")),r.work_hours<=0&&(t[`activities[${i}].tasks[${l}].work_hours`]=d("invalid_work_hours")),!r.intervention_type.to_quote&&!r.intervention_type.in_economy&&!r.intervention_type.site_inspection&&(t[`activities[${i}].tasks[${l}].intervention_type`]=d("intervention_type_required")),r.materials_used.forEach((v,g)=>{v.product_id&&v.quantity<1&&(t[`activities[${i}].tasks[${l}].materials_used[${g}].quantity`]=d("invalid_material_quantity"))})})}),t};return{formData:_,clients:x,worksites:E,products:p,users:M,isLoading:N,handleHeaderChange:B,handleActivityChange:h,handleSubmit:z,appendActivity:k,removeActivity:C,appendTask:P,removeTask:b,appendMaterial:I,removeMaterial:L,validateForm:R}};function U(m,s){const _=Math.floor(m),u=Math.round((m-_)*60);let x="";return _>0&&(x+=`${_} ${s(_===1?"hour":"hours")}`),u>0&&(x&&(x+=" "),x+=`${u} ${s(u===1?"minute":"minutes")}`),x||(x=s("no_time")),x}const oe=()=>{const{clients:m,worksites:s,products:_,users:u}=ne();return{getClientById:p=>m.find(f=>f._id===p),getWorksiteById:p=>s.find(f=>f._id===p),getProductById:p=>_.find(f=>f._id===p),getUserById:p=>u.find(f=>f._id===p)}},xe=({report:m})=>{const{t:s}=O(),_=K(),{showFlashMessage:u}=H(),{getClientById:x,getWorksiteById:$,getProductById:E,getUserById:D}=oe();y.useEffect(()=>{new URLSearchParams(_.search).get("action")==="report_created_successfully"&&u(s("report_created_successfully"),"success")},[_,u,s]);const p=c=>c.completed?e.jsx(X,{className:"text-green-500 text-2xl"}):e.jsx(Z,{className:"text-yellow-500 text-2xl"}),f=typeof m.technician_id=="object"&&m.technician_id!==null?m.technician_id.name:"",M=m.activities||[];return e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:s("report_details")}),e.jsx("p",{className:"text-gray-600",children:m.date?ae(m.date,s):""})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("dl",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("technician")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:f||s("not_assigned")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("status")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:m.status?s(m.status):s("not_specified")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("short_description")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:m.short_description||s("no_description")})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:s("activities")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:M.map((c,N)=>{var A;const w=x(c.client_id),d=$(c.worksite_id),F=D(c.assigned_technician_id),B=((A=c.tasks)==null?void 0:A.reduce((h,k)=>h+(k.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[s("activity")," ",N+1]}),p(c)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("client")}),e.jsx("a",{href:`/clients/${c.client_id}`,className:"text-blue-600 hover:underline",children:w?w.name:s("unknown_client")})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("worksite")}),e.jsx("a",{href:`/worksites/${c.worksite_id}`,className:"text-blue-600 hover:underline",children:d?d.name:s("unknown_worksite")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(Q,{className:"inline-block text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-600",children:c.activity_description||s("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(W,{className:"inline-block text-blue-500 mr-2"}),e.jsxs("span",{className:"text-gray-600",children:[s("work_time"),": ",U(B,s)," ",s("hours")]})]}),e.jsx("div",{children:e.jsxs("span",{className:"text-gray-600",children:[s("travel_time"),": ",U(c.travel_time_hours||0,s)," ",s("hours")]})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("intervention_type")}),c.intervention_type?e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),c.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!c.intervention_type.to_quote&&!c.intervention_type.in_economy&&!c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]}):e.jsx("p",{className:"text-gray-600",children:s("not_specified")})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("assigned_technician")}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(G,{className:"inline-block text-blue-500 mr-2"}),e.jsx("p",{children:F?F.name:s("not_assigned")})]})]}),c.tasks&&c.tasks.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:s("tasks")}),c.tasks.map((h,k)=>e.jsxs("div",{className:"mb-4 p-4 bg-white rounded shadow-sm",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:h.task_description||s("no_description")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(W,{className:"inline-block text-gray-500 mr-1"}),s("work_hours"),": ",U(h.work_hours||0,s)]}),h.intervention_type&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h6",{className:"text-xs font-semibold text-gray-500",children:s("intervention_type")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),h.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),h.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!h.intervention_type.to_quote&&!h.intervention_type.in_economy&&!h.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]})]}),h.materials_used&&h.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold text-gray-700",children:s("materials_used")}),e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-xs font-semibold text-gray-600",children:s("Quantity")})]})}),e.jsx("tbody",{children:h.materials_used.map((C,P)=>{const b=E(C.product_id);return e.jsx("tr",{className:"border-t",children:b?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-1 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${b._id}`,children:b.codice_articolo})}),e.jsx("td",{className:"py-1 text-gray-700",children:b.descrizione_articolo}),e.jsx("td",{className:"py-1 text-right text-gray-600",children:C.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-1 text-red-600",children:s("unknown_product")})},P)})})]})]})]},k))]})]},N)})})]}),e.jsxs("div",{className:"flex items-center p-6",children:[e.jsx(V,{className:"text-blue-500 mr-2"}),e.jsxs("p",{className:"text-gray-600",children:[s("lunch_location"),": ",m.lunch_location||s("not_specified")]})]})]})};export{xe as R,U as f,ne as u};
