import{g as Y,k as H,r as y,u as O,h as J,a4 as K,j as e,a5 as Q,a6 as W,a7 as G,a8 as V,d as X,a9 as Z}from"./index-BL79QhDQ.js";import{a as ee}from"./clientService-DWml5I6n.js";import{a as se}from"./productsService-DJ1x3sK0.js";import{c as te}from"./reportService-C5rT5Bns.js";import{a as ie}from"./usersService-BCTf9RTI.js";import{a as re}from"./worksiteService-Bsvx2crQ.js";import{a as ae}from"./formatDate-CFXLpRQ8.js";const ne=()=>{const{user:m}=Y(),{showFlashMessage:s}=H(),[u,_]=y.useState({header:{date:new Date().toISOString().split("T")[0],author_id:m._id,head_description:"",status:"DRAFT",lunch_location:""},activities:[{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:m._id||"",tasks:[{assigned_technician_ids:[m._id],work_hours:0,task_description:"",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[{product_id:"",quantity:1}]}]}]}),[x,$]=y.useState([]),[E,D]=y.useState([]),[p,f]=y.useState([]),[M,c]=y.useState([]),[N,w]=y.useState(!0),{t:l}=O(),A=J();y.useEffect(()=>{(async()=>{w(!0);try{const[a,n,t,o]=await Promise.all([ee(),re(),se(1,{searchText:"",type:""}),ie()]);$(a.clients),f(t.products),c(o.users);const r=n.map(d=>({...d,client_id:d.client_id||d.clientId||null}));D(r)}catch(a){const n=a instanceof Error?a.message:"An error occurred";s(n,"error")}finally{w(!1)}})()},[]),y.useEffect(()=>{localStorage.setItem("formData",JSON.stringify(u))},[u]),y.useEffect(()=>{const i=localStorage.getItem("scrollY");i&&window.scrollTo(0,parseInt(i,10))},[]);const B=i=>{const{name:a,value:n}=i.target;_(t=>t.header?{...t,header:{...t.header,[a]:n}}:t)},C=(i,a,n)=>{const t=a.split("."),o={...i};let r=o;for(let j=0;j<t.length-1;j++){const g=t[j],T=g.match(/(\w+)\[(\d+)\]/);if(T){const v=T[1],q=parseInt(T[2],10);r[v]||(r[v]=[]),r[v]=[...r[v]],r[v][q]||(r[v][q]={}),r[v][q]={...r[v][q]},r=r[v][q]}else r[g]||(r[g]={}),r[g]={...r[g]},r=r[g]}const d=t[t.length-1];return r[d]=n,o},h=(i,a,n)=>{console.log("[handleActivityChange]",{activityIndex:i,fieldPath:a,value:n}),_(t=>{const o=t.activities?[...t.activities]:[],r=o[i],d=C(r,a,n);return o[i]=d,{...t,activities:o}})},k=()=>{_(i=>({...i,activities:[...i.activities||[],{_id:"hash_"+Math.random().toString(36).substr(2,9),client_id:"",worksite_id:"",description:"",activity_description:"",completed:!1,travel_time_hours:0,travel_time:0,work_time:0,valid_travel_time:"manual",intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},assigned_technician_id:m._id||"",tasks:[]}]}))},F=i=>{_(a=>{var n;return{...a,activities:(n=a.activities)==null?void 0:n.filter((t,o)=>o!==i)}})},P=i=>{_(a=>{console.log(1.1,{prevState:a});const n=a.activities?[...a.activities]:[],t={...n[i]};return t.tasks=[...t.tasks||[],{assigned_technician_ids:[],task_description:"",work_hours:0,intervention_type:{to_quote:!1,in_economy:!1,site_inspection:!1},materials_used:[{product_id:"",quantity:1}]}],n[i]=t,console.log(1.2,{newState:{...a,activities:n}}),{...a,activities:n}})},b=(i,a)=>{_(n=>{const t=n.activities?[...n.activities]:[],o={...t[i]};return o.tasks=o.tasks.filter((r,d)=>d!==a),t[i]=o,{...n,activities:t}})},I=(i,a)=>{_(n=>{const t=n.activities?[...n.activities]:[],o={...t[i]},r={...o.tasks[a]};return r.materials_used=[...r.materials_used||[],{product_id:"",quantity:1}],o.tasks[a]=r,t[i]=o,{...n,activities:t}})},L=(i,a,n)=>{_(t=>{const o=t.activities?[...t.activities]:[],r={...o[i]},d={...r.tasks[a]};return d.materials_used=d.materials_used.filter((j,g)=>g!==n),r.tasks[a]=d,o[i]=r,{...t,activities:o}})},z=async i=>{i.preventDefault();const a=R();if(Object.keys(a).length>0){const t=Object.values(a),r=t.slice(0,3).join(", "),d=t.length>3?` e altri ${t.length-3} errori`:"";s(`Errore di validazione: ${r}${d}`,"error");return}if(!(!S()&&!window.confirm(l("proceed_without_material_message"))))try{const t=await te(u);if(t&&t._id)s(l("report_created_successfully"),"success"),A(`/reports/${t._id}?action=report_created_successfully`);else throw new Error("Created report ID not found")}catch(t){console.error("Error creating report:",t),s(l("error_creating_report"),"error")}},S=()=>{var i;return((i=u.activities)==null?void 0:i.some(a=>{var n;return(n=a.tasks)==null?void 0:n.some(t=>{var o;return(o=t.materials_used)==null?void 0:o.some(r=>r.product_id&&r.quantity>=1)})}))||!1},R=()=>{const i={},{header:a,activities:n}=u;if(a){if(!(n!=null&&n.length))return{header:"Please, add an activity"}}else return{header:"Please, complete the form"};return a.date||(i["header.date"]=l("date_required")),a.author_id||(i["header.author_id"]=l("author_required")),a.head_description||(i["header.head_description"]=l("head_description_required")),a.status||(i["header.status"]=l("status_required")),a.lunch_location||(i["header.lunch_location"]=l("lunch_location_required")),(!a.head_description||a.head_description.trim()==="")&&(i["header.short_description"]=l("short_description_required")),n.forEach((t,o)=>{if(t.client_id||(i[`activities[${o}].client_id`]=l("client_required")),t.worksite_id||(i[`activities[${o}].worksite_id`]=l("worksite_required")),t.activity_description||(i[`activities[${o}].activity_description`]=l("activity_description_required")),t.valid_travel_time==="manual")t.travel_time_hours<=0&&(i[`activities[${o}].travel_time_hours`]=l("invalid_travel_time_hours"));else if(t.valid_travel_time==="rules")if(!t.travel_time_rules_applied)i[`activities[${o}].travel_time_rules_applied`]=l("travel_time_rules_required");else{const{distance_km:r,travel_time_hours:d}=t.travel_time_rules_applied;(r<=0||d<=0)&&(i[`activities[${o}].travel_time_rules_applied`]=l("invalid_travel_time_rules"))}t.tasks.forEach((r,d)=>{(!r.task_description||r.task_description.trim()==="")&&(i[`activities[${o}].tasks[${d}].task_description`]=l("task_description_required")),r.work_hours<=0&&(i[`activities[${o}].tasks[${d}].work_hours`]=l("invalid_work_hours")),!r.intervention_type.to_quote&&!r.intervention_type.in_economy&&!r.intervention_type.site_inspection&&(i[`activities[${o}].tasks[${d}].intervention_type`]=l("intervention_type_required")),r.materials_used.forEach((j,g)=>{j.product_id&&j.quantity<1&&(i[`activities[${o}].tasks[${d}].materials_used[${g}].quantity`]=l("invalid_material_quantity"))})})}),i};return{formData:u,clients:x,worksites:E,products:p,users:M,isLoading:N,handleHeaderChange:B,handleActivityChange:h,handleSubmit:z,appendActivity:k,removeActivity:F,appendTask:P,removeTask:b,appendMaterial:I,removeMaterial:L,validateForm:R}};function U(m,s){const u=Math.floor(m),_=Math.round((m-u)*60);let x="";return u>0&&(x+=`${u} ${s(u===1?"hour":"hours")}`),_>0&&(x&&(x+=" "),x+=`${_} ${s(_===1?"minute":"minutes")}`),x||(x=s("no_time")),x}const oe=()=>{const{clients:m,worksites:s,products:u,users:_}=ne();return{getClientById:p=>m.find(f=>f._id===p),getWorksiteById:p=>s.find(f=>f._id===p),getProductById:p=>u.find(f=>f._id===p),getUserById:p=>_.find(f=>f._id===p)}},xe=({report:m})=>{const{t:s}=O(),u=K(),{showFlashMessage:_}=H(),{getClientById:x,getWorksiteById:$,getProductById:E,getUserById:D}=oe();y.useEffect(()=>{new URLSearchParams(u.search).get("action")==="report_created_successfully"&&_(s("report_created_successfully"),"success")},[u,_,s]);const p=c=>c.completed?e.jsx(X,{className:"text-green-500 text-2xl"}):e.jsx(Z,{className:"text-yellow-500 text-2xl"}),f=typeof m.technician_id=="object"&&m.technician_id!==null?m.technician_id.name:"",M=m.activities||[];return e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-800",children:s("report_details")}),e.jsx("p",{className:"text-gray-600",children:m.date?ae(m.date,s):""})]}),e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("dl",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("technician")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:f||s("not_assigned")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("status")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:m.status?s(m.status):s("not_specified")})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:s("short_description")}),e.jsx("dd",{className:"text-sm text-gray-900 sm:col-span-2",children:m.short_description||s("no_description")})]})]})}),e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-4",children:s("activities")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:M.map((c,N)=>{var C;const w=x(c.client_id),l=$(c.worksite_id),A=D(c.assigned_technician_id),B=((C=c.tasks)==null?void 0:C.reduce((h,k)=>h+(k.work_hours||0),0))||0;return e.jsxs("div",{className:"bg-gray-50 p-6 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"text-lg font-bold text-gray-700",children:[s("activity")," ",N+1]}),p(c)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("client")}),e.jsx("a",{href:`/clients/${c.client_id}`,className:"text-blue-600 hover:underline",children:w?w.name:s("unknown_client")})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("worksite")}),e.jsx("a",{href:`/worksites/${c.worksite_id}`,className:"text-blue-600 hover:underline",children:l?l.name:s("unknown_worksite")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(Q,{className:"inline-block text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-600",children:c.activity_description||s("no_description")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(W,{className:"inline-block text-blue-500 mr-2"}),e.jsxs("span",{className:"text-gray-600",children:[s("work_time"),": ",U(B,s)," ",s("hours")]})]}),e.jsx("div",{children:e.jsxs("span",{className:"text-gray-600",children:[s("travel_time"),": ",U(c.travel_time_hours||0,s)," ",s("hours")]})})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("intervention_type")}),c.intervention_type?e.jsxs("div",{className:"flex flex-wrap gap-2",children:[c.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),c.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!c.intervention_type.to_quote&&!c.intervention_type.in_economy&&!c.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]}):e.jsx("p",{className:"text-gray-600",children:s("not_specified")})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700",children:s("assigned_technician")}),e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(G,{className:"inline-block text-blue-500 mr-2"}),e.jsx("p",{children:A?A.name:s("not_assigned")})]})]}),c.tasks&&c.tasks.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-2",children:s("tasks")}),c.tasks.map((h,k)=>e.jsxs("div",{className:"mb-4 p-4 bg-white rounded shadow-sm",children:[e.jsx("p",{className:"font-semibold text-gray-700",children:h.task_description||s("no_description")}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(W,{className:"inline-block text-gray-500 mr-1"}),s("work_hours"),": ",U(h.work_hours||0,s)]}),h.intervention_type&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h6",{className:"text-xs font-semibold text-gray-500",children:s("intervention_type")}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.intervention_type.to_quote&&e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("to_quote")}),h.intervention_type.in_economy&&e.jsx("span",{className:"bg-green-100 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("in_economy")}),h.intervention_type.site_inspection&&e.jsx("span",{className:"bg-yellow-100 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("site_inspection")}),!h.intervention_type.to_quote&&!h.intervention_type.in_economy&&!h.intervention_type.site_inspection&&e.jsx("span",{className:"bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded",children:s("not_specified")})]})]}),h.materials_used&&h.materials_used.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold text-gray-700",children:s("materials_used")}),e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("item_code")}),e.jsx("th",{className:"py-2 text-left text-xs font-semibold text-gray-600",children:s("description")}),e.jsx("th",{className:"py-2 text-right text-xs font-semibold text-gray-600",children:s("Quantity")})]})}),e.jsx("tbody",{children:h.materials_used.map((F,P)=>{const b=E(F.product_id);return e.jsx("tr",{className:"border-t",children:b?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"py-1 text-blue-600 hover:underline font-semibold",children:e.jsx("a",{href:`/products/${b._id}`,children:b.codice_articolo})}),e.jsx("td",{className:"py-1 text-gray-700",children:b.descrizione_articolo}),e.jsx("td",{className:"py-1 text-right text-gray-600",children:F.quantity||0})]}):e.jsx("td",{colSpan:3,className:"py-1 text-red-600",children:s("unknown_product")})},P)})})]})]})]},k))]})]},N)})})]}),e.jsxs("div",{className:"flex items-center p-6",children:[e.jsx(V,{className:"text-blue-500 mr-2"}),e.jsxs("p",{className:"text-gray-600",children:[s("lunch_location"),": ",m.lunch_location||s("not_specified")]})]})]})};export{xe as R,U as f,ne as u};
